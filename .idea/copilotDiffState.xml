<?xml version="1.0" encoding="UTF-8"?>
<project version="4">
  <component name="CopilotDiffPersistence">
    <option name="pendingDiffs">
      <map>
        <entry key="$PROJECT_DIR$/SCROLL_FEATURE_UPDATE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/SCROLL_FEATURE_UPDATE.md" />
              <option name="updatedContent" value="# Cập Nhật Chức Năng Scroll - Scroll Feature Update&#10;&#10;## Ngày cập nhật: 30/10/2025&#10;&#10;### Tổng quan&#10;Đã thêm chức năng scroll (cuộn) cho các trang có danh sách dài để cải thiện trải nghiệm người dùng.&#10;&#10;---&#10;&#10;## Các View Đã Cập Nhật&#10;&#10;### 1. Cart View (Giỏ Hàng) ✅&#10;**File:** `views/cart_view.py`&#10;&#10;**Thay đổi:**&#10;- Thêm Canvas và Scrollbar cho danh sách sản phẩm trong giỏ hàng&#10;- Sản phẩm có thể scroll bằng chuột hoặc mousewheel&#10;- Các nút hành động (Thanh toán, Xóa tất cả) vẫn cố định ở dưới cùng, không bị scroll&#10;&#10;**Chi tiết kỹ thuật:**&#10;```python&#10;# Tạo Canvas cho scrollable content&#10;items_canvas = tk.Canvas(items_scroll_frame, bg='#f8f9fa', highlightthickness=0)&#10;items_scrollbar = tk.Scrollbar(items_scroll_frame, orient='vertical', command=items_canvas.yview)&#10;items_container = tk.Frame(items_canvas, bg='#f8f9fa')&#10;&#10;# Bind mousewheel event&#10;def on_mousewheel(event):&#10;    items_canvas.yview_scroll(int(-1 * (event.delta / 120)), &quot;units&quot;)&#10;items_canvas.bind_all(&quot;&lt;MouseWheel&gt;&quot;, on_mousewheel)&#10;```&#10;&#10;**Lợi ích:**&#10;- Khách hàng có thể xem tất cả sản phẩm trong giỏ hàng dù có nhiều sản phẩm&#10;- Nút thanh toán luôn hiển thị, không bị che khuất&#10;- Trải nghiệm người dùng mượt mà hơn&#10;&#10;---&#10;&#10;### 2. Invoice View (Trang Hóa Đơn) ✅&#10;**File:** `views/invoice_view.py`&#10;&#10;**Thay đổi:**&#10;- Thêm Canvas và Scrollbar cho bảng chi tiết sản phẩm trong hóa đơn&#10;- Danh sách sản phẩm có thể scroll bằng chuột hoặc mousewheel&#10;- Phần tổng tiền và nút thanh toán vẫn cố định ở dưới, không bị scroll&#10;&#10;**Chi tiết kỹ thuật:**&#10;```python&#10;# Tạo Canvas cho scrollable table&#10;table_canvas = tk.Canvas(table_scroll_frame, bg='white', highlightthickness=0)&#10;table_scrollbar = tk.Scrollbar(table_scroll_frame, orient='vertical', command=table_canvas.yview)&#10;table_frame = tk.Frame(table_canvas, bg='white')&#10;&#10;# Bind mousewheel event&#10;def on_invoice_mousewheel(event):&#10;    table_canvas.yview_scroll(int(-1 * (event.delta / 120)), &quot;units&quot;)&#10;table_canvas.bind_all(&quot;&lt;MouseWheel&gt;&quot;, on_invoice_mousewheel)&#10;```&#10;&#10;**Lợi ích:**&#10;- Hóa đơn có thể hiển thị nhiều sản phẩm mà không bị tràn màn hình&#10;- Nút thanh toán luôn sẵn sàng, không cần scroll xuống&#10;- Dễ dàng xem chi tiết từng sản phẩm&#10;&#10;---&#10;&#10;### 3. Invoice History View (Lịch Sử Hóa Đơn) ✅&#10;**File:** `views/invoice_history_view.py`&#10;&#10;**Trạng thái:** Đã có sẵn scroll (sử dụng Treeview với scrollbar)&#10;&#10;**Không cần thay đổi:**&#10;- View này đã sử dụng Treeview widget có sẵn scrollbar&#10;- Hoạt động tốt với danh sách dài&#10;&#10;---&#10;&#10;### 4. Sales View (Thống Kê Doanh Thu) ✅&#10;**File:** `views/sales_view.py`&#10;&#10;**Trạng thái:** Đã có sẵn scroll (sử dụng Treeview với scrollbar)&#10;&#10;**Không cần thay đổi:**&#10;- View này đã sử dụng Treeview widget có sẵn scrollbar&#10;- Có thể hiển thị nhiều sản phẩm trong thống kê&#10;&#10;---&#10;&#10;### 5. Brand Management (Quản Lý Thương Hiệu) ✅&#10;**File:** `views/product_view.py` - Function `show_brand_management()`&#10;&#10;**Trạng thái:** Layout đã hoàn hảo&#10;&#10;**Kiểm tra:**&#10;- Nút &quot;Lưu&quot; (Save) màu xanh lá cây ở góc trái dưới ✅&#10;- Nút &quot;Hủy&quot; (Cancel) màu xám ở góc phải dưới ✅&#10;- Cả 2 nút đều CỐ ĐỊNH, không bị scroll che mất ✅&#10;- Treeview có scrollbar riêng cho danh sách thương hiệu ✅&#10;&#10;**Không cần thay đổi:**&#10;- Layout hoàn toàn ổn định&#10;- Không có vấn đề về nút bị đè&#10;&#10;---&#10;&#10;## Kiểm Tra Chất Lượng&#10;&#10;### Checklist&#10;- [x] Cart View có scroll cho danh sách sản phẩm&#10;- [x] Invoice View có scroll cho bảng chi tiết&#10;- [x] Các nút hành động không bị scroll che mất&#10;- [x] Brand Management nút Save/Cancel không bị đè&#10;- [x] Invoice History View có scroll (đã có sẵn)&#10;- [x] Sales View có scroll (đã có sẵn)&#10;- [x] Mousewheel hoạt động trên các view có scroll&#10;- [x] Layout không bị vỡ khi có nhiều items&#10;&#10;### Test Cases&#10;1. **Cart với nhiều sản phẩm:**&#10;   - Thêm &gt; 10 sản phẩm vào giỏ hàng&#10;   - Kiểm tra scroll hoạt động&#10;   - Kiểm tra nút &quot;Thanh toán&quot; vẫn hiển thị&#10;&#10;2. **Invoice với nhiều sản phẩm:**&#10;   - Tạo hóa đơn với &gt; 10 sản phẩm&#10;   - Kiểm tra scroll hoạt động&#10;   - Kiểm tra nút &quot;Thanh Toán&quot; vẫn hiển thị&#10;&#10;3. **Brand Management:**&#10;   - Mở trang Quản lý thương hiệu&#10;   - Bấm &quot;Thêm thương hiệu&quot;&#10;   - Kiểm tra nút Lưu và Hủy hiển thị đầy đủ&#10;&#10;---&#10;&#10;## Kỹ Thuật Sử Dụng&#10;&#10;### Canvas + Scrollbar Pattern&#10;```python&#10;# 1. Tạo frame container&#10;scroll_frame = tk.Frame(parent)&#10;scroll_frame.pack(fill='both', expand=True)&#10;&#10;# 2. Tạo Canvas và Scrollbar&#10;canvas = tk.Canvas(scroll_frame, bg='white', highlightthickness=0)&#10;scrollbar = tk.Scrollbar(scroll_frame, orient='vertical', command=canvas.yview)&#10;content_frame = tk.Frame(canvas, bg='white')&#10;&#10;# 3. Configure canvas scroll region&#10;content_frame.bind(&#10;    '&lt;Configure&gt;',&#10;    lambda e: canvas.configure(scrollregion=canvas.bbox('all'))&#10;)&#10;&#10;# 4. Create window in canvas&#10;canvas.create_window((0, 0), window=content_frame, anchor='nw')&#10;canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;# 5. Pack canvas and scrollbar&#10;canvas.pack(side='left', fill='both', expand=True)&#10;scrollbar.pack(side='right', fill='y')&#10;&#10;# 6. Add mousewheel support&#10;def on_mousewheel(event):&#10;    canvas.yview_scroll(int(-1 * (event.delta / 120)), &quot;units&quot;)&#10;canvas.bind_all(&quot;&lt;MouseWheel&gt;&quot;, on_mousewheel)&#10;```&#10;&#10;---&#10;&#10;## Lưu Ý Quan Trọng&#10;&#10;### 1. Fixed Buttons (Nút Cố Định)&#10;- Các nút hành động quan trọng (Thanh toán, Lưu, Hủy) phải được đặt NGOÀI scrollable area&#10;- Sử dụng `.pack()` sau khi đã pack xong scroll frame&#10;&#10;### 2. Mousewheel Binding&#10;- Sử dụng `bind_all()` để mousewheel hoạt động trên toàn bộ canvas&#10;- Tính toán delta phù hợp với Windows: `int(-1 * (event.delta / 120))`&#10;&#10;### 3. ScrollRegion Update&#10;- Phải bind `&lt;Configure&gt;` event để update scroll region khi content thay đổi&#10;- Sử dụng `canvas.bbox('all')` để tính toán đúng kích thước&#10;&#10;---&#10;&#10;## Kết Luận&#10;&#10;✅ **Hoàn thành:** Tất cả các view cần thiết đã có chức năng scroll&#10;✅ **Kiểm tra:** Không có nút nào bị đè hoặc che mất&#10;✅ **Ổn định:** Layout hoạt động tốt với mọi số lượng items&#10;✅ **Trải nghiệm:** Người dùng có thể xem và thao tác dễ dàng&#10;&#10;**Không có thêm vấn đề nào cần giải quyết về scroll và layout.**&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/SIZE_FEATURE_GUIDE.md">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/SIZE_FEATURE_GUIDE.md" />
              <option name="updatedContent" value="# Hướng dẫn thêm tính năng Size cho sản phẩm&#10;&#10;## Tổng quan&#10;Đã thêm bảng `size_sp` để lưu trữ các kích cỡ có sẵn cho từng sản phẩm, tương tự như bảng `mausac_sp` cho màu sắc.&#10;&#10;## Các thay đổi đã thực hiện&#10;&#10;### 1. Database Changes&#10;- **Bảng mới**: `size_sp`&#10;  - Cột `MaSP` (varchar(30)): Mã sản phẩm - Foreign Key tham chiếu đến `sanpham.MaSP`&#10;  - Cột `Size` (varchar(20)): Kích cỡ giày&#10;  - Primary Key: (`MaSP`, `Size`)&#10;  - ON DELETE CASCADE: Tự động xóa sizes khi sản phẩm bị xóa&#10;&#10;### 2. Code Changes (product_view.py)&#10;&#10;#### a. Hiển thị sản phẩm (Buyer Side)&#10;- **Dòng ~535-550**: Load sizes từ database thay vì hardcode&#10;- Sizes được sắp xếp theo thứ tự tăng dần&#10;- Nếu không có size trong DB, mặc định hiển thị 36-45&#10;&#10;```python&#10;cursor.execute(&quot;SELECT Size FROM size_sp WHERE MaSP = %s ORDER BY CAST(Size AS UNSIGNED)&quot;, (product_id,))&#10;sizes = [row[0] for row in cursor.fetchall()]&#10;```&#10;&#10;#### b. Thêm sản phẩm mới (Seller Side)&#10;- **Dòng ~1295**: Thêm text field nhập sizes (mỗi size một dòng)&#10;- **Dòng ~1390**: Tạo bảng `size_sp` nếu chưa tồn tại&#10;- **Dòng ~1420**: Insert sizes vào database khi lưu sản phẩm mới&#10;&#10;#### c. Sửa sản phẩm (Seller Side)&#10;- **Dòng ~1525**: Load sizes hiện tại từ database&#10;- **Dòng ~1665**: Hiển thị sizes trong form edit&#10;- **Dòng ~1785**: Xóa sizes cũ và insert sizes mới khi update&#10;&#10;### 3. Workflow&#10;&#10;#### Khi thêm sản phẩm mới:&#10;1. Nhập thông tin sản phẩm&#10;2. Nhập danh sách màu sắc (mỗi màu một dòng)&#10;3. Nhập danh sách kích cỡ (mỗi size một dòng)&#10;4. Click &quot;Lưu&quot;&#10;5. Dữ liệu được lưu vào:&#10;   - Bảng `sanpham`: Thông tin cơ bản&#10;   - Bảng `mausac_sp`: Các màu có sẵn&#10;   - Bảng `size_sp`: Các size có sẵn&#10;   - Bảng `url_sp`: Các ảnh sản phẩm&#10;&#10;#### Khi sửa sản phẩm:&#10;1. Chọn sản phẩm cần sửa&#10;2. Click &quot;Sửa sản phẩm&quot;&#10;3. Form hiển thị thông tin hiện tại (bao gồm sizes)&#10;4. Chỉnh sửa thông tin (có thể thêm/xóa sizes)&#10;5. Click &quot;Cập nhật&quot;&#10;6. Sizes cũ bị xóa và sizes mới được thêm vào&#10;&#10;#### Khi khách hàng chọn sản phẩm:&#10;1. Chọn sản phẩm từ danh sách&#10;2. Dropdown sizes tự động load từ database&#10;3. Chỉ hiển thị các sizes có sẵn cho sản phẩm đó&#10;4. Chọn màu sắc và size&#10;5. Nhập số lượng&#10;6. Click &quot;Thêm vào giỏ hàng&quot;&#10;&#10;## Cách chạy&#10;&#10;### Bước 1: Tạo bảng size_sp trong MySQL&#10;```sql&#10;-- Mở MySQL Workbench&#10;-- Chọn database shopgiaydep22112025&#10;-- Chạy file: create_size_sp_table.sql&#10;```&#10;&#10;### Bước 2: Restart ứng dụng&#10;```bash&#10;python main.py&#10;```&#10;&#10;### Bước 3: Test chức năng&#10;1. **Test thêm sản phẩm mới** (Seller):&#10;   - Đăng nhập bằng tài khoản seller&#10;   - Click &quot;Thêm sản phẩm&quot;&#10;   - Nhập sizes (ví dụ: 36, 37, 38, 39, 40)&#10;   - Lưu và kiểm tra&#10;&#10;2. **Test sửa sản phẩm** (Seller):&#10;   - Chọn sản phẩm&#10;   - Click &quot;Sửa sản phẩm&quot;&#10;   - Xem sizes hiện tại&#10;   - Thêm/xóa sizes&#10;   - Cập nhật và kiểm tra&#10;&#10;3. **Test chọn size** (Buyer):&#10;   - Đăng nhập bằng tài khoản buyer&#10;   - Chọn một sản phẩm&#10;   - Kiểm tra dropdown sizes&#10;   - Thêm vào giỏ hàng với size đã chọn&#10;&#10;## Lưu ý quan trọng&#10;&#10;### 1. Tương thích với dữ liệu cũ&#10;- Nếu một sản phẩm chưa có sizes trong DB, hệ thống tự động hiển thị sizes mặc định (36-45)&#10;- Không ảnh hưởng đến các đơn hàng đã tồn tại&#10;&#10;### 2. Xóa sản phẩm&#10;- Khi xóa sản phẩm, các sizes tương ứng tự động bị xóa (ON DELETE CASCADE)&#10;- Không cần xóa thủ công&#10;&#10;### 3. Giỏ hàng và Đơn hàng&#10;- Bảng `giohangchuasanpham`: Đã có cột `Size`&#10;- Bảng `sptrongdon`: Đã có cột `Size`&#10;- Bảng `cthoadon`: Đã có cột `Size`&#10;- Tất cả đều hoạt động bình thường với sizes từ database&#10;&#10;### 4. Mở rộng trong tương lai&#10;Nếu muốn thêm range size khác (ví dụ: 40-56), chỉ cần:&#10;1. Update dữ liệu trong bảng `size_sp`&#10;2. Hoặc nhập trực tiếp khi thêm/sửa sản phẩm&#10;&#10;## Kiểm tra dữ liệu&#10;&#10;### Xem tất cả sizes của sản phẩm&#10;```sql&#10;SELECT sp.TenSP, sz.Size&#10;FROM sanpham sp&#10;LEFT JOIN size_sp sz ON sp.MaSP = sz.MaSP&#10;ORDER BY sp.MaSP, CAST(sz.Size AS UNSIGNED);&#10;```&#10;&#10;### Kiểm tra sản phẩm không có size&#10;```sql&#10;SELECT sp.MaSP, sp.TenSP&#10;FROM sanpham sp&#10;LEFT JOIN size_sp sz ON sp.MaSP = sz.MaSP&#10;WHERE sz.Size IS NULL;&#10;```&#10;&#10;### Thống kê số lượng sizes mỗi sản phẩm&#10;```sql&#10;SELECT sp.MaSP, sp.TenSP, COUNT(sz.Size) as SoLuongSize&#10;FROM sanpham sp&#10;LEFT JOIN size_sp sz ON sp.MaSP = sz.MaSP&#10;GROUP BY sp.MaSP, sp.TenSP&#10;ORDER BY sp.MaSP;&#10;```&#10;&#10;## Troubleshooting&#10;&#10;### Lỗi: &quot;Foreign key constraint fails&quot;&#10;- Đảm bảo bảng `sanpham` đã tồn tại trước&#10;- Đảm bảo `MaSP` trong `size_sp` phải tồn tại trong `sanpham`&#10;&#10;### Sizes không hiển thị&#10;- Kiểm tra kết nối database&#10;- Kiểm tra dữ liệu trong bảng `size_sp`&#10;- Xem log lỗi trong console&#10;&#10;### Không thể thêm size trùng&#10;- Đây là behavior đúng (PRIMARY KEY)&#10;- Mỗi sản phẩm chỉ có 1 size duy nhất&#10;- Nếu muốn thêm lại, phải xóa size cũ trước&#10;&#10;## Kết luận&#10;Tính năng size đã được tích hợp hoàn chỉnh vào hệ thống, hoạt động tương tự như tính năng màu sắc. Dữ liệu được lưu trữ trong database và đồng bộ giữa seller và buyer.&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/create_size_sp_table.sql">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/create_size_sp_table.sql" />
              <option name="updatedContent" value="-- =====================================================&#10;-- Script: Tạo bảng size_sp để lưu trữ kích cỡ sản phẩm&#10;-- Database: shopgiaydep22112025&#10;-- Date: 2025-11-23&#10;-- =====================================================&#10;&#10;USE shopgiaydep22112025;&#10;&#10;-- Xóa bảng nếu đã tồn tại&#10;DROP TABLE IF EXISTS `size_sp`;&#10;&#10;-- Tạo bảng size_sp&#10;CREATE TABLE `size_sp` (&#10;  `MaSP` varchar(30) NOT NULL COMMENT 'Mã sản phẩm - tham chiếu đến bảng sanpham',&#10;  `Size` varchar(20) NOT NULL COMMENT 'Kích cỡ giày',&#10;  PRIMARY KEY (`MaSP`,`Size`),&#10;  CONSTRAINT `size_sp_ibfk_1` FOREIGN KEY (`MaSP`) REFERENCES `sanpham` (`MaSP`) ON DELETE CASCADE&#10;) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='Bảng lưu trữ các kích cỡ có sẵn của từng sản phẩm';&#10;&#10;-- Insert dữ liệu mẫu cho các sản phẩm hiện có (size từ 36-45)&#10;-- SP001: Nike Metcon 9 By You&#10;INSERT INTO `size_sp` VALUES &#10;('SP001','36'),('SP001','37'),('SP001','38'),('SP001','39'),('SP001','40'),&#10;('SP001','41'),('SP001','42'),('SP001','43'),('SP001','44'),('SP001','45');&#10;&#10;-- SP002: Giày Streettalk&#10;INSERT INTO `size_sp` VALUES &#10;('SP002','36'),('SP002','37'),('SP002','38'),('SP002','39'),('SP002','40'),&#10;('SP002','41'),('SP002','42'),('SP002','43'),('SP002','44'),('SP002','45');&#10;&#10;-- SP003: Giày Handball Special&#10;INSERT INTO `size_sp` VALUES &#10;('SP003','36'),('SP003','37'),('SP003','38'),('SP003','39'),('SP003','40'),&#10;('SP003','41'),('SP003','42'),('SP003','43'),('SP003','44'),('SP003','45');&#10;&#10;-- SP004: giày đè tem&#10;INSERT INTO `size_sp` VALUES &#10;('SP004','36'),('SP004','37'),('SP004','38'),('SP004','39'),('SP004','40'),&#10;('SP004','41'),('SP004','42'),('SP004','43'),('SP004','44'),('SP004','45');&#10;&#10;-- Kiểm tra kết quả&#10;SELECT * FROM size_sp ORDER BY MaSP, CAST(Size AS UNSIGNED);&#10;&#10;-- Hiển thị thông tin bảng&#10;DESCRIBE size_sp;&#10;&#10;-- Thông báo hoàn thành&#10;SELECT 'Tạo bảng size_sp thành công!' AS Status;&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
        <entry key="$PROJECT_DIR$/views/product_view.py">
          <value>
            <PendingDiffInfo>
              <option name="filePath" value="$PROJECT_DIR$/views/product_view.py" />
              <option name="originalContent" value="&quot;&quot;&quot;&#10;Product View - matches main.py structure exactly&#10;&quot;&quot;&quot;&#10;import tkinter as tk&#10;from tkinter import messagebox, ttk, filedialog&#10;from PIL import Image, ImageTk&#10;import urllib.request&#10;import io&#10;import os&#10;from config.database import get_db_connection, BASE_DIR, LOCAL_IMAGE_DIR&#10;from utils.image_utils import load_image_safely, load_thumbnail_image, save_uploaded_image, insert_uploaded_image_to_db&#10;from utils.ui_effects import add_button_hover_effect, COLORS, get_hover_color&#10;&#10;class ProductView:&#10;    def __init__(self, root):&#10;        self.root = root&#10;        self.brand_combo = None  # Store reference to brand combo for refreshing&#10;&#10;    def get_cart_count_from_db(self, username):&#10;        &quot;&quot;&quot;Get cart count from database - giohangchuasanpham&quot;&quot;&quot;&#10;        if not username:&#10;            return 0&#10;&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;&#10;            cursor.execute(&quot;SELECT MaKH FROM khachhang WHERE TenDN = %s&quot;, (username,))&#10;            result = cursor.fetchone()&#10;            if not result:&#10;                return 0&#10;&#10;            ma_kh = result[0]&#10;&#10;            cursor.execute(&quot;SELECT SUM(SoLuong) FROM giohangchuasanpham WHERE MaKH = %s&quot;, (ma_kh,))&#10;            count_result = cursor.fetchone()&#10;            return count_result[0] if count_result and count_result[0] else 0&#10;        except Exception as e:&#10;            print(f&quot;❌ Error getting cart count: {e}&quot;)&#10;            return 0&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;    def refresh_brand_filter(self):&#10;        &quot;&quot;&quot;Refresh the brand filter dropdown with updated data - moved to class level&quot;&quot;&quot;&#10;        if not self.brand_combo:&#10;            return&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;            cursor.execute(&quot;SELECT DISTINCT TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands = [&quot;Tất cả&quot;] + [row[0] for row in cursor.fetchall()]&#10;            self.brand_combo['values'] = brands&#10;            print(f&quot;Debug: Brand filter updated with {len(brands)-1} brands&quot;)&#10;        except Exception as e:&#10;            print(f&quot;Error refreshing brand filter: {e}&quot;)&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;    def show_sales_view(self, role, username):&#10;        &quot;&quot;&quot;Show sales statistics view&quot;&quot;&quot;&#10;        from views.sales_view import SalesView&#10;        sales_view = SalesView(self.root)&#10;        sales_view.show(role, username, lambda: self.show_shoes(role, username))&#10;&#10;    def show_shoes(self, role=None, username=None):&#10;        &quot;&quot;&quot;Show product list - from main.py&quot;&quot;&quot;&#10;        for widget in self.root.winfo_children():&#10;            widget.destroy()&#10;&#10;        self.root.title(&quot;Shop Shoes - Danh sách sản phẩm&quot;)&#10;        self.root.geometry(&quot;1200x750&quot;)&#10;&#10;        header_frame = tk.Frame(self.root, bg='#2c3e50', height=60)&#10;        header_frame.pack(fill='x')&#10;        header_frame.pack_propagate(False)&#10;&#10;        header_container = tk.Frame(header_frame, bg='#2c3e50')&#10;        header_container.pack(fill='both', expand=True, padx=10)&#10;&#10;        tk.Label(header_container, text=&quot;SHOP GIÀY&quot;, font=('Arial', 20, 'bold'),&#10;                 fg='white', bg='#2c3e50').pack(side='left', pady=15)&#10;&#10;        # Role-specific buttons&#10;        if role == &quot;buyer&quot;:&#10;            # Cart button for buyers&#10;            def update_cart_button():&#10;                &quot;&quot;&quot;Calculate cart count from database giohangchuasanpham&quot;&quot;&quot;&#10;                cart_count = self.get_cart_count_from_db(username)&#10;                return f&quot; Giỏ hàng ({cart_count})&quot;&#10;&#10;&#10;            btn_cart = tk.Button(header_container, text=update_cart_button(),&#10;                                command=lambda: self.show_cart_callback(username, role) if hasattr(self, 'show_cart_callback') else None,&#10;                                bg='#f39c12', fg='white', relief='flat',&#10;                                font=('Arial', 12, 'bold'), padx=15, pady=5, cursor='hand2', bd=2)&#10;            btn_cart.pack(side='right', pady=15, padx=(0, 10))&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_cart, '#f39c12', get_hover_color('#f39c12'))&#10;&#10;            # Invoice history button for buyers&#10;            btn_history = tk.Button(header_container, text=&quot; Lịch sử&quot;,&#10;                                   command=lambda: self.show_invoice_history(role, username) if hasattr(self, 'show_invoice_history') else None,&#10;                                   bg='#9b59b6', fg='white', relief='flat',&#10;                                   font=('Arial', 12, 'bold'), padx=15, pady=5, cursor='hand2', bd=2)&#10;            btn_history.pack(side='right', pady=15, padx=(0, 10))&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_history, '#9b59b6', get_hover_color('#9b59b6'))&#10;        else:&#10;            # No product management button in header for sellers anymore&#10;            pass&#10;&#10;        btn_logout = tk.Button(header_container, text=&quot;Đăng xuất&quot;,&#10;                              command=lambda: self.logout_callback() if hasattr(self, 'logout_callback') else None,&#10;                              bg='#e74c3c', fg='white', relief='flat',&#10;                              font=('Arial', 15), padx=15, pady=5, cursor='hand2', bd=2)&#10;        btn_logout.pack(side='right', pady=15)&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_logout, '#e74c3c', get_hover_color('#e74c3c'))&#10;&#10;        if username:&#10;            role_label = &quot;Người bán&quot; if role == &quot;seller&quot; else &quot;Khách hàng&quot;&#10;            tk.Label(header_container, text=f&quot;{role_label}: {username}&quot;,&#10;                     font=('Arial', 14), fg='white', bg='#2c3e50').pack(side='right', pady=15, padx=(0, 15))&#10;&#10;        # Search and Filter Frame&#10;        search_frame = tk.Frame(self.root, bg='#ecf0f1', height=80)&#10;        search_frame.pack(fill='x', padx=10, pady=(5, 0))&#10;        search_frame.pack_propagate(False)&#10;&#10;        # Search bar&#10;        search_container = tk.Frame(search_frame, bg='#ecf0f1')&#10;        search_container.pack(side='left', fill='y', pady=10)&#10;&#10;        tk.Label(search_container, text=&quot;Tìm kiếm:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#ecf0f1').pack(side='left', padx=(10, 5))&#10;&#10;        search_var = tk.StringVar()&#10;        search_entry = tk.Entry(search_container, textvariable=search_var, font=('Arial', 12), width=25)&#10;        search_entry.pack(side='left', padx=5)&#10;&#10;        btn_search = tk.Button(search_container, text=&quot;&quot;,&#10;                              bg='#3498db', fg='white', font=('Arial', 12, 'bold'),&#10;                              padx=10, cursor='hand2', relief='raised', bd=2)&#10;        btn_search.pack(side='left', padx=5)&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_search, '#3498db', get_hover_color('#3498db'))&#10;&#10;        # Sales statistics button for sellers&#10;        if role == &quot;seller&quot;:&#10;            btn_sales = tk.Button(search_container, text=&quot; Doanh thu&quot;,&#10;                                 bg='#9b59b6', fg='white', font=('Arial', 12, 'bold'),&#10;                                 padx=15, pady=5, relief='raised', cursor='hand2', bd=2,&#10;                                 command=lambda: self.show_sales_view(role, username))&#10;            btn_sales.pack(side='left', padx=10)&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_sales, '#9b59b6', get_hover_color('#9b59b6'))&#10;&#10;        # Filter frame&#10;        filter_container = tk.Frame(search_frame, bg='#ecf0f1')&#10;        filter_container.pack(side='right', fill='y', pady=10, padx=(0, 10))&#10;&#10;        # Brand filter&#10;        tk.Label(filter_container, text=&quot;Thương hiệu:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#ecf0f1').pack(side='left', padx=(10, 5))&#10;&#10;        brand_var = tk.StringVar(value=&quot;Tất cả&quot;)&#10;        brand_combo = ttk.Combobox(filter_container, textvariable=brand_var, width=12, state='readonly',&#10;                                  font=('Arial', 11))&#10;        brand_combo.pack(side='left', padx=5)&#10;&#10;        # Store reference to brand combo for refreshing&#10;        self.brand_combo = brand_combo&#10;&#10;        # Price filter&#10;        tk.Label(filter_container, text=&quot;Giá:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#ecf0f1').pack(side='left', padx=(10, 5))&#10;&#10;        price_var = tk.StringVar(value=&quot;Tất cả&quot;)&#10;        price_combo = ttk.Combobox(filter_container, textvariable=price_var, width=12, state='readonly',&#10;                                  font=('Arial', 11), values=[&quot;Tất cả&quot;, &quot;Dưới 500k&quot;, &quot;500k - 1tr&quot;, &quot;1tr - 2tr&quot;, &quot;Trên 2tr&quot;])&#10;        price_combo.pack(side='left', padx=5)&#10;&#10;        btn_filter = tk.Button(filter_container, text=&quot;Lọc&quot;,&#10;                              bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                              padx=10, cursor='hand2', relief='raised', bd=2)&#10;        btn_filter.pack(side='left', padx=5)&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_filter, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;        # Load product data and images&#10;        all_products = []&#10;        product_images = {}&#10;        conn = None&#10;        cursor = None&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;&#10;            # Get product info with brand, import date and discount for price calculation&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT sp.MaSP, sp.TenSP, sp.Gia, sp.MoTa, th.TenTH, sp.SoLuong, sp.NgayNhapHang, sp.GiamGia&#10;                FROM sanpham sp&#10;                LEFT JOIN thuonghieu th ON sp.MaTH = th.MaTH&#10;                ORDER BY sp.MaSP&#10;            &quot;&quot;&quot;)&#10;            all_products = cursor.fetchall()&#10;&#10;            # AUTO-UPDATE GiamGia based on NgayNhapHang (stock age)&#10;            from datetime import datetime&#10;            current_date = datetime.now()&#10;&#10;            for ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia_current in all_products:&#10;                if ngay_nhap_hang and so_luong &gt; 0:  # Only for products with stock &gt; 0 (IN STOCK)&#10;                    try:&#10;                        # Calculate months difference&#10;                        import_date = ngay_nhap_hang if isinstance(ngay_nhap_hang, datetime) else datetime.strptime(str(ngay_nhap_hang), '%Y-%m-%d')&#10;                        months_old = (current_date.year - import_date.year) * 12 + (current_date.month - import_date.month)&#10;&#10;                        # Determine discount based on age&#10;                        new_discount = 0&#10;                        if months_old &gt;= 12:&#10;                            new_discount = 15  # 15% for 12+ months&#10;                        elif months_old &gt;= 6:&#10;                            new_discount = 10  # 10% for 6+ months&#10;&#10;                        # Update database if discount changed&#10;                        if new_discount != giam_gia_current:&#10;                            cursor.execute(&quot;&quot;&quot;&#10;                                UPDATE sanpham SET GiamGia = %s WHERE MaSP = %s&#10;                            &quot;&quot;&quot;, (new_discount, ma_sp))&#10;                            print(f&quot;Auto-updated discount for {ma_sp}: {giam_gia_current}% -&gt; {new_discount}% (age: {months_old} months)&quot;)&#10;                    except Exception as e:&#10;                        print(f&quot;Error auto-updating discount for {ma_sp}: {e}&quot;)&#10;                        pass&#10;&#10;            # Commit discount updates&#10;            conn.commit()&#10;&#10;            # Re-fetch products with updated discounts&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT sp.MaSP, sp.TenSP, sp.Gia, sp.MoTa, th.TenTH, sp.SoLuong, sp.NgayNhapHang, sp.GiamGia&#10;                FROM sanpham sp&#10;                LEFT JOIN thuonghieu th ON sp.MaTH = th.MaTH&#10;                ORDER BY sp.MaSP&#10;            &quot;&quot;&quot;)&#10;            all_products = cursor.fetchall()&#10;&#10;            # Get brand list for combobox&#10;            cursor.execute(&quot;SELECT DISTINCT TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands = [&quot;Tất cả&quot;] + [row[0] for row in cursor.fetchall()]&#10;            brand_combo['values'] = brands&#10;&#10;            # Get all images for each product&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT MaSP, URLAnh&#10;                FROM url_sp&#10;                ORDER BY MaSP&#10;            &quot;&quot;&quot;)&#10;            image_rows = cursor.fetchall()&#10;&#10;            # Organize images by product&#10;            for ma_sp, url_anh in image_rows:&#10;                if ma_sp not in product_images:&#10;                    product_images[ma_sp] = []&#10;                product_images[ma_sp].append(url_anh)&#10;&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải dữ liệu: {str(e)}&quot;)&#10;            return&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        main_frame = tk.Frame(self.root)&#10;        main_frame.pack(fill='both', expand=True, padx=10, pady=5)&#10;&#10;        # Left panel: Product list&#10;        list_frame = tk.Frame(main_frame, width=400)&#10;        list_frame.pack(side='left', fill='y', padx=(0, 10))&#10;        list_frame.pack_propagate(False)&#10;&#10;        tk.Label(list_frame, text=&quot;Danh sách giày&quot;, font=('Arial', 18, 'bold')).pack(anchor='w', pady=(0, 10))&#10;&#10;        tree_frame = tk.Frame(list_frame)&#10;        tree_frame.pack(fill='both', expand=True)&#10;&#10;        # Configure style for larger fonts in Treeview&#10;        style = ttk.Style()&#10;        style.configure(&quot;Custom.Treeview&quot;, font=('Arial', 11))&#10;        style.configure(&quot;Custom.Treeview.Heading&quot;, font=('Arial', 12, 'bold'))&#10;&#10;        # Add quantity column for sellers&#10;        if role == &quot;seller&quot;:&#10;            tree = ttk.Treeview(tree_frame, columns=(&quot;Mã SP&quot;, &quot;Tên&quot;, &quot;Giá&quot;, &quot;SL&quot;), show=&quot;headings&quot;, height=8, style=&quot;Custom.Treeview&quot;)&#10;            tree.heading(&quot;Mã SP&quot;, text=&quot;Mã SP&quot;)&#10;            tree.heading(&quot;Tên&quot;, text=&quot;Tên giày&quot;)&#10;            tree.heading(&quot;Giá&quot;, text=&quot;Giá&quot;)&#10;            tree.heading(&quot;SL&quot;, text=&quot;SL&quot;)&#10;            tree.column(&quot;Mã SP&quot;, width=80)&#10;            tree.column(&quot;Tên&quot;, width=140)&#10;            tree.column(&quot;Giá&quot;, width=120, anchor='e')&#10;            tree.column(&quot;SL&quot;, width=50, anchor='e')&#10;        else:&#10;            # Enable multiple selection for buyers&#10;            tree = ttk.Treeview(tree_frame, columns=(&quot;Mã SP&quot;, &quot;Tên&quot;, &quot;Giá&quot;), show=&quot;headings&quot;, height=8,&#10;                               style=&quot;Custom.Treeview&quot;, selectmode='extended')&#10;            tree.heading(&quot;Mã SP&quot;, text=&quot;Mã SP&quot;)&#10;            tree.heading(&quot;Tên&quot;, text=&quot;Tên giày&quot;)&#10;            tree.heading(&quot;Giá&quot;, text=&quot;Giá&quot;)&#10;            tree.column(&quot;Mã SP&quot;, width=80)&#10;            tree.column(&quot;Tên&quot;, width=160)&#10;            tree.column(&quot;Giá&quot;, width=130, anchor='e')&#10;&#10;        scrollbar = ttk.Scrollbar(tree_frame, orient=&quot;vertical&quot;, command=tree.yview)&#10;        tree.configure(yscrollcommand=scrollbar.set)&#10;&#10;        tree.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)&#10;        scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;)&#10;&#10;        # Action button frame&#10;        action_button_frame = tk.Frame(list_frame)&#10;        action_button_frame.pack(fill='x', pady=(5, 0))&#10;&#10;        if role == &quot;buyer&quot;:&#10;            # Add to cart button for buyers&#10;            btn_add_to_cart = tk.Button(action_button_frame, text=&quot;➕ Thêm vào giỏ hàng&quot;,&#10;                                       bg='#95a5a6', fg='white', font=('Arial', 12, 'bold'),&#10;                                       padx=10, pady=8, relief='raised', state='disabled',&#10;                                       cursor='hand2', bd=2)&#10;            btn_add_to_cart.pack(anchor='w', pady=5)&#10;&#10;&#10;            status_label = tk.Label(action_button_frame, text=&quot;Chọn sản phẩm để kích hoạt nút&quot;,&#10;                                   font=('Arial', 10), fg='#7f8c8d')&#10;            status_label.pack(anchor='w', pady=(10, 0))&#10;        else:&#10;            # Product management buttons frame for sellers - FIXED BUTTON ALIGNMENT&#10;            # First row: Delete and Add buttons (centered and same size)&#10;            buttons_row1_frame = tk.Frame(action_button_frame)&#10;            buttons_row1_frame.pack(fill='x', pady=(5, 2))&#10;&#10;            # Create a container for centering the buttons&#10;            center_container1 = tk.Frame(buttons_row1_frame)&#10;            center_container1.pack(anchor='center')&#10;&#10;            # STANDARDIZED BUTTON PARAMETERS - All buttons exactly the same&#10;            BUTTON_FONT = ('Arial', 11, 'bold')&#10;            BUTTON_PADX = 10&#10;            BUTTON_PADY = 8&#10;            BUTTON_WIDTH = 16  # Fixed width for all buttons&#10;            BUTTON_SPACING = 10  # Consistent spacing between buttons&#10;&#10;            # Delete product button (left in center container)&#10;            btn_delete_product = tk.Button(center_container1, text=&quot;️ Xóa sản phẩm&quot;,&#10;                                          bg='#e74c3c', fg='white', font=BUTTON_FONT,&#10;                                          padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised', state='disabled',&#10;                                          cursor='hand2', bd=2, width=BUTTON_WIDTH)&#10;            btn_delete_product.pack(side='left', padx=(0, BUTTON_SPACING))&#10;&#10;            # Add product button (right in center container)&#10;            btn_add_product = tk.Button(center_container1, text=&quot;➕ Thêm sản phẩm&quot;,&#10;                                       bg='#27ae60', fg='white', font=BUTTON_FONT,&#10;                                       padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised',&#10;                                       cursor='hand2', bd=2, width=BUTTON_WIDTH,&#10;                                       command=lambda: self.show_add_product_form(role, username))&#10;            btn_add_product.pack(side='right')&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_add_product, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;            # Second row: Edit and Brand buttons (centered and same size)&#10;            buttons_row2_frame = tk.Frame(action_button_frame)&#10;            buttons_row2_frame.pack(fill='x', pady=(2, 5))&#10;&#10;            # Create a container for centering the buttons&#10;            center_container2 = tk.Frame(buttons_row2_frame)&#10;            center_container2.pack(anchor='center')&#10;&#10;            # Edit product button (left in center container)&#10;            btn_edit_product = tk.Button(center_container2, text=&quot;✏️ Sửa sản phẩm&quot;,&#10;                                        bg='#f39c12', fg='white', font=BUTTON_FONT,&#10;                                        padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised', state='disabled',&#10;                                        cursor='hand2', bd=2, width=BUTTON_WIDTH)&#10;            btn_edit_product.pack(side='left', padx=(0, BUTTON_SPACING))&#10;&#10;            # Brand management button (right in center container)&#10;            btn_brand_management = tk.Button(center_container2, text=&quot;️ Thương hiệu&quot;,&#10;                                           bg='#9b59b6', fg='white', font=BUTTON_FONT,&#10;                                           padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised',&#10;                                           cursor='hand2', bd=2, width=BUTTON_WIDTH,&#10;                                           command=lambda: self.show_brand_management(role, username))&#10;            btn_brand_management.pack(side='right')&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_brand_management, '#9b59b6', get_hover_color('#9b59b6'))&#10;&#10;            status_label = tk.Label(action_button_frame, text=&quot;Chọn sản phẩm để xóa hoặc sửa&quot;,&#10;                                   font=('Arial', 10), fg='#7f8c8d')&#10;            status_label.pack(anchor='w')&#10;&#10;        # Functions&#10;        def refresh_brand_filter():&#10;            &quot;&quot;&quot;Refresh the brand filter dropdown with updated data&quot;&quot;&quot;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;                cursor.execute(&quot;SELECT DISTINCT TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;                brands = [&quot;Tất cả&quot;] + [row[0] for row in cursor.fetchall()]&#10;                brand_combo['values'] = brands&#10;                print(f&quot;Debug: Brand filter updated with {len(brands)-1} brands&quot;)&#10;            except Exception as e:&#10;                print(f&quot;Error refreshing brand filter: {e}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        def show_multi_product_cart_dialog(selected_products):&#10;            &quot;&quot;&quot;Show dialog for adding multiple products to cart with color, size, and quantity options&quot;&quot;&quot;&#10;            if not selected_products:&#10;                return&#10;&#10;            # Create scrollable dialog with larger size&#10;            dialog = tk.Toplevel(self.root)&#10;            dialog.title(f&quot;Thêm {len(selected_products)} sản phẩm vào giỏ hàng&quot;)&#10;            dialog.geometry(&quot;800x650&quot;)  # Increased width from 650 to 800&#10;            dialog.resizable(False, False)&#10;            dialog.grab_set()&#10;            dialog.transient(self.root)&#10;&#10;            # Center dialog on screen&#10;            dialog.update_idletasks()&#10;            x = (dialog.winfo_screenwidth() // 2) - (800 // 2)&#10;            y = (dialog.winfo_screenheight() // 2) - (650 // 2)&#10;            dialog.geometry(f&quot;+{x}+{y}&quot;)&#10;&#10;            # Header&#10;            header = tk.Frame(dialog, bg='#3498db', height=60)&#10;            header.pack(fill='x')&#10;            header.pack_propagate(False)&#10;&#10;            tk.Label(header, text=f&quot; Cấu hình {len(selected_products)} sản phẩm&quot;,&#10;                    font=('Arial', 16, 'bold'), bg='#3498db', fg='white').pack(pady=15)&#10;&#10;            # Main content frame (to contain scrollable area)&#10;            content_frame = tk.Frame(dialog, bg='#f0f0f0')&#10;            content_frame.pack(fill='both', expand=True)&#10;&#10;            # Create scrollable frame for products - CENTERED&#10;            scroll_container = tk.Frame(content_frame, bg='#f0f0f0')&#10;            scroll_container.pack(fill='both', expand=True, padx=20, pady=10)&#10;&#10;            canvas = tk.Canvas(scroll_container, bg='white', highlightthickness=0)&#10;            scrollbar = tk.Scrollbar(scroll_container, orient=&quot;vertical&quot;, command=canvas.yview)&#10;            scrollable_frame = tk.Frame(canvas, bg='white')&#10;&#10;            scrollable_frame.bind(&#10;                &quot;&lt;Configure&gt;&quot;,&#10;                lambda e: canvas.configure(scrollregion=canvas.bbox(&quot;all&quot;))&#10;            )&#10;&#10;            # Center the content in canvas&#10;            canvas_frame = canvas.create_window((0, 0), window=scrollable_frame, anchor=&quot;n&quot;)&#10;&#10;            # Update canvas width to center content&#10;            def update_canvas_width(event):&#10;                canvas_width = event.width&#10;                canvas.itemconfig(canvas_frame, width=canvas_width)&#10;&#10;            canvas.bind('&lt;Configure&gt;', update_canvas_width)&#10;            canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;            # Pack canvas and scrollbar&#10;            canvas.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)&#10;            scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;)&#10;&#10;            # Enable mousewheel scrolling&#10;            def _on_mousewheel(event):&#10;                canvas.yview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;            dialog.bind_all(&quot;&lt;MouseWheel&gt;&quot;, _on_mousewheel)&#10;&#10;            # Store product configurations&#10;            product_configs = {}&#10;&#10;            # Create configuration for each product - CENTERED with better width&#10;            for idx, product_id in enumerate(selected_products):&#10;                if product_id not in product_data:&#10;                    continue&#10;&#10;                product = product_data[product_id]&#10;&#10;                # Product frame - wider and centered&#10;                product_frame = tk.Frame(scrollable_frame, bg='white', relief='solid', bd=2, width=700)&#10;                product_frame.pack(padx=30, pady=10, fill='x')&#10;&#10;                # Product header&#10;                header_frame = tk.Frame(product_frame, bg='#ecf0f1')&#10;                header_frame.pack(fill='x')&#10;&#10;                tk.Label(header_frame, text=f&quot;{idx + 1}. {product['name']}&quot;,&#10;                        font=('Arial', 13, 'bold'), bg='#ecf0f1', fg='#2c3e50').pack(anchor='w', padx=10, pady=8)&#10;&#10;                # Price info&#10;                price_text = product['price']&#10;                if product.get('discount', 0) &gt; 0:&#10;                    discounted_price = product['original_price'] * (1 - product['discount'] / 100)&#10;                    price_text = f&quot;{discounted_price:,.0f} VNĐ (-{product['discount']}%)&quot;&#10;&#10;                tk.Label(header_frame, text=price_text,&#10;                        font=('Arial', 11), bg='#ecf0f1', fg='#27ae60').pack(anchor='w', padx=10, pady=(0, 8))&#10;&#10;                # Configuration frame&#10;                config_frame = tk.Frame(product_frame, bg='white')&#10;                config_frame.pack(fill='x', padx=15, pady=15)&#10;&#10;                # Color selection&#10;                color_label_frame = tk.Frame(config_frame, bg='white')&#10;                color_label_frame.pack(fill='x', pady=(0, 8))&#10;&#10;                tk.Label(color_label_frame, text=&quot;Màu sắc:&quot;, font=('Arial', 11, 'bold'),&#10;                        bg='white').pack(side='left')&#10;&#10;                # Get colors from database&#10;                try:&#10;                    conn = get_db_connection()&#10;                    cursor = conn.cursor()&#10;                    cursor.execute(&quot;SELECT MauSac FROM mausac_sp WHERE MaSP = %s&quot;, (product_id,))&#10;                    colors = [row[0] for row in cursor.fetchall()]&#10;                    if not colors:&#10;                        colors = [&quot;Trắng&quot;, &quot;Xanh Dương&quot;, &quot;Đen&quot;, &quot;Nâu&quot;]&#10;                except:&#10;                    colors = [&quot;Trắng&quot;, &quot;Xanh Dương&quot;, &quot;Đen&quot;, &quot;Nâu&quot;]&#10;                finally:&#10;                    if 'cursor' in locals() and cursor:&#10;                        cursor.close()&#10;                    if 'conn' in locals() and conn:&#10;                        conn.close()&#10;&#10;                color_var = tk.StringVar(value=colors[0])&#10;                color_combo = ttk.Combobox(config_frame, textvariable=color_var, width=25,&#10;                                          state='readonly', font=('Arial', 11), values=colors)&#10;                color_combo.pack(fill='x', pady=(0, 8))&#10;&#10;                # Size selection&#10;                size_label_frame = tk.Frame(config_frame, bg='white')&#10;                size_label_frame.pack(fill='x', pady=(0, 8))&#10;&#10;                tk.Label(size_label_frame, text=&quot;Kích cỡ:&quot;, font=('Arial', 11, 'bold'),&#10;                        bg='white').pack(side='left')&#10;&#10;                size_var = tk.StringVar(value=&quot;42&quot;)&#10;                size_combo = ttk.Combobox(config_frame, textvariable=size_var, width=25,&#10;                                         state='readonly', font=('Arial', 11),&#10;                                         values=[str(i) for i in range(36, 46)])&#10;                size_combo.pack(fill='x', pady=(0, 8))&#10;&#10;                # Quantity selection&#10;                qty_label_frame = tk.Frame(config_frame, bg='white')&#10;                qty_label_frame.pack(fill='x', pady=(0, 8))&#10;&#10;                tk.Label(qty_label_frame, text=f&quot;Số lượng (Còn: {product['quantity']}):&quot;,&#10;                        font=('Arial', 11, 'bold'), bg='white').pack(side='left')&#10;&#10;                qty_var = tk.IntVar(value=1)&#10;                qty_spin = tk.Spinbox(config_frame, from_=1, to=product['quantity'],&#10;                                     textvariable=qty_var, width=23, font=('Arial', 11),&#10;                                     justify='center')&#10;                qty_spin.pack(fill='x')&#10;&#10;                # Store configuration&#10;                product_configs[product_id] = {&#10;                    'name': product['name'],&#10;                    'color_var': color_var,&#10;                    'size_var': size_var,&#10;                    'qty_var': qty_var,&#10;                    'max_qty': product['quantity']&#10;                }&#10;&#10;            # Button frame (FIXED at bottom like seller's add product)&#10;            button_frame = tk.Frame(dialog, bg='white', relief='ridge', bd=1, height=70)&#10;            button_frame.pack(side='bottom', fill='x')&#10;            button_frame.pack_propagate(False)&#10;&#10;            def add_all_to_cart():&#10;                &quot;&quot;&quot;Add all configured products to cart&quot;&quot;&quot;&#10;                added_count = 0&#10;                errors = []&#10;&#10;                for product_id, config in product_configs.items():&#10;                    try:&#10;                        color = config['color_var'].get()&#10;                        size = config['size_var'].get()&#10;                        qty = config['qty_var'].get()&#10;&#10;                        if qty &lt;= 0 or qty &gt; config['max_qty']:&#10;                            errors.append(f&quot;{config['name']}: Số lượng không hợp lệ&quot;)&#10;                            continue&#10;&#10;                        # Add to cart using existing function&#10;                        add_to_cart_with_quantity(product_id, config['name'], color, size, qty)&#10;                        added_count += 1&#10;&#10;                    except Exception as e:&#10;                        errors.append(f&quot;{config['name']}: {str(e)}&quot;)&#10;&#10;                # Unbind mousewheel before closing&#10;                dialog.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;                dialog.destroy()&#10;&#10;                # Show result&#10;                if added_count &gt; 0:&#10;                    btn_cart.config(text=update_cart_button())&#10;&#10;                # if errors:&#10;                #     messagebox.showwarning(&quot;Cảnh báo&quot;,&#10;                #         f&quot;Đã thêm {added_count}/{len(product_configs)} sản phẩm.\n\nLỗi:\n&quot; + &quot;\n&quot;.join(errors[:3]))&#10;                # else:&#10;                #     messagebox.showinfo(&quot;Thành công&quot;,&#10;                #         f&quot;Đã thêm {added_count} sản phẩm vào giỏ hàng!&quot;)&#10;&#10;            def cancel_dialog():&#10;                dialog.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;                dialog.destroy()&#10;&#10;            # Add buttons - FIXED AT BOTTOM LEFT AND RIGHT&#10;            btn_add_all = tk.Button(button_frame, text=&quot;✅ Thêm tất cả vào giỏ&quot;, command=add_all_to_cart,&#10;                                   bg='#27ae60', fg='white', font=('Arial', 13, 'bold'),&#10;                                   padx=30, pady=10, cursor='hand2', relief='raised', bd=2)&#10;            btn_add_all.pack(side='left', padx=20, pady=15)&#10;            add_button_hover_effect(btn_add_all, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;            btn_cancel = tk.Button(button_frame, text=&quot;❌ Hủy bỏ&quot;, command=cancel_dialog,&#10;                                  bg='#e74c3c', fg='white', font=('Arial', 13, 'bold'),&#10;                                  padx=30, pady=10, cursor='hand2', relief='raised', bd=2)&#10;            btn_cancel.pack(side='right', padx=20, pady=15)&#10;            add_button_hover_effect(btn_cancel, '#e74c3c', get_hover_color('#e74c3c'))&#10;&#10;        # OLD add_to_cart function - NO LONGER USED&#10;        # This function is replaced by show_multi_product_cart_dialog&#10;        # Keeping it commented for reference only&#10;        '''&#10;        def add_to_cart(ma_sp, ten_sp):&#10;            # This function used color_var and size_var which are removed&#10;            # Now using dialog system instead&#10;            pass&#10;        '''&#10;&#10;        def add_to_cart_with_quantity(ma_sp, ten_sp, selected_color, selected_size, quantity):&#10;            &quot;&quot;&quot;Add product to cart - Save to DATABASE giohangchuasanpham&quot;&quot;&quot;&#10;            print(f&quot;Debug: Adding {quantity}x {ten_sp} (Color: {selected_color}, Size: {selected_size}) to cart&quot;)&#10;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Get MaKH from username&#10;                cursor.execute(&quot;SELECT MaKH FROM khachhang WHERE TenDN = %s&quot;, (username,))&#10;                result = cursor.fetchone()&#10;                if not result:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, &quot;Không tìm thấy thông tin khách hàng!&quot;)&#10;                    return&#10;                ma_kh = result[0]&#10;&#10;                # Get current available stock and discount&#10;                cursor.execute(&quot;SELECT SoLuong, GiamGia FROM sanpham WHERE MaSP = %s&quot;, (ma_sp,))&#10;                stock_result = cursor.fetchone()&#10;                if not stock_result:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, &quot;Không tìm thấy sản phẩm!&quot;)&#10;                    return&#10;&#10;                available_stock, giam_gia = stock_result&#10;&#10;                # Check if cart already has this item&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    SELECT SoLuong FROM giohangchuasanpham &#10;                    WHERE MaKH = %s AND MaSP = %s AND MauSac = %s AND Size = %s&#10;                &quot;&quot;&quot;, (ma_kh, ma_sp, selected_color, selected_size))&#10;                existing = cursor.fetchone()&#10;                current_quantity_in_cart = existing[0] if existing else 0&#10;                new_total_quantity = current_quantity_in_cart + quantity&#10;&#10;                # Validation: Check stock&#10;                if new_total_quantity &gt; available_stock:&#10;                    remaining = available_stock - current_quantity_in_cart&#10;                    messagebox.showwarning(&quot;Cảnh báo tồn kho&quot;,&#10;                                         f&quot;Không thể thêm {quantity} sản phẩm '{ten_sp}'!\n\n&quot;&#10;                                         f&quot; Tồn kho: {available_stock}\n&quot;&#10;                                         f&quot; Đã có trong giỏ: {current_quantity_in_cart}\n&quot;&#10;                                         f&quot;✅ Có thể thêm tối đa: {remaining}\n&quot;&#10;                                         f&quot;(Màu: {selected_color}, Size: {selected_size})&quot;)&#10;                    return&#10;&#10;                # Add or update cart in DATABASE&#10;                if existing:&#10;                    cursor.execute(&quot;&quot;&quot;&#10;                        UPDATE giohangchuasanpham &#10;                        SET SoLuong = %s &#10;                        WHERE MaKH = %s AND MaSP = %s AND MauSac = %s AND Size = %s&#10;                    &quot;&quot;&quot;, (new_total_quantity, ma_kh, ma_sp, selected_color, selected_size))&#10;                    success_message = (f&quot;Đã cập nhật giỏ hàng!\n&quot;&#10;                                     f&quot;Sản phẩm: {ten_sp}\n&quot;&#10;                                     f&quot;Màu sắc: {selected_color}, Size: {selected_size}\n&quot;&#10;                                     f&quot;Số lượng mới: {new_total_quantity}&quot;)&#10;                else:&#10;                    cursor.execute(&quot;&quot;&quot;&#10;                        INSERT INTO giohangchuasanpham (MaKH, MaSP, MauSac, Size, SoLuong)&#10;                        VALUES (%s, %s, %s, %s, %s)&#10;                    &quot;&quot;&quot;, (ma_kh, ma_sp, selected_color, selected_size, quantity))&#10;                    success_message = (f&quot;Đã thêm vào giỏ hàng!\n&quot;&#10;                                     f&quot;Sản phẩm: {ten_sp}\n&quot;&#10;                                     f&quot;Màu sắc: {selected_color}, Size: {selected_size}\n&quot;&#10;                                     f&quot;Số lượng: {quantity}&quot;)&#10;&#10;                conn.commit()&#10;&#10;                # Update cart button&#10;                btn_cart.config(text=update_cart_button())&#10;&#10;                # Show success message&#10;                remaining_after = available_stock - new_total_quantity&#10;                messagebox.showinfo(&quot;Thành công&quot;,&#10;                                   f&quot;{success_message}\n\n&quot;&#10;                                   f&quot; Còn lại trong kho: {remaining_after}&quot;)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể thêm sản phẩm vào giỏ hàng: {str(e)}&quot;)&#10;                import traceback&#10;                traceback.print_exc()&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        def delete_product(ma_sp, ten_sp):&#10;            if role != &quot;seller&quot;:&#10;                return&#10;&#10;            result = messagebox.askyesno(&quot;Xác nhận&quot;, f&quot;Bạn có chắc chắn muốn xóa sản phẩm '{ten_sp}' không?&quot;)&#10;            if not result:&#10;                return&#10;&#10;            conn = None&#10;            cursor = None&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Delete all related records in correct order to avoid foreign key constraint errors&#10;&#10;                # 1. Delete from giohangchuasanpham (temporary cart items)&#10;                cursor.execute(&quot;DELETE FROM giohangchuasanpham WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                # 2. Delete from sptrongdon (order items - unpaid orders)&#10;                cursor.execute(&quot;DELETE FROM sptrongdon WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                # 3. Delete product images&#10;                cursor.execute(&quot;DELETE FROM url_sp WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                # 4. Delete product from sanpham table&#10;                # NOTE: cthoadon (invoice details) will KEEP the product data including TenSP&#10;                # This ensures sales statistics remain accurate even after product deletion&#10;                cursor.execute(&quot;DELETE FROM sanpham WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                conn.commit()&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã xóa sản phẩm '{ten_sp}' thành công!&quot;)&#10;&#10;                # Refresh the product list&#10;                self.show_shoes(role, username)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể xóa sản phẩm: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Filter products function&#10;        def filter_products():&#10;            # Clear current items&#10;            for item in tree.get_children():&#10;                tree.delete(item)&#10;&#10;            search_text = search_var.get().lower().strip()&#10;            selected_brand = brand_var.get()&#10;            selected_price = price_var.get()&#10;&#10;            filtered_products = []&#10;            out_of_stock_count = 0&#10;            low_stock_count = 0&#10;&#10;            for ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia in all_products:&#10;                # Filter by search text - Updated to search both product code and name&#10;                if search_text and search_text not in ten_sp.lower() and search_text not in ma_sp.lower():&#10;                    continue&#10;&#10;                # Filter by brand&#10;                if selected_brand != &quot;Tất cả&quot; and ten_th != selected_brand:&#10;                    continue&#10;&#10;                # Filter by price&#10;                if selected_price != &quot;Tất cả&quot; and gia:&#10;                    price_val = float(gia)&#10;                    if selected_price == &quot;Dưới 500k&quot; and price_val &gt;= 500000:&#10;                        continue&#10;                    elif selected_price == &quot;500k - 1tr&quot; and (price_val &lt; 500000 or price_val &gt;= 1000000):&#10;                        continue&#10;                    elif selected_price == &quot;1tr - 2tr&quot; and (price_val &lt; 1000000 or price_val &gt;= 2000000):&#10;                        continue&#10;                    elif selected_price == &quot;Trên 2tr&quot; and price_val &lt; 2000000:&#10;                        continue&#10;&#10;                filtered_products.append((ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia))&#10;&#10;                # Count stock warnings for sellers&#10;                if role == &quot;seller&quot;:&#10;                    if so_luong == 0:&#10;                        out_of_stock_count += 1&#10;                    elif so_luong &lt;= 5:&#10;                        low_stock_count += 1&#10;&#10;            # Populate treeview with stock warnings for sellers&#10;            product_data.clear()&#10;            for ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia in filtered_products:&#10;                # Use GiamGia from database (stored as int, e.g., 10 = 10%, 15 = 15%)&#10;                discount_percent = int(giam_gia) if giam_gia else 0&#10;&#10;                # Apply discount to price display with compact messaging&#10;                if gia is not None:&#10;                    original_price = float(gia)&#10;                    if discount_percent &gt; 0:&#10;                        # Calculate discounted price: original_price * (1 - discount_percent/100)&#10;                        discounted_price = original_price * (1 - discount_percent / 100)&#10;                        price_display = f&quot;{discounted_price:,.0f} VNĐ (-{discount_percent}%)&quot;&#10;                    else:&#10;                        price_display = f&quot;{original_price:,.0f} VNĐ&quot;&#10;                else:&#10;                    price_display = &quot;N/A&quot;&#10;&#10;                if role == &quot;seller&quot;:&#10;                    # Add visual indicators for stock levels&#10;                    if so_luong == 0:&#10;                        display_name = f&quot;⚠️ {ten_sp} (HẾT HÀNG)&quot;&#10;                        item_id = tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, display_name, price_display, so_luong))&#10;                        tree.set(item_id, &quot;SL&quot;, f&quot;⚠️ {so_luong}&quot;)&#10;                    elif so_luong &lt;= 5:&#10;                        display_name = f&quot;⚡ {ten_sp} (SẮP HẾT)&quot;&#10;                        item_id = tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, display_name, price_display, so_luong))&#10;                        tree.set(item_id, &quot;SL&quot;, f&quot;⚡ {so_luong}&quot;)&#10;                    else:&#10;                        tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, ten_sp, price_display, so_luong))&#10;                else:&#10;                    tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, ten_sp, price_display))&#10;&#10;                # Calculate actual discounted price for cart&#10;                original_price_val = float(gia) if gia else 0&#10;                actual_price = original_price_val * (1 - discount_percent / 100) if discount_percent &gt; 0 else original_price_val&#10;&#10;                product_data[ma_sp] = {&#10;                    &quot;name&quot;: ten_sp,&#10;                    &quot;price&quot;: price_display,&#10;                    &quot;description&quot;: (mo_ta or &quot;Chưa có mô tả cho sản phẩm này.&quot;).strip(),&#10;                    &quot;images&quot;: product_images.get(ma_sp, []),&#10;                    &quot;quantity&quot;: so_luong,&#10;                    &quot;discount&quot;: discount_percent,&#10;                    &quot;original_price&quot;: original_price_val,&#10;                    &quot;discounted_price&quot;: actual_price  # Giá sau khi giảm để dùng cho cart&#10;                }&#10;&#10;            # Update status label with count and stock warnings&#10;            if role == &quot;seller&quot;:&#10;                status_text = f&quot;Tổng sản phẩm: {len(filtered_products)}&quot;&#10;                if out_of_stock_count &gt; 0:&#10;                    status_text += f&quot; | ⚠️ HẾT HÀNG: {out_of_stock_count}&quot;&#10;                if low_stock_count &gt; 0:&#10;                    status_text += f&quot; | ⚡ SẮP HẾT: {low_stock_count}&quot;&#10;                status_label.config(text=status_text, fg='#e74c3c' if out_of_stock_count &gt; 0 else '#f39c12' if low_stock_count &gt; 0 else '#7f8c8d')&#10;&#10;                # Show warning popup for critical stock levels&#10;                if out_of_stock_count &gt; 0 and not hasattr(filter_products, '_warning_shown'):&#10;                    messagebox.showwarning(&quot;Cảnh báo hàng tồn&quot;,&#10;                                         f&quot;Có {out_of_stock_count} sản phẩm đã hết hàng!\n&quot;&#10;                                         f&quot;Vui lòng nhập thêm hàng hoặc ẩn sản phẩm.&quot;)&#10;                    filter_products._warning_shown = True&#10;            else:&#10;                status_label.config(text=f&quot;Tổng sản phẩm: {len(filtered_products)}&quot;, fg='#7f8c8d')&#10;&#10;        # Bind filter events&#10;        btn_search.config(command=filter_products)&#10;        btn_filter.config(command=filter_products)&#10;        search_entry.bind('&lt;Return&gt;', lambda e: filter_products())&#10;&#10;        # Populate initial data&#10;        product_data = {}&#10;        filter_products()  # This will populate the tree&#10;&#10;        # Handle product selection and enable action button&#10;        selected_product_id = None&#10;&#10;        def on_product_select_combined(event):&#10;            nonlocal selected_product_id&#10;            selection = tree.selection()&#10;&#10;        def on_product_select_combined(event):&#10;            nonlocal selected_product_id&#10;            selection = tree.selection()&#10;&#10;            if selection:&#10;                if role == &quot;buyer&quot;:&#10;                    # For buyers: support multiple selection&#10;                    selected_product_id = selection  # Store all selections&#10;                    num_selected = len(selection)&#10;&#10;                    # Enable add to cart button&#10;                    btn_add_to_cart.config(state='normal', bg='#27ae60')&#10;                    add_button_hover_effect(btn_add_to_cart, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;                    if num_selected == 1:&#10;                        status_label.config(text=&quot;Đã chọn 1 sản phẩm - Click để thêm vào giỏ!&quot;, fg='green')&#10;                        # Update product details for single selection&#10;                        product = product_data[selection[0]]&#10;                        product_name_label.config(text=product[&quot;name&quot;])&#10;&#10;                        if product['discount'] &gt; 0:&#10;                            original_price = product['original_price']&#10;                            discounted_price = original_price * (1 - product['discount'] / 100)&#10;                            product_price_label.config(&#10;                                text=f&quot;Giá: {discounted_price:,.0f} VNĐ (-{product['discount']}%)\n&quot;&#10;                                     f&quot;Giá gốc: {original_price:,.0f} VNĐ&quot;,&#10;                                fg='#e74c3c'&#10;                            )&#10;                        else:&#10;                            product_price_label.config(text=product['price'], fg='#27ae60')&#10;&#10;                        desc_text.config(state='normal')&#10;                        desc_text.delete(1.0, tk.END)&#10;                        desc_text.insert(1.0, product[&quot;description&quot;])&#10;                        desc_text.config(state='disabled')&#10;&#10;                        images = product[&quot;images&quot;]&#10;                        if images:&#10;                            show_main_image(images[0])&#10;                            update_thumbnail_gallery(images)&#10;                        else:&#10;                            show_main_image(None)&#10;                            update_thumbnail_gallery([])&#10;                    else:&#10;                        status_label.config(text=f&quot;Đã chọn {num_selected} sản phẩm - Click để thêm vào giỏ!&quot;, fg='green')&#10;                        product_name_label.config(text=f&quot;{num_selected} sản phẩm đã chọn&quot;)&#10;                        product_price_label.config(text=&quot;&quot;, fg='#27ae60')&#10;                        desc_text.config(state='normal')&#10;                        desc_text.delete(1.0, tk.END)&#10;                        desc_text.insert(1.0, &quot;Nhiều sản phẩm được chọn. Click thêm vào giỏ để cấu hình từng sản phẩm.&quot;)&#10;                        desc_text.config(state='disabled')&#10;                        show_main_image(None)&#10;                        update_thumbnail_gallery([])&#10;&#10;                    # Set command for add to cart with all selections&#10;                    btn_add_to_cart.config(command=lambda: show_multi_product_cart_dialog(selection))&#10;&#10;                else:&#10;                    # For sellers: single selection only&#10;                    selected_product_id = selection[0]&#10;                    if selected_product_id in product_data:&#10;                        # Enable delete and edit product buttons with hover effects&#10;                        btn_delete_product.config(state='normal', bg='#e74c3c')&#10;                        add_button_hover_effect(btn_delete_product, '#e74c3c', get_hover_color('#e74c3c'))&#10;                        btn_edit_product.config(state='normal', bg='#f39c12')&#10;                        add_button_hover_effect(btn_edit_product, '#f39c12', get_hover_color('#f39c12'))&#10;                        status_label.config(text=&quot;Click để xóa hoặc sửa sản phẩm đã chọn&quot;, fg='blue')&#10;                        btn_delete_product.config(command=lambda: delete_product(selected_product_id, product_data[selected_product_id][&quot;name&quot;]))&#10;                        btn_edit_product.config(command=lambda: self.show_edit_product_form(selected_product_id, role, username))&#10;&#10;                        # Update product details on the right panel&#10;                        product = product_data[selected_product_id]&#10;&#10;                        # Update product name&#10;                        product_name_label.config(text=f&quot;{product['name']} (SL: {product['quantity']})&quot;)&#10;&#10;                        # Update price with discount info&#10;                        if product['discount'] &gt; 0:&#10;                            original_price = product['original_price']&#10;                            discounted_price = original_price * (1 - product['discount'] / 100)&#10;                            product_price_label.config(&#10;                                text=f&quot;Giá: {discounted_price:,.0f} VNĐ (-{product['discount']}%)\n&quot;&#10;                                     f&quot;Giá gốc: {original_price:,.0f} VNĐ&quot;,&#10;                                fg='#e74c3c'&#10;                            )&#10;                        else:&#10;                            product_price_label.config(text=product['price'], fg='#27ae60')&#10;&#10;                        # Update description&#10;                        desc_text.config(state='normal')&#10;                        desc_text.delete(1.0, tk.END)&#10;                        desc_text.insert(1.0, product[&quot;description&quot;])&#10;                        desc_text.config(state='disabled')&#10;&#10;                        # Update images&#10;                        images = product[&quot;images&quot;]&#10;                        if images:&#10;                            show_main_image(images[0])  # Show first image as main&#10;                            update_thumbnail_gallery(images)&#10;                        else:&#10;                            show_main_image(None)&#10;                            update_thumbnail_gallery([])&#10;            else:&#10;                selected_product_id = None&#10;                if role == &quot;buyer&quot;:&#10;                    btn_add_to_cart.config(state='disabled', bg='#95a5a6')&#10;                    status_label.config(text=&quot;Chọn sản phẩm để thêm vào giỏ hàng&quot;, fg='#7f8c8d')&#10;                else:&#10;                    btn_delete_product.config(state='disabled', bg='#95a5a6')&#10;                    btn_edit_product.config(state='disabled', bg='#95a5a6')&#10;                    status_label.config(text=&quot;Chọn sản phẩm để xóa hoặc sửa&quot;, fg='#7f8c8d')&#10;&#10;        # ONLY bind this event - remove any other bindings&#10;        tree.bind(&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;, on_product_select_combined)&#10;&#10;        # Right panel: Product details and image gallery&#10;        detail_frame = tk.Frame(main_frame, bg='#f8f9fa')&#10;        detail_frame.pack(side='right', fill='both', expand=True)&#10;&#10;        # Product name&#10;        product_name_label = tk.Label(detail_frame, text=&quot;Chọn sản phẩm để xem chi tiết&quot;,&#10;                                      font=('Arial', 18, 'bold'), bg='#f8f9fa', fg='#2c3e50')&#10;        product_name_label.pack(pady=(15, 5))&#10;&#10;        # Price label (with discount if applicable)&#10;        product_price_label = tk.Label(detail_frame, text=&quot;&quot;,&#10;                                       font=('Arial', 16, 'bold'), bg='#f8f9fa', fg='#27ae60')&#10;        product_price_label.pack(pady=(0, 10))&#10;&#10;        # Create horizontal container for image and gallery&#10;        content_container = tk.Frame(detail_frame, bg='#f8f9fa')&#10;        content_container.pack(fill='both', expand=True, padx=15)&#10;&#10;        # Left side - Image and description section&#10;        image_section = tk.Frame(content_container, bg='#f8f9fa')&#10;        image_section.pack(side='left', fill='both', expand=True, padx=(0, 15))&#10;&#10;        # Main image display area (reduced height to accommodate wider price column)&#10;        main_image_frame = tk.Frame(image_section, bg='white', relief='solid', bd=1, height=450)&#10;        main_image_frame.pack(fill='x', pady=(0, 15))&#10;        main_image_frame.pack_propagate(False)&#10;&#10;        main_image_label = tk.Label(main_image_frame, text=&quot;Hình ảnh sản phẩm&quot;,&#10;                                   font=('Arial', 14), bg='white', fg='#6c757d')&#10;        main_image_label.pack(expand=True)&#10;&#10;        # Description area (below main image, more visible with better spacing)&#10;        desc_section = tk.Frame(image_section, bg='#f8f9fa', relief='solid', bd=1)&#10;        desc_section.pack(fill='x', pady=(0, 10))&#10;&#10;        tk.Label(desc_section, text=&quot;Mô tả sản phẩm:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#f8f9fa').pack(anchor='w', pady=(5, 5), padx=5)&#10;&#10;        desc_text = tk.Text(desc_section, height=4, wrap='word', font=('Arial', 11),&#10;                           state='disabled', bg='white', relief='solid', bd=1)&#10;        desc_text.pack(fill='both', expand=True, padx=5, pady=(0, 5))&#10;&#10;        # Right side - Thumbnail gallery section (with better spacing)&#10;        gallery_section = tk.Frame(content_container, bg='#f8f9fa', width=120)&#10;        gallery_section.pack(side='right', fill='y', padx=(15, 0))&#10;        gallery_section.pack_propagate(False)&#10;&#10;        tk.Label(gallery_section, text=&quot;Các ảnh khác:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#f8f9fa').pack(anchor='w', pady=(0, 10))&#10;&#10;        # Scrollable thumbnail container (adjusted height)&#10;        thumbnail_frame = tk.Frame(gallery_section, bg='white', height=380, relief='solid', bd=1)&#10;        thumbnail_frame.pack(fill='both', expand=True)&#10;&#10;        # Canvas for scrolling thumbnails (vertical scrolling now)&#10;        thumbnail_canvas = tk.Canvas(thumbnail_frame, bg='white')&#10;        thumbnail_scrollbar = ttk.Scrollbar(thumbnail_frame, orient='vertical', command=thumbnail_canvas.yview)&#10;        thumbnail_scrollable = tk.Frame(thumbnail_canvas, bg='white')&#10;&#10;        thumbnail_scrollable.bind(&quot;&lt;Configure&gt;&quot;,&#10;                                 lambda e: thumbnail_canvas.configure(scrollregion=thumbnail_canvas.bbox(&quot;all&quot;)))&#10;        thumbnail_canvas.create_window((0, 0), window=thumbnail_scrollable, anchor=&quot;nw&quot;)&#10;        thumbnail_canvas.configure(yscrollcommand=thumbnail_scrollbar.set)&#10;&#10;        thumbnail_canvas.pack(side='left', fill='both', expand=True)&#10;        thumbnail_scrollbar.pack(side='right', fill='y')&#10;&#10;        # Functions for handling images&#10;        def show_main_image(image_url):&#10;            &quot;&quot;&quot;Display main image&quot;&quot;&quot;&#10;            try:&#10;                # Clear current image&#10;                for widget in main_image_frame.winfo_children():&#10;                    widget.destroy()&#10;&#10;                if image_url:&#10;                    img = load_image_safely(image_url)&#10;                    if img:&#10;                        # Resize to fit main display area&#10;                        main_image_label_new = tk.Label(main_image_frame, image=img, bg='white')&#10;                        main_image_label_new.image = img  # Keep reference&#10;                        main_image_label_new.pack(expand=True)&#10;                    else:&#10;                        tk.Label(main_image_frame, text=&quot;❌ Không thể tải hình ảnh&quot;,&#10;                               font=('Arial', 14), bg='white', fg='#e74c3c').pack(expand=True)&#10;                else:&#10;                    tk.Label(main_image_frame, text=&quot;Không có hình ảnh&quot;,&#10;                           font=('Arial', 14), bg='white', fg='#6c757d').pack(expand=True)&#10;            except Exception as e:&#10;                tk.Label(main_image_frame, text=&quot;Lỗi tải hình ảnh&quot;,&#10;                       font=('Arial', 14), bg='white', fg='#e74c3c').pack(expand=True)&#10;&#10;        def update_thumbnail_gallery(images):&#10;            &quot;&quot;&quot;Update thumbnail gallery&quot;&quot;&quot;&#10;            # Clear current thumbnails&#10;            for widget in thumbnail_scrollable.winfo_children():&#10;                widget.destroy()&#10;&#10;            if not images:&#10;                tk.Label(thumbnail_scrollable, text=&quot;Không có ảnh khác&quot;,&#10;                       font=('Arial', 10), bg='white', fg='#6c757d').pack(pady=20)&#10;                return&#10;&#10;            for i, image_url in enumerate(images):&#10;                try:&#10;                    # Load thumbnail image&#10;                    thumb_img = load_thumbnail_image(image_url)&#10;                    if thumb_img:&#10;                        # Create thumbnail button - now arranged vertically and centered&#10;                        thumb_btn = tk.Button(thumbnail_scrollable, image=thumb_img,&#10;                                             command=lambda url=image_url: show_main_image(url),&#10;                                             relief='solid', bd=2, cursor='hand2',&#10;                                             bg='white', activebackground='#e9ecef')&#10;                        thumb_btn.image = thumb_img  # Keep reference&#10;                        thumb_btn.pack(pady=3, padx=5, anchor='center')  # Added anchor='center'&#10;&#10;                        # Hover effects&#10;                        def on_enter(e, btn=thumb_btn):&#10;                            btn.config(bd=3, bg='#dee2e6')&#10;                        def on_leave(e, btn=thumb_btn):&#10;                            btn.config(bd=2, bg='white')&#10;&#10;                        thumb_btn.bind(&quot;&lt;Enter&gt;&quot;, on_enter)&#10;                        thumb_btn.bind(&quot;&lt;Leave&gt;&quot;, on_leave)&#10;&#10;                    else:&#10;                        # Fallback button if can't load image - also centered&#10;                        thumb_btn = tk.Button(thumbnail_scrollable, text=f&quot;Ảnh {i+1}&quot;,&#10;                                             command=lambda url=image_url: show_main_image(url),&#10;                                             width=8, height=4, cursor='hand2',&#10;                                             relief='solid', bd=2, bg='white')&#10;                        thumb_btn.pack(pady=3, padx=5, anchor='center')  # Added anchor='center'&#10;&#10;                except Exception as e:&#10;                    print(f&quot;Error creating thumbnail {i+1}: {e}&quot;)&#10;                    # Create placeholder button - also centered&#10;                    thumb_btn = tk.Button(thumbnail_scrollable, text=f&quot;Ảnh {i+1}&quot;,&#10;                                         command=lambda url=image_url: show_main_image(url),&#10;                                         width=8, height=4, cursor='hand2',&#10;                                         relief='solid', bd=2, bg='white')&#10;                    thumb_btn.pack(pady=3, padx=5, anchor='center')  # Added anchor='center'&#10;&#10;        # Mouse wheel scroll for thumbnail canvas&#10;        def on_mousewheel(event):&#10;            thumbnail_canvas.xview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;&#10;        thumbnail_canvas.bind(&quot;&lt;MouseWheel&gt;&quot;, on_mousewheel)&#10;&#10;    def show_add_product_form(self, role, username):&#10;        &quot;&quot;&quot;Show add product form - from main.py&quot;&quot;&quot;&#10;        # Create add product window&#10;        add_window = tk.Toplevel(self.root)&#10;        add_window.title(&quot;Thêm sản phẩm mới&quot;)&#10;        add_window.geometry(&quot;600x650&quot;)  # Increased width and height for better visibility&#10;        add_window.resizable(False, False)&#10;        add_window.grab_set()  # Make window modal&#10;&#10;        # Center the window&#10;        add_window.transient(self.root)&#10;        add_window.focus()&#10;&#10;        # Unbind mousewheel when window closes&#10;        def on_closing():&#10;            add_window.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;            add_window.destroy()&#10;&#10;        add_window.protocol(&quot;WM_DELETE_WINDOW&quot;, on_closing)&#10;&#10;        # IMPORTANT: Pack button frame FIRST to reserve space at bottom&#10;        button_frame = tk.Frame(add_window, bg='#f0f0f0', relief='ridge', bd=1)&#10;        button_frame.pack(side='bottom', fill='x', padx=10, pady=10)&#10;&#10;        # Create canvas with scrollbar for scrollable content&#10;        canvas = tk.Canvas(add_window, bg='white')&#10;        scrollbar = tk.Scrollbar(add_window, orient=&quot;vertical&quot;, command=canvas.yview)&#10;        scrollable_frame = tk.Frame(canvas, bg='white')&#10;&#10;        scrollable_frame.bind(&#10;            &quot;&lt;Configure&gt;&quot;,&#10;            lambda e: canvas.configure(scrollregion=canvas.bbox(&quot;all&quot;))&#10;        )&#10;&#10;        canvas.create_window((0, 0), window=scrollable_frame, anchor=&quot;nw&quot;)&#10;        canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;        # Pack canvas and scrollbar - they will fill remaining space above buttons&#10;        canvas.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True, padx=(10, 0), pady=10)&#10;        scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;, pady=10)&#10;&#10;        # Use scrollable_frame as main_container&#10;        main_container = scrollable_frame&#10;&#10;        # Enable mousewheel scrolling&#10;        def _on_mousewheel(event):&#10;            canvas.yview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;        add_window.bind_all(&quot;&lt;MouseWheel&gt;&quot;, _on_mousewheel)&#10;&#10;        # Form fields&#10;        tk.Label(main_container, text=&quot;THÊM SẢN PHẨM MỚI&quot;, font=('Arial', 16, 'bold'), fg='#2c3e50').pack(pady=(10, 20))&#10;&#10;        # Product name&#10;        tk.Label(main_container, text=&quot;Tên sản phẩm:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_name = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_name.pack(padx=10, pady=(0, 8))&#10;&#10;        # Price&#10;        tk.Label(main_container, text=&quot;Giá (VNĐ):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_price = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_price.pack(padx=10, pady=(0, 8))&#10;&#10;        # Brand&#10;        tk.Label(main_container, text=&quot;Thương hiệu:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        brand_var_add = tk.StringVar()&#10;        brand_combo_add = ttk.Combobox(main_container, textvariable=brand_var_add, font=('Arial', 12), width=37, state='readonly')&#10;&#10;        # Load brands&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;            cursor.execute(&quot;SELECT MaTH, TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands_data = cursor.fetchall()&#10;            brand_combo_add['values'] = [f&quot;{th[1]} ({th[0]})&quot; for th in brands_data]&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải danh sách thương hiệu: {str(e)}&quot;)&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        brand_combo_add.pack(padx=10, pady=(0, 8))&#10;&#10;        # Quantity&#10;        tk.Label(main_container, text=&quot;Số lượng:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_quantity = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_quantity.pack(padx=10, pady=(0, 8))&#10;&#10;        # Import Date (NgayNhapHang)&#10;        tk.Label(main_container, text=&quot;Ngày nhập hàng (YYYY-MM-DD):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_import_date = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_import_date.pack(padx=10, pady=(0, 8))&#10;&#10;        # Description&#10;        tk.Label(main_container, text=&quot;Mô tả:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_description = tk.Text(main_container, font=('Arial', 11), width=42, height=5, wrap='word')  # Reduced height from 6 to 5&#10;        text_description.pack(padx=10, pady=(0, 8))&#10;&#10;        # Colors (Available colors for this product)&#10;        tk.Label(main_container, text=&quot;Màu sắc có sẵn (mỗi màu một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_colors = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        text_colors.insert(1.0, &quot;Trắng\nXanh Dương\nĐen\nNâu&quot;)  # Default colors&#10;        text_colors.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image URLs&#10;        tk.Label(main_container, text=&quot;URL hình ảnh (mỗi URL một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_images = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        text_images.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image Upload Section&#10;        upload_frame = tk.Frame(main_container)&#10;        upload_frame.pack(fill='x', padx=10, pady=(5, 8))&#10;&#10;        tk.Label(upload_frame, text=&quot;Hoặc tải ảnh từ thiết bị:&quot;, font=('Arial', 11, 'bold')).pack(anchor='w')&#10;&#10;        # Store uploaded image filenames temporarily&#10;        uploaded_images = []&#10;&#10;        upload_btn_frame = tk.Frame(upload_frame)&#10;        upload_btn_frame.pack(anchor='w', pady=(5, 0))&#10;&#10;        def upload_image():&#10;            filetypes = [(&quot;Image files&quot;, &quot;*.png *.jpg *.jpeg *.gif *.bmp&quot;), (&quot;All files&quot;, &quot;*.*&quot;)]&#10;            file_path = filedialog.askopenfilename(parent=add_window, title=&quot;Chọn hình ảnh&quot;, filetypes=filetypes)&#10;            if file_path:&#10;                try:&#10;                    # Save to local directory&#10;                    filename = save_uploaded_image(file_path)&#10;                    uploaded_images.append(filename)&#10;                    # Update label to show count&#10;                    upload_count_label.config(text=f&quot;Đã chọn: {len(uploaded_images)} ảnh&quot;, fg='#27ae60')&#10;                    messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm ảnh: {os.path.basename(file_path)}&quot;)&#10;                except Exception as e:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải ảnh: {str(e)}&quot;)&#10;&#10;        tk.Button(upload_btn_frame, text=&quot; Chọn ảnh từ máy&quot;, command=upload_image,&#10;                 bg='#3498db', fg='white', font=('Arial', 10, 'bold'),&#10;                 padx=10, pady=5, cursor='hand2').pack(side='left')&#10;&#10;        upload_count_label = tk.Label(upload_btn_frame, text=&quot;Chưa chọn ảnh nào&quot;,&#10;                                      font=('Arial', 10), fg='#7f8c8d')&#10;        upload_count_label.pack(side='left', padx=(10, 0))&#10;&#10;&#10;        def save_product():&#10;            # Get form data&#10;            name = entry_name.get().strip()&#10;            price_str = entry_price.get().strip()&#10;            brand_selection = brand_var_add.get()&#10;            quantity_str = entry_quantity.get().strip()&#10;            import_date_str = entry_import_date.get().strip()&#10;            description = text_description.get(1.0, tk.END).strip()&#10;            colors = text_colors.get(1.0, tk.END).strip()&#10;            image_urls = text_images.get(1.0, tk.END).strip()&#10;&#10;            # Validation&#10;            if not all([name, price_str, brand_selection, quantity_str]):&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng nhập đầy đủ thông tin bắt buộc!&quot;)&#10;                return&#10;&#10;            try:&#10;                price = float(price_str)&#10;                if price &lt;= 0:&#10;                    raise ValueError(&quot;Giá phải lớn hơn 0&quot;)&#10;                quantity = int(quantity_str)&#10;                if quantity &lt; 0:&#10;                    raise ValueError(&quot;Số lượng phải &gt;= 0&quot;)&#10;&#10;                # Validate import date format if provided&#10;                if import_date_str:&#10;                    from datetime import datetime&#10;                    try:&#10;                        datetime.strptime(import_date_str, '%Y-%m-%d')&#10;                    except ValueError:&#10;                        raise ValueError(&quot;Ngày nhập hàng phải theo định dạng YYYY-MM-DD&quot;)&#10;            except ValueError as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Dữ liệu không hợp lệ: {str(e)}&quot;)&#10;                return&#10;&#10;            # Extract brand ID&#10;            try:&#10;                brand_id = brand_selection.split('(')[1].replace(')', '')&#10;            except:&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng chọn thương hiệu!&quot;)&#10;                return&#10;&#10;            # Generate product ID&#10;            conn = None&#10;            cursor = None&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Create color table if not exists&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    CREATE TABLE IF NOT EXISTS mausac_sp (&#10;                        MaSP VARCHAR(30) NOT NULL,&#10;                        MauSac VARCHAR(100) NOT NULL,&#10;                        PRIMARY KEY (MaSP, MauSac),&#10;                        FOREIGN KEY (MaSP) REFERENCES sanpham(MaSP) ON DELETE CASCADE&#10;                    )&#10;                &quot;&quot;&quot;)&#10;&#10;                # Generate new product ID&#10;                cursor.execute(&quot;SELECT MAX(CAST(SUBSTRING(MaSP, 3) AS UNSIGNED)) FROM sanpham WHERE MaSP LIKE 'SP%'&quot;)&#10;                result = cursor.fetchone()&#10;                next_number = ((result[0] or 0) + 1) if result and result[0] is not None else 1&#10;                product_id = f&quot;SP{next_number:03d}&quot;&#10;&#10;                # Insert product with import date&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    INSERT INTO sanpham (MaSP, TenSP, Gia, MoTa, MaTH, SoLuong, NgayNhapHang)&#10;                    VALUES (%s, %s, %s, %s, %s, %s, %s)&#10;                &quot;&quot;&quot;, (product_id, name, price, description if description else None, brand_id, quantity,&#10;                      import_date_str if import_date_str else None))&#10;&#10;                # Insert colors if provided&#10;                if colors:&#10;                    color_list = [color.strip() for color in colors.split('\n') if color.strip()]&#10;                    for color in color_list:&#10;                        cursor.execute(&quot;INSERT INTO mausac_sp (MaSP, MauSac) VALUES (%s, %s)&quot;, (product_id, color))&#10;&#10;                # Insert image URLs if provided&#10;                if image_urls:&#10;                    urls = [url.strip() for url in image_urls.split('\n') if url.strip()]&#10;                    for url in urls:&#10;                        cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, url))&#10;&#10;                # Insert uploaded images&#10;                for filename in uploaded_images:&#10;                    cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, filename))&#10;&#10;                conn.commit()&#10;                total_images = len([url.strip() for url in image_urls.split('\n') if url.strip()]) + len(uploaded_images)&#10;                total_colors = len([color.strip() for color in colors.split('\n') if color.strip()])&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm sản phẩm '{name}' với {total_colors} màu và {total_images} ảnh thành công!&quot;)&#10;                add_window.destroy()&#10;&#10;                # Refresh the product list&#10;                self.show_shoes(role, username)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể thêm sản phẩm: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Action buttons with proper colors and positions&#10;        tk.Button(button_frame, text=&quot; Lưu&quot;, command=save_product,&#10;                 bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='left', padx=15, pady=10)&#10;        tk.Button(button_frame, text=&quot;❌ Hủy&quot;, command=on_closing,&#10;                 bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='right', padx=15, pady=10)&#10;&#10;    def show_edit_product_form(self, product_id, role, username):&#10;        &quot;&quot;&quot;Show edit product form with current data loaded&quot;&quot;&quot;&#10;        # First, get current product data from database&#10;        conn = None&#10;        cursor = None&#10;        current_data = {}&#10;        current_images = []&#10;&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;&#10;            # Get product details&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT sp.MaSP, sp.TenSP, sp.Gia, sp.MoTa, sp.MaTH, sp.SoLuong, th.TenTH, sp.NgayNhapHang&#10;                FROM sanpham sp&#10;                LEFT JOIN thuonghieu th ON sp.MaTH = th.MaTH&#10;                WHERE sp.MaSP = %s&#10;            &quot;&quot;&quot;, (product_id,))&#10;&#10;            result = cursor.fetchone()&#10;            if not result:&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Không tìm thấy sản phẩm!&quot;)&#10;                return&#10;&#10;            current_data = {&#10;                'id': result[0],&#10;                'name': result[1],&#10;                'price': result[2],&#10;                'description': result[3] or &quot;&quot;,&#10;                'brand_id': result[4],&#10;                'quantity': result[5],&#10;                'brand_name': result[6],&#10;                'import_date': result[7].strftime('%Y-%m-%d') if result[7] else ''&#10;            }&#10;&#10;            # Get product images&#10;            cursor.execute(&quot;SELECT URLAnh FROM url_sp WHERE MaSP = %s&quot;, (product_id,))&#10;            current_images = [row[0] for row in cursor.fetchall()]&#10;&#10;            # Get product colors&#10;            current_colors = []&#10;            try:&#10;                cursor.execute(&quot;SELECT MauSac FROM mausac_sp WHERE MaSP = %s&quot;, (product_id,))&#10;                current_colors = [row[0] for row in cursor.fetchall()]&#10;            except Exception as e:&#10;                # If table doesn't exist yet, use default colors&#10;                print(f&quot;Note: Color table may not exist yet: {e}&quot;)&#10;                current_colors = [&quot;Trắng&quot;, &quot;Xanh Dương&quot;, &quot;Đen&quot;, &quot;Nâu&quot;]&#10;&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải dữ liệu sản phẩm: {str(e)}&quot;)&#10;            return&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        # Create edit product window&#10;        edit_window = tk.Toplevel(self.root)&#10;        edit_window.title(f&quot;Sửa sản phẩm: {current_data['name']}&quot;)&#10;        edit_window.geometry(&quot;600x650&quot;)  # Increased width and height for better visibility&#10;        edit_window.resizable(False, False)&#10;        edit_window.grab_set()  # Make window modal&#10;&#10;        # Center the window&#10;        edit_window.transient(self.root)&#10;        edit_window.focus()&#10;&#10;        # Unbind mousewheel when window closes&#10;        def on_closing():&#10;            edit_window.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;            edit_window.destroy()&#10;&#10;        edit_window.protocol(&quot;WM_DELETE_WINDOW&quot;, on_closing)&#10;&#10;        # IMPORTANT: Pack button frame FIRST to reserve space at bottom&#10;        button_frame = tk.Frame(edit_window, bg='#f0f0f0', relief='ridge', bd=1)&#10;        button_frame.pack(side='bottom', fill='x', padx=10, pady=10)&#10;&#10;        # Create canvas with scrollbar for scrollable content&#10;        canvas = tk.Canvas(edit_window, bg='white')&#10;        scrollbar = tk.Scrollbar(edit_window, orient=&quot;vertical&quot;, command=canvas.yview)&#10;        scrollable_frame = tk.Frame(canvas, bg='white')&#10;&#10;        scrollable_frame.bind(&#10;            &quot;&lt;Configure&gt;&quot;,&#10;            lambda e: canvas.configure(scrollregion=canvas.bbox(&quot;all&quot;))&#10;        )&#10;&#10;        canvas.create_window((0, 0), window=scrollable_frame, anchor=&quot;nw&quot;)&#10;        canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;        # Pack canvas and scrollbar - they will fill remaining space above buttons&#10;        canvas.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True, padx=(10, 0), pady=10)&#10;        scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;, pady=10)&#10;&#10;        # Use scrollable_frame as main_container&#10;        main_container = scrollable_frame&#10;&#10;        # Enable mousewheel scrolling&#10;        def _on_mousewheel(event):&#10;            canvas.yview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;        edit_window.bind_all(&quot;&lt;MouseWheel&gt;&quot;, _on_mousewheel)&#10;&#10;        # Form fields&#10;        tk.Label(main_container, text=f&quot;SỬA SẢN PHẨM: {current_data['name']}&quot;,&#10;                font=('Arial', 16, 'bold'), fg='#f39c12').pack(pady=(10, 20))&#10;&#10;        # Product name&#10;        tk.Label(main_container, text=&quot;Tên sản phẩm:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_name = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_name.insert(0, current_data['name'])&#10;        entry_name.pack(padx=10, pady=(0, 8))&#10;&#10;        # Price&#10;        tk.Label(main_container, text=&quot;Giá (VNĐ):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_price = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_price.insert(0, str(current_data['price']))&#10;        entry_price.pack(padx=10, pady=(0, 8))&#10;&#10;        # Brand&#10;        tk.Label(main_container, text=&quot;Thương hiệu:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        brand_var_edit = tk.StringVar()&#10;        brand_combo_edit = ttk.Combobox(main_container, textvariable=brand_var_edit, font=('Arial', 12), width=37, state='readonly')&#10;&#10;        # Load brands and set current brand&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;            cursor.execute(&quot;SELECT MaTH, TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands_data = cursor.fetchall()&#10;            brand_options = [f&quot;{th[1]} ({th[0]})&quot; for th in brands_data]&#10;            brand_combo_edit['values'] = brand_options&#10;&#10;            # Set current brand as selected&#10;            current_brand_text = f&quot;{current_data['brand_name']} ({current_data['brand_id']})&quot;&#10;            brand_var_edit.set(current_brand_text)&#10;&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải danh sách thương hiệu: {str(e)}&quot;)&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        brand_combo_edit.pack(padx=10, pady=(0, 8))&#10;&#10;        # Quantity&#10;        tk.Label(main_container, text=&quot;Số lượng:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_quantity = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_quantity.insert(0, str(current_data['quantity']))&#10;        entry_quantity.pack(padx=10, pady=(0, 8))&#10;&#10;        # Import Date (NgayNhapHang)&#10;        tk.Label(main_container, text=&quot;Ngày nhập hàng (YYYY-MM-DD):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_import_date = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_import_date.insert(0, current_data['import_date'])&#10;        entry_import_date.pack(padx=10, pady=(0, 8))&#10;&#10;        # Description&#10;        tk.Label(main_container, text=&quot;Mô tả:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_description = tk.Text(main_container, font=('Arial', 11), width=42, height=5, wrap='word')&#10;        text_description.insert(1.0, current_data['description'])&#10;        text_description.pack(padx=10, pady=(0, 8))&#10;&#10;        # Colors (Available colors for this product)&#10;        tk.Label(main_container, text=&quot;Màu sắc có sẵn (mỗi màu một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_colors = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        if current_colors:&#10;            text_colors.insert(1.0, '\n'.join(current_colors))&#10;        else:&#10;            text_colors.insert(1.0, &quot;Trắng\nXanh Dương\nĐen\nNâu&quot;)  # Default colors&#10;        text_colors.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image URLs&#10;        tk.Label(main_container, text=&quot;URL hình ảnh (mỗi URL một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_images = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        if current_images:&#10;            text_images.insert(1.0, '\n'.join(current_images))&#10;        text_images.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image Upload Section&#10;        upload_frame = tk.Frame(main_container)&#10;        upload_frame.pack(fill='x', padx=10, pady=(5, 8))&#10;&#10;        tk.Label(upload_frame, text=&quot;Hoặc tải ảnh từ thiết bị:&quot;, font=('Arial', 11, 'bold')).pack(anchor='w')&#10;&#10;        # Store uploaded image filenames temporarily&#10;        uploaded_images = []&#10;&#10;        upload_btn_frame = tk.Frame(upload_frame)&#10;        upload_btn_frame.pack(anchor='w', pady=(5, 0))&#10;&#10;        def upload_image():&#10;            filetypes = [(&quot;Image files&quot;, &quot;*.png *.jpg *.jpeg *.gif *.bmp&quot;), (&quot;All files&quot;, &quot;*.*&quot;)]&#10;            file_path = filedialog.askopenfilename(parent=edit_window, title=&quot;Chọn hình ảnh&quot;, filetypes=filetypes)&#10;            if file_path:&#10;                try:&#10;                    # Save to local directory&#10;                    filename = save_uploaded_image(file_path)&#10;                    uploaded_images.append(filename)&#10;                    # Update label to show count&#10;                    upload_count_label.config(text=f&quot;Đã chọn: {len(uploaded_images)} ảnh mới&quot;, fg='#27ae60')&#10;                    messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm ảnh: {os.path.basename(file_path)}&quot;)&#10;                except Exception as e:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải ảnh: {str(e)}&quot;)&#10;&#10;        tk.Button(upload_btn_frame, text=&quot; Chọn ảnh từ máy&quot;, command=upload_image,&#10;                 bg='#3498db', fg='white', font=('Arial', 10, 'bold'),&#10;                 padx=10, pady=5, cursor='hand2').pack(side='left')&#10;&#10;        upload_count_label = tk.Label(upload_btn_frame, text=&quot;Chưa chọn ảnh mới nào&quot;,&#10;                                      font=('Arial', 10), fg='#7f8c8d')&#10;        upload_count_label.pack(side='left', padx=(10, 0))&#10;&#10;&#10;        def update_product():&#10;            # Get form data&#10;            name = entry_name.get().strip()&#10;            price_str = entry_price.get().strip()&#10;            brand_selection = brand_var_edit.get()&#10;            quantity_str = entry_quantity.get().strip()&#10;            import_date_str = entry_import_date.get().strip()&#10;            description = text_description.get(1.0, tk.END).strip()&#10;            colors = text_colors.get(1.0, tk.END).strip()&#10;            image_urls = text_images.get(1.0, tk.END).strip()&#10;&#10;            # Validation&#10;            if not all([name, price_str, brand_selection, quantity_str]):&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng nhập đầy đủ thông tin bắt buộc!&quot;)&#10;                return&#10;&#10;            try:&#10;                price = float(price_str)&#10;                if price &lt;= 0:&#10;                    raise ValueError(&quot;Giá phải lớn hơn 0&quot;)&#10;                quantity = int(quantity_str)&#10;                if quantity &lt; 0:&#10;                    raise ValueError(&quot;Số lượng phải &gt;= 0&quot;)&#10;&#10;                # Validate import date format if provided&#10;                if import_date_str:&#10;                    from datetime import datetime&#10;                    try:&#10;                        datetime.strptime(import_date_str, '%Y-%m-%d')&#10;                    except ValueError:&#10;                        raise ValueError(&quot;Ngày nhập hàng phải theo định dạng YYYY-MM-DD&quot;)&#10;            except ValueError as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Dữ liệu không hợp lệ: {str(e)}&quot;)&#10;                return&#10;&#10;            # Extract brand ID&#10;            try:&#10;                brand_id = brand_selection.split('(')[1].replace(')', '')&#10;            except:&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng chọn thương hiệu!&quot;)&#10;                return&#10;&#10;            # Update database&#10;            conn = None&#10;            cursor = None&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Create color table if not exists&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    CREATE TABLE IF NOT EXISTS mausac_sp (&#10;                        MaSP VARCHAR(30) NOT NULL,&#10;                        MauSac VARCHAR(100) NOT NULL,&#10;                        PRIMARY KEY (MaSP, MauSac),&#10;                        FOREIGN KEY (MaSP) REFERENCES sanpham(MaSP) ON DELETE CASCADE&#10;                    )&#10;                &quot;&quot;&quot;)&#10;&#10;                # Update product with import date&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    UPDATE sanpham &#10;                    SET TenSP = %s, Gia = %s, MoTa = %s, MaTH = %s, SoLuong = %s, NgayNhapHang = %s&#10;                    WHERE MaSP = %s&#10;                &quot;&quot;&quot;, (name, price, description if description else None, brand_id, quantity,&#10;                      import_date_str if import_date_str else None, product_id))&#10;&#10;                # Delete old colors&#10;                cursor.execute(&quot;DELETE FROM mausac_sp WHERE MaSP = %s&quot;, (product_id,))&#10;&#10;                # Insert new colors if provided&#10;                if colors:&#10;                    color_list = [color.strip() for color in colors.split('\n') if color.strip()]&#10;                    for color in color_list:&#10;                        cursor.execute(&quot;INSERT INTO mausac_sp (MaSP, MauSac) VALUES (%s, %s)&quot;, (product_id, color))&#10;&#10;                # Delete old images&#10;                cursor.execute(&quot;DELETE FROM url_sp WHERE MaSP = %s&quot;, (product_id,))&#10;&#10;                # Insert new image URLs if provided&#10;                if image_urls:&#10;                    urls = [url.strip() for url in image_urls.split('\n') if url.strip()]&#10;                    for url in urls:&#10;                        cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, url))&#10;&#10;                # Insert uploaded images&#10;                for filename in uploaded_images:&#10;                    cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, filename))&#10;&#10;                conn.commit()&#10;                total_images = len([url.strip() for url in image_urls.split('\n') if url.strip()]) + len(uploaded_images)&#10;                total_colors = len([color.strip() for color in colors.split('\n') if color.strip()])&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã cập nhật sản phẩm '{name}' với {total_colors} màu và {total_images} ảnh thành công!&quot;)&#10;                edit_window.destroy()&#10;&#10;                # Refresh the product list&#10;                self.show_shoes(role, username)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể cập nhật sản phẩm: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Action buttons with proper colors and positions&#10;        tk.Button(button_frame, text=&quot;✏️ Cập nhật&quot;, command=update_product,&#10;                 bg='#f39c12', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='left', padx=15, pady=10)&#10;        tk.Button(button_frame, text=&quot;❌ Hủy&quot;, command=on_closing,&#10;                 bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='right', padx=15, pady=10)&#10;&#10;    def show_brand_management(self, role, username):&#10;        &quot;&quot;&quot;Show brand management interface for sellers&quot;&quot;&quot;&#10;        # Create brand management window&#10;        brand_window = tk.Toplevel(self.root)&#10;        brand_window.title(&quot;Quản lý thương hiệu&quot;)&#10;        brand_window.geometry(&quot;600x500&quot;)&#10;        brand_window.resizable(False, False)&#10;&#10;        # Center the window&#10;        brand_window.update_idletasks()&#10;        x = (brand_window.winfo_screenwidth() // 2) - (600 // 2)&#10;        y = (brand_window.winfo_screenheight() // 2) - (500 // 2)&#10;        brand_window.geometry(f&quot;+{x}+{y}&quot;)&#10;&#10;        # Make sure it's on top&#10;        brand_window.transient(self.root)&#10;        brand_window.grab_set()  # Make window modal&#10;        brand_window.lift()  # Raise to top&#10;        brand_window.focus_force()  # Force focus&#10;&#10;        # Header&#10;        header_frame = tk.Frame(brand_window, bg='#9b59b6', height=60)&#10;        header_frame.pack(fill='x')&#10;        header_frame.pack_propagate(False)&#10;&#10;        tk.Label(header_frame, text=&quot;QUẢN LÝ THƯƠNG HIỆU&quot;, font=('Arial', 18, 'bold'),&#10;                 fg='white', bg='#9b59b6').pack(pady=15)&#10;&#10;        # Main content frame&#10;        main_frame = tk.Frame(brand_window)&#10;        main_frame.pack(fill='both', expand=True, padx=15, pady=10)&#10;&#10;        # Brand list frame&#10;        list_frame = tk.Frame(main_frame)&#10;        list_frame.pack(fill='both', expand=True, pady=(0, 10))&#10;&#10;        tk.Label(list_frame, text=&quot;Danh sách thương hiệu:&quot;, font=('Arial', 14, 'bold')).pack(anchor='w', pady=(0, 10))&#10;&#10;        # Treeview for brands&#10;        tree_frame = tk.Frame(list_frame)&#10;        tree_frame.pack(fill='both', expand=True)&#10;&#10;        # Configure style&#10;        style = ttk.Style()&#10;        style.configure(&quot;Brand.Treeview&quot;, font=('Arial', 12))&#10;        style.configure(&quot;Brand.Treeview.Heading&quot;, font=('Arial', 13, 'bold'))&#10;&#10;        brand_tree = ttk.Treeview(tree_frame, columns=(&quot;Mã TH&quot;, &quot;Tên thương hiệu&quot;), show=&quot;headings&quot;,&#10;                                 height=12, style=&quot;Brand.Treeview&quot;)&#10;        brand_tree.heading(&quot;Mã TH&quot;, text=&quot;Mã thương hiệu&quot;)&#10;        brand_tree.heading(&quot;Tên thương hiệu&quot;, text=&quot;Tên thương hiệu&quot;)&#10;        brand_tree.column(&quot;Mã TH&quot;, width=150, anchor='center')&#10;        brand_tree.column(&quot;Tên thương hiệu&quot;, width=300, anchor='w')&#10;&#10;        scrollbar_brand = ttk.Scrollbar(tree_frame, orient=&quot;vertical&quot;, command=brand_tree.yview)&#10;        brand_tree.configure(yscrollcommand=scrollbar_brand.set)&#10;&#10;        brand_tree.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)&#10;        scrollbar_brand.pack(side=&quot;right&quot;, fill=&quot;y&quot;)&#10;&#10;        # Buttons frame&#10;        button_frame = tk.Frame(main_frame)&#10;        button_frame.pack(fill='x', pady=(10, 0))&#10;&#10;        # First row: Delete and Add buttons&#10;        buttons_row1 = tk.Frame(button_frame)&#10;        buttons_row1.pack(fill='x', pady=(0, 5))&#10;&#10;        btn_delete_brand = tk.Button(buttons_row1, text=&quot;️ Xóa thương hiệu&quot;,&#10;                                    bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                                    padx=15, pady=8, relief='raised', state='disabled',&#10;                                    cursor='hand2', bd=2)&#10;        btn_delete_brand.pack(side='left')&#10;&#10;        btn_add_brand = tk.Button(buttons_row1, text=&quot;➕ Thêm thương hiệu&quot;,&#10;                                 bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                                 padx=15, pady=8, relief='raised',&#10;                                 cursor='hand2', bd=2)&#10;        btn_add_brand.pack(side='right')&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_add_brand, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;        # Status label&#10;        status_brand_label = tk.Label(button_frame, text=&quot;Chọn thương hiệu để xóa&quot;,&#10;                                     font=('Arial', 10), fg='#7f8c8d')&#10;        status_brand_label.pack(pady=(5, 0))&#10;&#10;        # Load brand data&#10;        def load_brands():&#10;            # Clear current items&#10;            for item in brand_tree.get_children():&#10;                brand_tree.delete(item)&#10;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;                cursor.execute(&quot;SELECT MaTH, TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;                brands = cursor.fetchall()&#10;&#10;                for ma_th, ten_th in brands:&#10;                    brand_tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_th, values=(ma_th, ten_th))&#10;&#10;                status_brand_label.config(text=f&quot;Tổng số thương hiệu: {len(brands)}&quot;)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải danh sách thương hiệu: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Brand selection handler&#10;        selected_brand_id = None&#10;&#10;        def on_brand_select(event):&#10;            nonlocal selected_brand_id&#10;            selection = brand_tree.selection()&#10;&#10;            if selection:&#10;                selected_brand_id = selection[0]&#10;                btn_delete_brand.config(state='normal', bg='#e74c3c')&#10;                add_button_hover_effect(btn_delete_brand, '#e74c3c', get_hover_color('#e74c3c'))&#10;                status_brand_label.config(text=&quot;Click để xóa thương hiệu đã chọn&quot;, fg='red')&#10;            else:&#10;                selected_brand_id = None&#10;                btn_delete_brand.config(state='disabled', bg='#95a5a6')&#10;                status_brand_label.config(text=&quot;Chọn thương hiệu để xóa&quot;, fg='#7f8c8d')&#10;&#10;        brand_tree.bind(&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;, on_brand_select)&#10;&#10;        # Delete brand function&#10;        def delete_brand():&#10;            if not selected_brand_id:&#10;                return&#10;&#10;            # Get brand name for confirmation&#10;            selected_item = brand_tree.item(selected_brand_id)&#10;            brand_name = selected_item['values'][1]&#10;&#10;            result = messagebox.askyesno(&quot;Xác nhận&quot;,&#10;                                       f&quot;Bạn có chắc chắn muốn xóa thương hiệu '{brand_name}' không?\n\n&quot;&#10;                                       f&quot;Lưu ý: Tất cả sản phẩm của thương hiệu này cũng sẽ bị xóa!&quot;)&#10;            if not result:&#10;                return&#10;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Delete products of this brand first&#10;                cursor.execute(&quot;DELETE FROM url_sp WHERE MaSP IN (SELECT MaSP FROM sanpham WHERE MaTH = %s)&quot;, (selected_brand_id,))&#10;                cursor.execute(&quot;DELETE FROM sanpham WHERE MaTH = %s&quot;, (selected_brand_id,))&#10;&#10;                # Delete brand&#10;                cursor.execute(&quot;DELETE FROM thuonghieu WHERE MaTH = %s&quot;, (selected_brand_id,))&#10;&#10;                conn.commit()&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã xóa thương hiệu '{brand_name}' thành công!&quot;)&#10;&#10;                # Refresh brand list in this window&#10;                load_brands()&#10;&#10;                # Refresh the product view's brand filter&#10;                self.refresh_brand_filter()&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể xóa thương hiệu: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Add brand function&#10;        def add_brand():&#10;            # Create add brand dialog - INCREASED HEIGHT for buttons visibility&#10;            add_brand_window = tk.Toplevel(brand_window)&#10;            add_brand_window.title(&quot;Thêm thương hiệu mới&quot;)&#10;            add_brand_window.geometry(&quot;520x300&quot;)  # Increased to 520x300 - MORE SPACE!&#10;            add_brand_window.resizable(False, False)&#10;&#10;            # Center the dialog&#10;            add_brand_window.update_idletasks()&#10;            x = (add_brand_window.winfo_screenwidth() // 2) - (520 // 2)&#10;            y = (add_brand_window.winfo_screenheight() // 2) - (300 // 2)&#10;            add_brand_window.geometry(f&quot;+{x}+{y}&quot;)&#10;&#10;            # Make sure it's on top&#10;            add_brand_window.transient(brand_window)&#10;            add_brand_window.grab_set()&#10;            add_brand_window.lift()&#10;            add_brand_window.focus_force()&#10;&#10;            # MAIN CONTAINER with fixed structure&#10;            main_container = tk.Frame(add_brand_window, bg='white')&#10;            main_container.pack(fill='both', expand=True)&#10;&#10;            # TOP SECTION - Form content (NOT EXPANDABLE)&#10;            top_section = tk.Frame(main_container, bg='white')&#10;            top_section.pack(side='top', fill='x', padx=30, pady=(20, 10))&#10;&#10;            tk.Label(top_section, text=&quot;THÊM THƯƠNG HIỆU MỚI&quot;, font=('Arial', 14, 'bold'),&#10;                     fg='#27ae60', bg='white').pack(pady=(0, 15))&#10;&#10;            tk.Label(top_section, text=&quot;Tên thương hiệu:&quot;, font=('Arial', 12, 'bold'),&#10;                    bg='white').pack(anchor='w', pady=(0, 5))&#10;            entry_brand_name = tk.Entry(top_section, font=('Arial', 12), width=42)&#10;            entry_brand_name.pack(pady=(0, 10), fill='x')&#10;            entry_brand_name.focus()&#10;&#10;            # MIDDLE SPACER - Expandable to push buttons down&#10;            spacer = tk.Frame(main_container, bg='white')&#10;            spacer.pack(side='top', fill='both', expand=True)&#10;&#10;            # BOTTOM SECTION - Buttons (ALWAYS AT BOTTOM)&#10;            # Use fixed height and pack_propagate(False) to ensure buttons always visible&#10;            button_frame_add = tk.Frame(main_container, bg='white', height=70)&#10;            button_frame_add.pack(side='bottom', fill='x', padx=30, pady=(10, 20))&#10;            button_frame_add.pack_propagate(False)  # CRITICAL: Prevent shrinking!&#10;&#10;            # Create inner container for buttons with padding&#10;            buttons_container = tk.Frame(button_frame_add, bg='white')&#10;            buttons_container.pack(fill='both', expand=True, pady=10)&#10;&#10;            def save_brand():&#10;                brand_name = entry_brand_name.get().strip()&#10;                if not brand_name:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng nhập tên thương hiệu!&quot;)&#10;                    return&#10;&#10;                try:&#10;                    conn = get_db_connection()&#10;                    cursor = conn.cursor()&#10;&#10;                    # Check if brand already exists&#10;                    cursor.execute(&quot;SELECT MaTH FROM thuonghieu WHERE TenTH = %s&quot;, (brand_name,))&#10;                    if cursor.fetchone():&#10;                        messagebox.showerror(&quot;Lỗi&quot;, f&quot;Thương hiệu '{brand_name}' đã tồn tại!&quot;)&#10;                        return&#10;&#10;                    # Generate new brand ID&#10;                    cursor.execute(&quot;SELECT MAX(CAST(SUBSTRING(MaTH, 3) AS UNSIGNED)) FROM thuonghieu WHERE MaTH LIKE 'TH%'&quot;)&#10;                    result = cursor.fetchone()&#10;                    next_number = ((result[0] or 0) + 1) if result and result[0] is not None else 1&#10;                    brand_id = f&quot;TH{next_number:03d}&quot;&#10;&#10;                    # Insert brand&#10;                    cursor.execute(&quot;INSERT INTO thuonghieu (MaTH, TenTH) VALUES (%s, %s)&quot;, (brand_id, brand_name))&#10;                    conn.commit()&#10;&#10;                    messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm thương hiệu '{brand_name}' thành công!&quot;)&#10;                    add_brand_window.destroy()&#10;&#10;                    # Refresh brand list in this window&#10;                    load_brands()&#10;&#10;                    # Refresh the product view's brand filter&#10;                    self.refresh_brand_filter()&#10;&#10;                except Exception as e:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể thêm thương hiệu: {str(e)}&quot;)&#10;                finally:&#10;                    if cursor:&#10;                        cursor.close()&#10;                    if conn:&#10;                        conn.close()&#10;&#10;            # Save and Cancel buttons with hover effects&#10;            # Pack into buttons_container (not button_frame_add directly)&#10;            btn_save_brand = tk.Button(buttons_container, text=&quot; Lưu&quot;, command=save_brand,&#10;                                      bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                                      padx=25, pady=8, cursor='hand2', relief='raised', bd=2)&#10;            btn_save_brand.pack(side='left', padx=5)&#10;            add_button_hover_effect(btn_save_brand, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;            btn_cancel_brand = tk.Button(buttons_container, text=&quot;❌ Hủy&quot;, command=add_brand_window.destroy,&#10;                                        bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                                        padx=25, pady=8, cursor='hand2', relief='raised', bd=2)&#10;            btn_cancel_brand.pack(side='left', padx=5)&#10;            add_button_hover_effect(btn_cancel_brand, '#e74c3c', get_hover_color('#e74c3c'))&#10;&#10;            # Enter key to save&#10;            entry_brand_name.bind('&lt;Return&gt;', lambda e: save_brand())&#10;&#10;        # Bind button functions&#10;        btn_delete_brand.config(command=delete_brand)&#10;        btn_add_brand.config(command=add_brand)&#10;&#10;        # Load initial data&#10;        load_brands()&#10;&#10;    def set_show_cart_callback(self, callback):&#10;        &quot;&quot;&quot;Set callback for showing cart&quot;&quot;&quot;&#10;        self.show_cart_callback = callback&#10;&#10;    def set_show_invoice_history_callback(self, callback):&#10;        &quot;&quot;&quot;Set callback for showing invoice history&quot;&quot;&quot;&#10;        self.show_invoice_history = callback&#10;&#10;    def set_logout_callback(self, callback):&#10;        &quot;&quot;&quot;Set logout callback&quot;&quot;&quot;&#10;        self.logout_callback = callback&#10;&#10;def load_thumbnail_image(path_or_url):&#10;    &quot;&quot;&quot;Load thumbnail image 70x70 - from main.py&quot;&quot;&quot;&#10;    source = (path_or_url or &quot;&quot;).strip()&#10;    if not source:&#10;        return None&#10;&#10;    image = None&#10;    try:&#10;        if source.lower().startswith((&quot;http://&quot;, &quot;https://&quot;)):&#10;            headers = {&#10;                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'&#10;            }&#10;            req = urllib.request.Request(source, headers=headers)&#10;            with urllib.request.urlopen(req, timeout=10) as response:&#10;                if response.getcode() != 200:&#10;                    return None&#10;                raw_data = response.read()&#10;            with Image.open(io.BytesIO(raw_data)) as img:&#10;                image = img.copy()&#10;        else:&#10;            candidate_paths = []&#10;            if os.path.isabs(source):&#10;                candidate_paths.append(source)&#10;            else:&#10;                candidate_paths.append(os.path.join(LOCAL_IMAGE_DIR, source))&#10;                candidate_paths.append(os.path.join(BASE_DIR, source))&#10;&#10;            for file_path in candidate_paths:&#10;                if os.path.isfile(file_path):&#10;                    with Image.open(file_path) as img:&#10;                        image = img.copy()&#10;                    break&#10;&#10;            if image is None:&#10;                return None&#10;&#10;        if image.mode in ('RGBA', 'P'):&#10;            image = image.convert('RGB')&#10;&#10;        # Resize to thumbnail size&#10;        image = image.resize((70, 70), Image.Resampling.LANCZOS)&#10;        return ImageTk.PhotoImage(image)&#10;&#10;    except Exception as e:&#10;        print(f&quot;Error loading thumbnail from {source}: {e}&quot;)&#10;        return None&#10;" />
              <option name="updatedContent" value="&quot;&quot;&quot;&#10;Product View - matches main.py structure exactly&#10;&quot;&quot;&quot;&#10;import tkinter as tk&#10;from tkinter import messagebox, ttk, filedialog&#10;from PIL import Image, ImageTk&#10;import urllib.request&#10;import io&#10;import os&#10;from config.database import get_db_connection, BASE_DIR, LOCAL_IMAGE_DIR&#10;from utils.image_utils import load_image_safely, load_thumbnail_image, save_uploaded_image, insert_uploaded_image_to_db&#10;from utils.ui_effects import add_button_hover_effect, COLORS, get_hover_color&#10;&#10;class ProductView:&#10;    def __init__(self, root):&#10;        self.root = root&#10;        self.brand_combo = None  # Store reference to brand combo for refreshing&#10;&#10;    def get_cart_count_from_db(self, username):&#10;        &quot;&quot;&quot;Get cart count from database - giohangchuasanpham&quot;&quot;&quot;&#10;        if not username:&#10;            return 0&#10;&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;&#10;            cursor.execute(&quot;SELECT MaKH FROM khachhang WHERE TenDN = %s&quot;, (username,))&#10;            result = cursor.fetchone()&#10;            if not result:&#10;                return 0&#10;&#10;            ma_kh = result[0]&#10;&#10;            cursor.execute(&quot;SELECT SUM(SoLuong) FROM giohangchuasanpham WHERE MaKH = %s&quot;, (ma_kh,))&#10;            count_result = cursor.fetchone()&#10;            return count_result[0] if count_result and count_result[0] else 0&#10;        except Exception as e:&#10;            print(f&quot;❌ Error getting cart count: {e}&quot;)&#10;            return 0&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;    def refresh_brand_filter(self):&#10;        &quot;&quot;&quot;Refresh the brand filter dropdown with updated data - moved to class level&quot;&quot;&quot;&#10;        if not self.brand_combo:&#10;            return&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;            cursor.execute(&quot;SELECT DISTINCT TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands = [&quot;Tất cả&quot;] + [row[0] for row in cursor.fetchall()]&#10;            self.brand_combo['values'] = brands&#10;            print(f&quot;Debug: Brand filter updated with {len(brands)-1} brands&quot;)&#10;        except Exception as e:&#10;            print(f&quot;Error refreshing brand filter: {e}&quot;)&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;    def show_sales_view(self, role, username):&#10;        &quot;&quot;&quot;Show sales statistics view&quot;&quot;&quot;&#10;        from views.sales_view import SalesView&#10;        sales_view = SalesView(self.root)&#10;        sales_view.show(role, username, lambda: self.show_shoes(role, username))&#10;&#10;    def show_shoes(self, role=None, username=None):&#10;        &quot;&quot;&quot;Show product list - from main.py&quot;&quot;&quot;&#10;        for widget in self.root.winfo_children():&#10;            widget.destroy()&#10;&#10;        self.root.title(&quot;Shop Shoes - Danh sách sản phẩm&quot;)&#10;        self.root.geometry(&quot;1200x750&quot;)&#10;&#10;        header_frame = tk.Frame(self.root, bg='#2c3e50', height=60)&#10;        header_frame.pack(fill='x')&#10;        header_frame.pack_propagate(False)&#10;&#10;        header_container = tk.Frame(header_frame, bg='#2c3e50')&#10;        header_container.pack(fill='both', expand=True, padx=10)&#10;&#10;        tk.Label(header_container, text=&quot;SHOP GIÀY&quot;, font=('Arial', 20, 'bold'),&#10;                 fg='white', bg='#2c3e50').pack(side='left', pady=15)&#10;&#10;        # Role-specific buttons&#10;        if role == &quot;buyer&quot;:&#10;            # Cart button for buyers&#10;            def update_cart_button():&#10;                &quot;&quot;&quot;Calculate cart count from database giohangchuasanpham&quot;&quot;&quot;&#10;                cart_count = self.get_cart_count_from_db(username)&#10;                return f&quot; Giỏ hàng ({cart_count})&quot;&#10;&#10;&#10;            btn_cart = tk.Button(header_container, text=update_cart_button(),&#10;                                command=lambda: self.show_cart_callback(username, role) if hasattr(self, 'show_cart_callback') else None,&#10;                                bg='#f39c12', fg='white', relief='flat',&#10;                                font=('Arial', 12, 'bold'), padx=15, pady=5, cursor='hand2', bd=2)&#10;            btn_cart.pack(side='right', pady=15, padx=(0, 10))&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_cart, '#f39c12', get_hover_color('#f39c12'))&#10;&#10;            # Invoice history button for buyers&#10;            btn_history = tk.Button(header_container, text=&quot; Lịch sử&quot;,&#10;                                   command=lambda: self.show_invoice_history(role, username) if hasattr(self, 'show_invoice_history') else None,&#10;                                   bg='#9b59b6', fg='white', relief='flat',&#10;                                   font=('Arial', 12, 'bold'), padx=15, pady=5, cursor='hand2', bd=2)&#10;            btn_history.pack(side='right', pady=15, padx=(0, 10))&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_history, '#9b59b6', get_hover_color('#9b59b6'))&#10;        else:&#10;            # No product management button in header for sellers anymore&#10;            pass&#10;&#10;        btn_logout = tk.Button(header_container, text=&quot;Đăng xuất&quot;,&#10;                              command=lambda: self.logout_callback() if hasattr(self, 'logout_callback') else None,&#10;                              bg='#e74c3c', fg='white', relief='flat',&#10;                              font=('Arial', 15), padx=15, pady=5, cursor='hand2', bd=2)&#10;        btn_logout.pack(side='right', pady=15)&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_logout, '#e74c3c', get_hover_color('#e74c3c'))&#10;&#10;        if username:&#10;            role_label = &quot;Người bán&quot; if role == &quot;seller&quot; else &quot;Khách hàng&quot;&#10;            tk.Label(header_container, text=f&quot;{role_label}: {username}&quot;,&#10;                     font=('Arial', 14), fg='white', bg='#2c3e50').pack(side='right', pady=15, padx=(0, 15))&#10;&#10;        # Search and Filter Frame&#10;        search_frame = tk.Frame(self.root, bg='#ecf0f1', height=80)&#10;        search_frame.pack(fill='x', padx=10, pady=(5, 0))&#10;        search_frame.pack_propagate(False)&#10;&#10;        # Search bar&#10;        search_container = tk.Frame(search_frame, bg='#ecf0f1')&#10;        search_container.pack(side='left', fill='y', pady=10)&#10;&#10;        tk.Label(search_container, text=&quot;Tìm kiếm:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#ecf0f1').pack(side='left', padx=(10, 5))&#10;&#10;        search_var = tk.StringVar()&#10;        search_entry = tk.Entry(search_container, textvariable=search_var, font=('Arial', 12), width=25)&#10;        search_entry.pack(side='left', padx=5)&#10;&#10;        btn_search = tk.Button(search_container, text=&quot;&quot;,&#10;                              bg='#3498db', fg='white', font=('Arial', 12, 'bold'),&#10;                              padx=10, cursor='hand2', relief='raised', bd=2)&#10;        btn_search.pack(side='left', padx=5)&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_search, '#3498db', get_hover_color('#3498db'))&#10;&#10;        # Sales statistics button for sellers&#10;        if role == &quot;seller&quot;:&#10;            btn_sales = tk.Button(search_container, text=&quot; Doanh thu&quot;,&#10;                                 bg='#9b59b6', fg='white', font=('Arial', 12, 'bold'),&#10;                                 padx=15, pady=5, relief='raised', cursor='hand2', bd=2,&#10;                                 command=lambda: self.show_sales_view(role, username))&#10;            btn_sales.pack(side='left', padx=10)&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_sales, '#9b59b6', get_hover_color('#9b59b6'))&#10;&#10;        # Filter frame&#10;        filter_container = tk.Frame(search_frame, bg='#ecf0f1')&#10;        filter_container.pack(side='right', fill='y', pady=10, padx=(0, 10))&#10;&#10;        # Brand filter&#10;        tk.Label(filter_container, text=&quot;Thương hiệu:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#ecf0f1').pack(side='left', padx=(10, 5))&#10;&#10;        brand_var = tk.StringVar(value=&quot;Tất cả&quot;)&#10;        brand_combo = ttk.Combobox(filter_container, textvariable=brand_var, width=12, state='readonly',&#10;                                  font=('Arial', 11))&#10;        brand_combo.pack(side='left', padx=5)&#10;&#10;        # Store reference to brand combo for refreshing&#10;        self.brand_combo = brand_combo&#10;&#10;        # Price filter&#10;        tk.Label(filter_container, text=&quot;Giá:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#ecf0f1').pack(side='left', padx=(10, 5))&#10;&#10;        price_var = tk.StringVar(value=&quot;Tất cả&quot;)&#10;        price_combo = ttk.Combobox(filter_container, textvariable=price_var, width=12, state='readonly',&#10;                                  font=('Arial', 11), values=[&quot;Tất cả&quot;, &quot;Dưới 500k&quot;, &quot;500k - 1tr&quot;, &quot;1tr - 2tr&quot;, &quot;Trên 2tr&quot;])&#10;        price_combo.pack(side='left', padx=5)&#10;&#10;        btn_filter = tk.Button(filter_container, text=&quot;Lọc&quot;,&#10;                              bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                              padx=10, cursor='hand2', relief='raised', bd=2)&#10;        btn_filter.pack(side='left', padx=5)&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_filter, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;        # Load product data and images&#10;        all_products = []&#10;        product_images = {}&#10;        conn = None&#10;        cursor = None&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;&#10;            # Get product info with brand, import date and discount for price calculation&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT sp.MaSP, sp.TenSP, sp.Gia, sp.MoTa, th.TenTH, sp.SoLuong, sp.NgayNhapHang, sp.GiamGia&#10;                FROM sanpham sp&#10;                LEFT JOIN thuonghieu th ON sp.MaTH = th.MaTH&#10;                ORDER BY sp.MaSP&#10;            &quot;&quot;&quot;)&#10;            all_products = cursor.fetchall()&#10;&#10;            # AUTO-UPDATE GiamGia based on NgayNhapHang (stock age)&#10;            from datetime import datetime&#10;            current_date = datetime.now()&#10;&#10;            for ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia_current in all_products:&#10;                if ngay_nhap_hang and so_luong &gt; 0:  # Only for products with stock &gt; 0 (IN STOCK)&#10;                    try:&#10;                        # Calculate months difference&#10;                        import_date = ngay_nhap_hang if isinstance(ngay_nhap_hang, datetime) else datetime.strptime(str(ngay_nhap_hang), '%Y-%m-%d')&#10;                        months_old = (current_date.year - import_date.year) * 12 + (current_date.month - import_date.month)&#10;&#10;                        # Determine discount based on age&#10;                        new_discount = 0&#10;                        if months_old &gt;= 12:&#10;                            new_discount = 15  # 15% for 12+ months&#10;                        elif months_old &gt;= 6:&#10;                            new_discount = 10  # 10% for 6+ months&#10;&#10;                        # Update database if discount changed&#10;                        if new_discount != giam_gia_current:&#10;                            cursor.execute(&quot;&quot;&quot;&#10;                                UPDATE sanpham SET GiamGia = %s WHERE MaSP = %s&#10;                            &quot;&quot;&quot;, (new_discount, ma_sp))&#10;                            print(f&quot;Auto-updated discount for {ma_sp}: {giam_gia_current}% -&gt; {new_discount}% (age: {months_old} months)&quot;)&#10;                    except Exception as e:&#10;                        print(f&quot;Error auto-updating discount for {ma_sp}: {e}&quot;)&#10;                        pass&#10;&#10;            # Commit discount updates&#10;            conn.commit()&#10;&#10;            # Re-fetch products with updated discounts&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT sp.MaSP, sp.TenSP, sp.Gia, sp.MoTa, th.TenTH, sp.SoLuong, sp.NgayNhapHang, sp.GiamGia&#10;                FROM sanpham sp&#10;                LEFT JOIN thuonghieu th ON sp.MaTH = th.MaTH&#10;                ORDER BY sp.MaSP&#10;            &quot;&quot;&quot;)&#10;            all_products = cursor.fetchall()&#10;&#10;            # Get brand list for combobox&#10;            cursor.execute(&quot;SELECT DISTINCT TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands = [&quot;Tất cả&quot;] + [row[0] for row in cursor.fetchall()]&#10;            brand_combo['values'] = brands&#10;&#10;            # Get all images for each product&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT MaSP, URLAnh&#10;                FROM url_sp&#10;                ORDER BY MaSP&#10;            &quot;&quot;&quot;)&#10;            image_rows = cursor.fetchall()&#10;&#10;            # Organize images by product&#10;            for ma_sp, url_anh in image_rows:&#10;                if ma_sp not in product_images:&#10;                    product_images[ma_sp] = []&#10;                product_images[ma_sp].append(url_anh)&#10;&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải dữ liệu: {str(e)}&quot;)&#10;            return&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        main_frame = tk.Frame(self.root)&#10;        main_frame.pack(fill='both', expand=True, padx=10, pady=5)&#10;&#10;        # Left panel: Product list&#10;        list_frame = tk.Frame(main_frame, width=400)&#10;        list_frame.pack(side='left', fill='y', padx=(0, 10))&#10;        list_frame.pack_propagate(False)&#10;&#10;        tk.Label(list_frame, text=&quot;Danh sách giày&quot;, font=('Arial', 18, 'bold')).pack(anchor='w', pady=(0, 10))&#10;&#10;        tree_frame = tk.Frame(list_frame)&#10;        tree_frame.pack(fill='both', expand=True)&#10;&#10;        # Configure style for larger fonts in Treeview&#10;        style = ttk.Style()&#10;        style.configure(&quot;Custom.Treeview&quot;, font=('Arial', 11))&#10;        style.configure(&quot;Custom.Treeview.Heading&quot;, font=('Arial', 12, 'bold'))&#10;&#10;        # Add quantity column for sellers&#10;        if role == &quot;seller&quot;:&#10;            tree = ttk.Treeview(tree_frame, columns=(&quot;Mã SP&quot;, &quot;Tên&quot;, &quot;Giá&quot;, &quot;SL&quot;), show=&quot;headings&quot;, height=8, style=&quot;Custom.Treeview&quot;)&#10;            tree.heading(&quot;Mã SP&quot;, text=&quot;Mã SP&quot;)&#10;            tree.heading(&quot;Tên&quot;, text=&quot;Tên giày&quot;)&#10;            tree.heading(&quot;Giá&quot;, text=&quot;Giá&quot;)&#10;            tree.heading(&quot;SL&quot;, text=&quot;SL&quot;)&#10;            tree.column(&quot;Mã SP&quot;, width=80)&#10;            tree.column(&quot;Tên&quot;, width=140)&#10;            tree.column(&quot;Giá&quot;, width=120, anchor='e')&#10;            tree.column(&quot;SL&quot;, width=50, anchor='e')&#10;        else:&#10;            # Enable multiple selection for buyers&#10;            tree = ttk.Treeview(tree_frame, columns=(&quot;Mã SP&quot;, &quot;Tên&quot;, &quot;Giá&quot;), show=&quot;headings&quot;, height=8,&#10;                               style=&quot;Custom.Treeview&quot;, selectmode='extended')&#10;            tree.heading(&quot;Mã SP&quot;, text=&quot;Mã SP&quot;)&#10;            tree.heading(&quot;Tên&quot;, text=&quot;Tên giày&quot;)&#10;            tree.heading(&quot;Giá&quot;, text=&quot;Giá&quot;)&#10;            tree.column(&quot;Mã SP&quot;, width=80)&#10;            tree.column(&quot;Tên&quot;, width=160)&#10;            tree.column(&quot;Giá&quot;, width=130, anchor='e')&#10;&#10;        scrollbar = ttk.Scrollbar(tree_frame, orient=&quot;vertical&quot;, command=tree.yview)&#10;        tree.configure(yscrollcommand=scrollbar.set)&#10;&#10;        tree.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)&#10;        scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;)&#10;&#10;        # Action button frame&#10;        action_button_frame = tk.Frame(list_frame)&#10;        action_button_frame.pack(fill='x', pady=(5, 0))&#10;&#10;        if role == &quot;buyer&quot;:&#10;            # Add to cart button for buyers&#10;            btn_add_to_cart = tk.Button(action_button_frame, text=&quot;➕ Thêm vào giỏ hàng&quot;,&#10;                                       bg='#95a5a6', fg='white', font=('Arial', 12, 'bold'),&#10;                                       padx=10, pady=8, relief='raised', state='disabled',&#10;                                       cursor='hand2', bd=2)&#10;            btn_add_to_cart.pack(anchor='w', pady=5)&#10;&#10;&#10;            status_label = tk.Label(action_button_frame, text=&quot;Chọn sản phẩm để kích hoạt nút&quot;,&#10;                                   font=('Arial', 10), fg='#7f8c8d')&#10;            status_label.pack(anchor='w', pady=(10, 0))&#10;        else:&#10;            # Product management buttons frame for sellers - FIXED BUTTON ALIGNMENT&#10;            # First row: Delete and Add buttons (centered and same size)&#10;            buttons_row1_frame = tk.Frame(action_button_frame)&#10;            buttons_row1_frame.pack(fill='x', pady=(5, 2))&#10;&#10;            # Create a container for centering the buttons&#10;            center_container1 = tk.Frame(buttons_row1_frame)&#10;            center_container1.pack(anchor='center')&#10;&#10;            # STANDARDIZED BUTTON PARAMETERS - All buttons exactly the same&#10;            BUTTON_FONT = ('Arial', 11, 'bold')&#10;            BUTTON_PADX = 10&#10;            BUTTON_PADY = 8&#10;            BUTTON_WIDTH = 16  # Fixed width for all buttons&#10;            BUTTON_SPACING = 10  # Consistent spacing between buttons&#10;&#10;            # Delete product button (left in center container)&#10;            btn_delete_product = tk.Button(center_container1, text=&quot;️ Xóa sản phẩm&quot;,&#10;                                          bg='#e74c3c', fg='white', font=BUTTON_FONT,&#10;                                          padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised', state='disabled',&#10;                                          cursor='hand2', bd=2, width=BUTTON_WIDTH)&#10;            btn_delete_product.pack(side='left', padx=(0, BUTTON_SPACING))&#10;&#10;            # Add product button (right in center container)&#10;            btn_add_product = tk.Button(center_container1, text=&quot;➕ Thêm sản phẩm&quot;,&#10;                                       bg='#27ae60', fg='white', font=BUTTON_FONT,&#10;                                       padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised',&#10;                                       cursor='hand2', bd=2, width=BUTTON_WIDTH,&#10;                                       command=lambda: self.show_add_product_form(role, username))&#10;            btn_add_product.pack(side='right')&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_add_product, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;            # Second row: Edit and Brand buttons (centered and same size)&#10;            buttons_row2_frame = tk.Frame(action_button_frame)&#10;            buttons_row2_frame.pack(fill='x', pady=(2, 5))&#10;&#10;            # Create a container for centering the buttons&#10;            center_container2 = tk.Frame(buttons_row2_frame)&#10;            center_container2.pack(anchor='center')&#10;&#10;            # Edit product button (left in center container)&#10;            btn_edit_product = tk.Button(center_container2, text=&quot;✏️ Sửa sản phẩm&quot;,&#10;                                        bg='#f39c12', fg='white', font=BUTTON_FONT,&#10;                                        padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised', state='disabled',&#10;                                        cursor='hand2', bd=2, width=BUTTON_WIDTH)&#10;            btn_edit_product.pack(side='left', padx=(0, BUTTON_SPACING))&#10;&#10;            # Brand management button (right in center container)&#10;            btn_brand_management = tk.Button(center_container2, text=&quot;️ Thương hiệu&quot;,&#10;                                           bg='#9b59b6', fg='white', font=BUTTON_FONT,&#10;                                           padx=BUTTON_PADX, pady=BUTTON_PADY, relief='raised',&#10;                                           cursor='hand2', bd=2, width=BUTTON_WIDTH,&#10;                                           command=lambda: self.show_brand_management(role, username))&#10;            btn_brand_management.pack(side='right')&#10;            # Add hover effect&#10;            add_button_hover_effect(btn_brand_management, '#9b59b6', get_hover_color('#9b59b6'))&#10;&#10;            status_label = tk.Label(action_button_frame, text=&quot;Chọn sản phẩm để xóa hoặc sửa&quot;,&#10;                                   font=('Arial', 10), fg='#7f8c8d')&#10;            status_label.pack(anchor='w')&#10;&#10;        # Functions&#10;        def refresh_brand_filter():&#10;            &quot;&quot;&quot;Refresh the brand filter dropdown with updated data&quot;&quot;&quot;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;                cursor.execute(&quot;SELECT DISTINCT TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;                brands = [&quot;Tất cả&quot;] + [row[0] for row in cursor.fetchall()]&#10;                brand_combo['values'] = brands&#10;                print(f&quot;Debug: Brand filter updated with {len(brands)-1} brands&quot;)&#10;            except Exception as e:&#10;                print(f&quot;Error refreshing brand filter: {e}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        def show_multi_product_cart_dialog(selected_products):&#10;            &quot;&quot;&quot;Show dialog for adding multiple products to cart with color, size, and quantity options&quot;&quot;&quot;&#10;            if not selected_products:&#10;                return&#10;&#10;            # Create scrollable dialog with larger size&#10;            dialog = tk.Toplevel(self.root)&#10;            dialog.title(f&quot;Thêm {len(selected_products)} sản phẩm vào giỏ hàng&quot;)&#10;            dialog.geometry(&quot;800x650&quot;)  # Increased width from 650 to 800&#10;            dialog.resizable(False, False)&#10;            dialog.grab_set()&#10;            dialog.transient(self.root)&#10;&#10;            # Center dialog on screen&#10;            dialog.update_idletasks()&#10;            x = (dialog.winfo_screenwidth() // 2) - (800 // 2)&#10;            y = (dialog.winfo_screenheight() // 2) - (650 // 2)&#10;            dialog.geometry(f&quot;+{x}+{y}&quot;)&#10;&#10;            # Header&#10;            header = tk.Frame(dialog, bg='#3498db', height=60)&#10;            header.pack(fill='x')&#10;            header.pack_propagate(False)&#10;&#10;            tk.Label(header, text=f&quot; Cấu hình {len(selected_products)} sản phẩm&quot;,&#10;                    font=('Arial', 16, 'bold'), bg='#3498db', fg='white').pack(pady=15)&#10;&#10;            # Main content frame (to contain scrollable area)&#10;            content_frame = tk.Frame(dialog, bg='#f0f0f0')&#10;            content_frame.pack(fill='both', expand=True)&#10;&#10;            # Create scrollable frame for products - CENTERED&#10;            scroll_container = tk.Frame(content_frame, bg='#f0f0f0')&#10;            scroll_container.pack(fill='both', expand=True, padx=20, pady=10)&#10;&#10;            canvas = tk.Canvas(scroll_container, bg='white', highlightthickness=0)&#10;            scrollbar = tk.Scrollbar(scroll_container, orient=&quot;vertical&quot;, command=canvas.yview)&#10;            scrollable_frame = tk.Frame(canvas, bg='white')&#10;&#10;            scrollable_frame.bind(&#10;                &quot;&lt;Configure&gt;&quot;,&#10;                lambda e: canvas.configure(scrollregion=canvas.bbox(&quot;all&quot;))&#10;            )&#10;&#10;            # Center the content in canvas&#10;            canvas_frame = canvas.create_window((0, 0), window=scrollable_frame, anchor=&quot;n&quot;)&#10;&#10;            # Update canvas width to center content&#10;            def update_canvas_width(event):&#10;                canvas_width = event.width&#10;                canvas.itemconfig(canvas_frame, width=canvas_width)&#10;&#10;            canvas.bind('&lt;Configure&gt;', update_canvas_width)&#10;            canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;            # Pack canvas and scrollbar&#10;            canvas.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)&#10;            scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;)&#10;&#10;            # Enable mousewheel scrolling&#10;            def _on_mousewheel(event):&#10;                canvas.yview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;            dialog.bind_all(&quot;&lt;MouseWheel&gt;&quot;, _on_mousewheel)&#10;&#10;            # Store product configurations&#10;            product_configs = {}&#10;&#10;            # Create configuration for each product - CENTERED with better width&#10;            for idx, product_id in enumerate(selected_products):&#10;                if product_id not in product_data:&#10;                    continue&#10;&#10;                product = product_data[product_id]&#10;&#10;                # Product frame - wider and centered&#10;                product_frame = tk.Frame(scrollable_frame, bg='white', relief='solid', bd=2, width=700)&#10;                product_frame.pack(padx=30, pady=10, fill='x')&#10;&#10;                # Product header&#10;                header_frame = tk.Frame(product_frame, bg='#ecf0f1')&#10;                header_frame.pack(fill='x')&#10;&#10;                tk.Label(header_frame, text=f&quot;{idx + 1}. {product['name']}&quot;,&#10;                        font=('Arial', 13, 'bold'), bg='#ecf0f1', fg='#2c3e50').pack(anchor='w', padx=10, pady=8)&#10;&#10;                # Price info&#10;                price_text = product['price']&#10;                if product.get('discount', 0) &gt; 0:&#10;                    discounted_price = product['original_price'] * (1 - product['discount'] / 100)&#10;                    price_text = f&quot;{discounted_price:,.0f} VNĐ (-{product['discount']}%)&quot;&#10;&#10;                tk.Label(header_frame, text=price_text,&#10;                        font=('Arial', 11), bg='#ecf0f1', fg='#27ae60').pack(anchor='w', padx=10, pady=(0, 8))&#10;&#10;                # Configuration frame&#10;                config_frame = tk.Frame(product_frame, bg='white')&#10;                config_frame.pack(fill='x', padx=15, pady=15)&#10;&#10;                # Color selection&#10;                color_label_frame = tk.Frame(config_frame, bg='white')&#10;                color_label_frame.pack(fill='x', pady=(0, 8))&#10;&#10;                tk.Label(color_label_frame, text=&quot;Màu sắc:&quot;, font=('Arial', 11, 'bold'),&#10;                        bg='white').pack(side='left')&#10;&#10;                # Get colors from database&#10;                try:&#10;                    conn = get_db_connection()&#10;                    cursor = conn.cursor()&#10;                    cursor.execute(&quot;SELECT MauSac FROM mausac_sp WHERE MaSP = %s&quot;, (product_id,))&#10;                    colors = [row[0] for row in cursor.fetchall()]&#10;                    if not colors:&#10;                        colors = [&quot;Trắng&quot;, &quot;Xanh Dương&quot;, &quot;Đen&quot;, &quot;Nâu&quot;]&#10;                except:&#10;                    colors = [&quot;Trắng&quot;, &quot;Xanh Dương&quot;, &quot;Đen&quot;, &quot;Nâu&quot;]&#10;                finally:&#10;                    if 'cursor' in locals() and cursor:&#10;                        cursor.close()&#10;                    if 'conn' in locals() and conn:&#10;                        conn.close()&#10;&#10;                color_var = tk.StringVar(value=colors[0])&#10;                color_combo = ttk.Combobox(config_frame, textvariable=color_var, width=25,&#10;                                          state='readonly', font=('Arial', 11), values=colors)&#10;                color_combo.pack(fill='x', pady=(0, 8))&#10;&#10;                # Size selection&#10;                size_label_frame = tk.Frame(config_frame, bg='white')&#10;                size_label_frame.pack(fill='x', pady=(0, 8))&#10;&#10;                tk.Label(size_label_frame, text=&quot;Kích cỡ:&quot;, font=('Arial', 11, 'bold'),&#10;                        bg='white').pack(side='left')&#10;&#10;                # Get sizes from database&#10;                try:&#10;                    conn = get_db_connection()&#10;                    cursor = conn.cursor()&#10;                    cursor.execute(&quot;SELECT Size FROM size_sp WHERE MaSP = %s ORDER BY CAST(Size AS UNSIGNED)&quot;, (product_id,))&#10;                    sizes = [row[0] for row in cursor.fetchall()]&#10;                    if not sizes:&#10;                        sizes = [str(i) for i in range(36, 46)]&#10;                except:&#10;                    sizes = [str(i) for i in range(36, 46)]&#10;                finally:&#10;                    if 'cursor' in locals() and cursor:&#10;                        cursor.close()&#10;                    if 'conn' in locals() and conn:&#10;                        conn.close()&#10;&#10;                size_var = tk.StringVar(value=sizes[0] if sizes else &quot;42&quot;)&#10;                size_combo = ttk.Combobox(config_frame, textvariable=size_var, width=25,&#10;                                         state='readonly', font=('Arial', 11),&#10;                                         values=sizes)&#10;                size_combo.pack(fill='x', pady=(0, 8))&#10;&#10;                # Quantity selection&#10;                qty_label_frame = tk.Frame(config_frame, bg='white')&#10;                qty_label_frame.pack(fill='x', pady=(0, 8))&#10;&#10;                tk.Label(qty_label_frame, text=f&quot;Số lượng (Còn: {product['quantity']}):&quot;,&#10;                        font=('Arial', 11, 'bold'), bg='white').pack(side='left')&#10;&#10;                qty_var = tk.IntVar(value=1)&#10;                qty_spin = tk.Spinbox(config_frame, from_=1, to=product['quantity'],&#10;                                     textvariable=qty_var, width=23, font=('Arial', 11),&#10;                                     justify='center')&#10;                qty_spin.pack(fill='x')&#10;&#10;                # Store configuration&#10;                product_configs[product_id] = {&#10;                    'name': product['name'],&#10;                    'color_var': color_var,&#10;                    'size_var': size_var,&#10;                    'qty_var': qty_var,&#10;                    'max_qty': product['quantity']&#10;                }&#10;&#10;            # Button frame (FIXED at bottom like seller's add product)&#10;            button_frame = tk.Frame(dialog, bg='white', relief='ridge', bd=1, height=70)&#10;            button_frame.pack(side='bottom', fill='x')&#10;            button_frame.pack_propagate(False)&#10;&#10;            def add_all_to_cart():&#10;                &quot;&quot;&quot;Add all configured products to cart&quot;&quot;&quot;&#10;                added_count = 0&#10;                errors = []&#10;&#10;                for product_id, config in product_configs.items():&#10;                    try:&#10;                        color = config['color_var'].get()&#10;                        size = config['size_var'].get()&#10;                        qty = config['qty_var'].get()&#10;&#10;                        if qty &lt;= 0 or qty &gt; config['max_qty']:&#10;                            errors.append(f&quot;{config['name']}: Số lượng không hợp lệ&quot;)&#10;                            continue&#10;&#10;                        # Add to cart using existing function&#10;                        add_to_cart_with_quantity(product_id, config['name'], color, size, qty)&#10;                        added_count += 1&#10;&#10;                    except Exception as e:&#10;                        errors.append(f&quot;{config['name']}: {str(e)}&quot;)&#10;&#10;                # Unbind mousewheel before closing&#10;                dialog.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;                dialog.destroy()&#10;&#10;                # Show result&#10;                if added_count &gt; 0:&#10;                    btn_cart.config(text=update_cart_button())&#10;&#10;                # if errors:&#10;                #     messagebox.showwarning(&quot;Cảnh báo&quot;,&#10;                #         f&quot;Đã thêm {added_count}/{len(product_configs)} sản phẩm.\n\nLỗi:\n&quot; + &quot;\n&quot;.join(errors[:3]))&#10;                # else:&#10;                #     messagebox.showinfo(&quot;Thành công&quot;,&#10;                #         f&quot;Đã thêm {added_count} sản phẩm vào giỏ hàng!&quot;)&#10;&#10;            def cancel_dialog():&#10;                dialog.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;                dialog.destroy()&#10;&#10;            # Add buttons - FIXED AT BOTTOM LEFT AND RIGHT&#10;            btn_add_all = tk.Button(button_frame, text=&quot;✅ Thêm tất cả vào giỏ&quot;, command=add_all_to_cart,&#10;                                   bg='#27ae60', fg='white', font=('Arial', 13, 'bold'),&#10;                                   padx=30, pady=10, cursor='hand2', relief='raised', bd=2)&#10;            btn_add_all.pack(side='left', padx=20, pady=15)&#10;            add_button_hover_effect(btn_add_all, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;            btn_cancel = tk.Button(button_frame, text=&quot;❌ Hủy bỏ&quot;, command=cancel_dialog,&#10;                                  bg='#e74c3c', fg='white', font=('Arial', 13, 'bold'),&#10;                                  padx=30, pady=10, cursor='hand2', relief='raised', bd=2)&#10;            btn_cancel.pack(side='right', padx=20, pady=15)&#10;            add_button_hover_effect(btn_cancel, '#e74c3c', get_hover_color('#e74c3c'))&#10;&#10;        # OLD add_to_cart function - NO LONGER USED&#10;        # This function is replaced by show_multi_product_cart_dialog&#10;        # Keeping it commented for reference only&#10;        '''&#10;        def add_to_cart(ma_sp, ten_sp):&#10;            # This function used color_var and size_var which are removed&#10;            # Now using dialog system instead&#10;            pass&#10;        '''&#10;&#10;        def add_to_cart_with_quantity(ma_sp, ten_sp, selected_color, selected_size, quantity):&#10;            &quot;&quot;&quot;Add product to cart - Save to DATABASE giohangchuasanpham&quot;&quot;&quot;&#10;            print(f&quot;Debug: Adding {quantity}x {ten_sp} (Color: {selected_color}, Size: {selected_size}) to cart&quot;)&#10;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Get MaKH from username&#10;                cursor.execute(&quot;SELECT MaKH FROM khachhang WHERE TenDN = %s&quot;, (username,))&#10;                result = cursor.fetchone()&#10;                if not result:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, &quot;Không tìm thấy thông tin khách hàng!&quot;)&#10;                    return&#10;                ma_kh = result[0]&#10;&#10;                # Get current available stock and discount&#10;                cursor.execute(&quot;SELECT SoLuong, GiamGia FROM sanpham WHERE MaSP = %s&quot;, (ma_sp,))&#10;                stock_result = cursor.fetchone()&#10;                if not stock_result:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, &quot;Không tìm thấy sản phẩm!&quot;)&#10;                    return&#10;&#10;                available_stock, giam_gia = stock_result&#10;&#10;                # Check if cart already has this item&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    SELECT SoLuong FROM giohangchuasanpham &#10;                    WHERE MaKH = %s AND MaSP = %s AND MauSac = %s AND Size = %s&#10;                &quot;&quot;&quot;, (ma_kh, ma_sp, selected_color, selected_size))&#10;                existing = cursor.fetchone()&#10;                current_quantity_in_cart = existing[0] if existing else 0&#10;                new_total_quantity = current_quantity_in_cart + quantity&#10;&#10;                # Validation: Check stock&#10;                if new_total_quantity &gt; available_stock:&#10;                    remaining = available_stock - current_quantity_in_cart&#10;                    messagebox.showwarning(&quot;Cảnh báo tồn kho&quot;,&#10;                                         f&quot;Không thể thêm {quantity} sản phẩm '{ten_sp}'!\n\n&quot;&#10;                                         f&quot; Tồn kho: {available_stock}\n&quot;&#10;                                         f&quot; Đã có trong giỏ: {current_quantity_in_cart}\n&quot;&#10;                                         f&quot;✅ Có thể thêm tối đa: {remaining}\n&quot;&#10;                                         f&quot;(Màu: {selected_color}, Size: {selected_size})&quot;)&#10;                    return&#10;&#10;                # Add or update cart in DATABASE&#10;                if existing:&#10;                    cursor.execute(&quot;&quot;&quot;&#10;                        UPDATE giohangchuasanpham &#10;                        SET SoLuong = %s &#10;                        WHERE MaKH = %s AND MaSP = %s AND MauSac = %s AND Size = %s&#10;                    &quot;&quot;&quot;, (new_total_quantity, ma_kh, ma_sp, selected_color, selected_size))&#10;                    success_message = (f&quot;Đã cập nhật giỏ hàng!\n&quot;&#10;                                     f&quot;Sản phẩm: {ten_sp}\n&quot;&#10;                                     f&quot;Màu sắc: {selected_color}, Size: {selected_size}\n&quot;&#10;                                     f&quot;Số lượng mới: {new_total_quantity}&quot;)&#10;                else:&#10;                    cursor.execute(&quot;&quot;&quot;&#10;                        INSERT INTO giohangchuasanpham (MaKH, MaSP, MauSac, Size, SoLuong)&#10;                        VALUES (%s, %s, %s, %s, %s)&#10;                    &quot;&quot;&quot;, (ma_kh, ma_sp, selected_color, selected_size, quantity))&#10;                    success_message = (f&quot;Đã thêm vào giỏ hàng!\n&quot;&#10;                                     f&quot;Sản phẩm: {ten_sp}\n&quot;&#10;                                     f&quot;Màu sắc: {selected_color}, Size: {selected_size}\n&quot;&#10;                                     f&quot;Số lượng: {quantity}&quot;)&#10;&#10;                conn.commit()&#10;&#10;                # Update cart button&#10;                btn_cart.config(text=update_cart_button())&#10;&#10;                # Show success message&#10;                remaining_after = available_stock - new_total_quantity&#10;                messagebox.showinfo(&quot;Thành công&quot;,&#10;                                   f&quot;{success_message}\n\n&quot;&#10;                                   f&quot; Còn lại trong kho: {remaining_after}&quot;)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể thêm sản phẩm vào giỏ hàng: {str(e)}&quot;)&#10;                import traceback&#10;                traceback.print_exc()&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        def delete_product(ma_sp, ten_sp):&#10;            if role != &quot;seller&quot;:&#10;                return&#10;&#10;            result = messagebox.askyesno(&quot;Xác nhận&quot;, f&quot;Bạn có chắc chắn muốn xóa sản phẩm '{ten_sp}' không?&quot;)&#10;            if not result:&#10;                return&#10;&#10;            conn = None&#10;            cursor = None&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Delete all related records in correct order to avoid foreign key constraint errors&#10;&#10;                # 1. Delete from giohangchuasanpham (temporary cart items)&#10;                cursor.execute(&quot;DELETE FROM giohangchuasanpham WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                # 2. Delete from sptrongdon (order items - unpaid orders)&#10;                cursor.execute(&quot;DELETE FROM sptrongdon WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                # 3. Delete product images&#10;                cursor.execute(&quot;DELETE FROM url_sp WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                # 4. Delete product from sanpham table&#10;                # NOTE: cthoadon (invoice details) will KEEP the product data including TenSP&#10;                # This ensures sales statistics remain accurate even after product deletion&#10;                cursor.execute(&quot;DELETE FROM sanpham WHERE MaSP = %s&quot;, (ma_sp,))&#10;&#10;                conn.commit()&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã xóa sản phẩm '{ten_sp}' thành công!&quot;)&#10;&#10;                # Refresh the product list&#10;                self.show_shoes(role, username)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể xóa sản phẩm: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Filter products function&#10;        def filter_products():&#10;            # Clear current items&#10;            for item in tree.get_children():&#10;                tree.delete(item)&#10;&#10;            search_text = search_var.get().lower().strip()&#10;            selected_brand = brand_var.get()&#10;            selected_price = price_var.get()&#10;&#10;            filtered_products = []&#10;            out_of_stock_count = 0&#10;            low_stock_count = 0&#10;&#10;            for ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia in all_products:&#10;                # Filter by search text - Updated to search both product code and name&#10;                if search_text and search_text not in ten_sp.lower() and search_text not in ma_sp.lower():&#10;                    continue&#10;&#10;                # Filter by brand&#10;                if selected_brand != &quot;Tất cả&quot; and ten_th != selected_brand:&#10;                    continue&#10;&#10;                # Filter by price&#10;                if selected_price != &quot;Tất cả&quot; and gia:&#10;                    price_val = float(gia)&#10;                    if selected_price == &quot;Dưới 500k&quot; and price_val &gt;= 500000:&#10;                        continue&#10;                    elif selected_price == &quot;500k - 1tr&quot; and (price_val &lt; 500000 or price_val &gt;= 1000000):&#10;                        continue&#10;                    elif selected_price == &quot;1tr - 2tr&quot; and (price_val &lt; 1000000 or price_val &gt;= 2000000):&#10;                        continue&#10;                    elif selected_price == &quot;Trên 2tr&quot; and price_val &lt; 2000000:&#10;                        continue&#10;&#10;                filtered_products.append((ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia))&#10;&#10;                # Count stock warnings for sellers&#10;                if role == &quot;seller&quot;:&#10;                    if so_luong == 0:&#10;                        out_of_stock_count += 1&#10;                    elif so_luong &lt;= 5:&#10;                        low_stock_count += 1&#10;&#10;            # Populate treeview with stock warnings for sellers&#10;            product_data.clear()&#10;            for ma_sp, ten_sp, gia, mo_ta, ten_th, so_luong, ngay_nhap_hang, giam_gia in filtered_products:&#10;                # Use GiamGia from database (stored as int, e.g., 10 = 10%, 15 = 15%)&#10;                discount_percent = int(giam_gia) if giam_gia else 0&#10;&#10;                # Apply discount to price display with compact messaging&#10;                if gia is not None:&#10;                    original_price = float(gia)&#10;                    if discount_percent &gt; 0:&#10;                        # Calculate discounted price: original_price * (1 - discount_percent/100)&#10;                        discounted_price = original_price * (1 - discount_percent / 100)&#10;                        price_display = f&quot;{discounted_price:,.0f} VNĐ (-{discount_percent}%)&quot;&#10;                    else:&#10;                        price_display = f&quot;{original_price:,.0f} VNĐ&quot;&#10;                else:&#10;                    price_display = &quot;N/A&quot;&#10;&#10;                if role == &quot;seller&quot;:&#10;                    # Add visual indicators for stock levels&#10;                    if so_luong == 0:&#10;                        display_name = f&quot;⚠️ {ten_sp} (HẾT HÀNG)&quot;&#10;                        item_id = tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, display_name, price_display, so_luong))&#10;                        tree.set(item_id, &quot;SL&quot;, f&quot;⚠️ {so_luong}&quot;)&#10;                    elif so_luong &lt;= 5:&#10;                        display_name = f&quot;⚡ {ten_sp} (SẮP HẾT)&quot;&#10;                        item_id = tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, display_name, price_display, so_luong))&#10;                        tree.set(item_id, &quot;SL&quot;, f&quot;⚡ {so_luong}&quot;)&#10;                    else:&#10;                        tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, ten_sp, price_display, so_luong))&#10;                else:&#10;                    tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_sp, values=(ma_sp, ten_sp, price_display))&#10;&#10;                # Calculate actual discounted price for cart&#10;                original_price_val = float(gia) if gia else 0&#10;                actual_price = original_price_val * (1 - discount_percent / 100) if discount_percent &gt; 0 else original_price_val&#10;&#10;                product_data[ma_sp] = {&#10;                    &quot;name&quot;: ten_sp,&#10;                    &quot;price&quot;: price_display,&#10;                    &quot;description&quot;: (mo_ta or &quot;Chưa có mô tả cho sản phẩm này.&quot;).strip(),&#10;                    &quot;images&quot;: product_images.get(ma_sp, []),&#10;                    &quot;quantity&quot;: so_luong,&#10;                    &quot;discount&quot;: discount_percent,&#10;                    &quot;original_price&quot;: original_price_val,&#10;                    &quot;discounted_price&quot;: actual_price  # Giá sau khi giảm để dùng cho cart&#10;                }&#10;&#10;            # Update status label with count and stock warnings&#10;            if role == &quot;seller&quot;:&#10;                status_text = f&quot;Tổng sản phẩm: {len(filtered_products)}&quot;&#10;                if out_of_stock_count &gt; 0:&#10;                    status_text += f&quot; | ⚠️ HẾT HÀNG: {out_of_stock_count}&quot;&#10;                if low_stock_count &gt; 0:&#10;                    status_text += f&quot; | ⚡ SẮP HẾT: {low_stock_count}&quot;&#10;                status_label.config(text=status_text, fg='#e74c3c' if out_of_stock_count &gt; 0 else '#f39c12' if low_stock_count &gt; 0 else '#7f8c8d')&#10;&#10;                # Show warning popup for critical stock levels&#10;                if out_of_stock_count &gt; 0 and not hasattr(filter_products, '_warning_shown'):&#10;                    messagebox.showwarning(&quot;Cảnh báo hàng tồn&quot;,&#10;                                         f&quot;Có {out_of_stock_count} sản phẩm đã hết hàng!\n&quot;&#10;                                         f&quot;Vui lòng nhập thêm hàng hoặc ẩn sản phẩm.&quot;)&#10;                    filter_products._warning_shown = True&#10;            else:&#10;                status_label.config(text=f&quot;Tổng sản phẩm: {len(filtered_products)}&quot;, fg='#7f8c8d')&#10;&#10;        # Bind filter events&#10;        btn_search.config(command=filter_products)&#10;        btn_filter.config(command=filter_products)&#10;        search_entry.bind('&lt;Return&gt;', lambda e: filter_products())&#10;&#10;        # Populate initial data&#10;        product_data = {}&#10;        filter_products()  # This will populate the tree&#10;&#10;        # Handle product selection and enable action button&#10;        selected_product_id = None&#10;&#10;        def on_product_select_combined(event):&#10;            nonlocal selected_product_id&#10;            selection = tree.selection()&#10;&#10;        def on_product_select_combined(event):&#10;            nonlocal selected_product_id&#10;            selection = tree.selection()&#10;&#10;            if selection:&#10;                if role == &quot;buyer&quot;:&#10;                    # For buyers: support multiple selection&#10;                    selected_product_id = selection  # Store all selections&#10;                    num_selected = len(selection)&#10;&#10;                    # Enable add to cart button&#10;                    btn_add_to_cart.config(state='normal', bg='#27ae60')&#10;                    add_button_hover_effect(btn_add_to_cart, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;                    if num_selected == 1:&#10;                        status_label.config(text=&quot;Đã chọn 1 sản phẩm - Click để thêm vào giỏ!&quot;, fg='green')&#10;                        # Update product details for single selection&#10;                        product = product_data[selection[0]]&#10;                        product_name_label.config(text=product[&quot;name&quot;])&#10;&#10;                        if product['discount'] &gt; 0:&#10;                            original_price = product['original_price']&#10;                            discounted_price = original_price * (1 - product['discount'] / 100)&#10;                            product_price_label.config(&#10;                                text=f&quot;Giá: {discounted_price:,.0f} VNĐ (-{product['discount']}%)\n&quot;&#10;                                     f&quot;Giá gốc: {original_price:,.0f} VNĐ&quot;,&#10;                                fg='#e74c3c'&#10;                            )&#10;                        else:&#10;                            product_price_label.config(text=product['price'], fg='#27ae60')&#10;&#10;                        desc_text.config(state='normal')&#10;                        desc_text.delete(1.0, tk.END)&#10;                        desc_text.insert(1.0, product[&quot;description&quot;])&#10;                        desc_text.config(state='disabled')&#10;&#10;                        images = product[&quot;images&quot;]&#10;                        if images:&#10;                            show_main_image(images[0])&#10;                            update_thumbnail_gallery(images)&#10;                        else:&#10;                            show_main_image(None)&#10;                            update_thumbnail_gallery([])&#10;                    else:&#10;                        status_label.config(text=f&quot;Đã chọn {num_selected} sản phẩm - Click để thêm vào giỏ!&quot;, fg='green')&#10;                        product_name_label.config(text=f&quot;{num_selected} sản phẩm đã chọn&quot;)&#10;                        product_price_label.config(text=&quot;&quot;, fg='#27ae60')&#10;                        desc_text.config(state='normal')&#10;                        desc_text.delete(1.0, tk.END)&#10;                        desc_text.insert(1.0, &quot;Nhiều sản phẩm được chọn. Click thêm vào giỏ để cấu hình từng sản phẩm.&quot;)&#10;                        desc_text.config(state='disabled')&#10;                        show_main_image(None)&#10;                        update_thumbnail_gallery([])&#10;&#10;                    # Set command for add to cart with all selections&#10;                    btn_add_to_cart.config(command=lambda: show_multi_product_cart_dialog(selection))&#10;&#10;                else:&#10;                    # For sellers: single selection only&#10;                    selected_product_id = selection[0]&#10;                    if selected_product_id in product_data:&#10;                        # Enable delete and edit product buttons with hover effects&#10;                        btn_delete_product.config(state='normal', bg='#e74c3c')&#10;                        add_button_hover_effect(btn_delete_product, '#e74c3c', get_hover_color('#e74c3c'))&#10;                        btn_edit_product.config(state='normal', bg='#f39c12')&#10;                        add_button_hover_effect(btn_edit_product, '#f39c12', get_hover_color('#f39c12'))&#10;                        status_label.config(text=&quot;Click để xóa hoặc sửa sản phẩm đã chọn&quot;, fg='blue')&#10;                        btn_delete_product.config(command=lambda: delete_product(selected_product_id, product_data[selected_product_id][&quot;name&quot;]))&#10;                        btn_edit_product.config(command=lambda: self.show_edit_product_form(selected_product_id, role, username))&#10;&#10;                        # Update product details on the right panel&#10;                        product = product_data[selected_product_id]&#10;&#10;                        # Update product name&#10;                        product_name_label.config(text=f&quot;{product['name']} (SL: {product['quantity']})&quot;)&#10;&#10;                        # Update price with discount info&#10;                        if product['discount'] &gt; 0:&#10;                            original_price = product['original_price']&#10;                            discounted_price = original_price * (1 - product['discount'] / 100)&#10;                            product_price_label.config(&#10;                                text=f&quot;Giá: {discounted_price:,.0f} VNĐ (-{product['discount']}%)\n&quot;&#10;                                     f&quot;Giá gốc: {original_price:,.0f} VNĐ&quot;,&#10;                                fg='#e74c3c'&#10;                            )&#10;                        else:&#10;                            product_price_label.config(text=product['price'], fg='#27ae60')&#10;&#10;                        # Update description&#10;                        desc_text.config(state='normal')&#10;                        desc_text.delete(1.0, tk.END)&#10;                        desc_text.insert(1.0, product[&quot;description&quot;])&#10;                        desc_text.config(state='disabled')&#10;&#10;                        # Update images&#10;                        images = product[&quot;images&quot;]&#10;                        if images:&#10;                            show_main_image(images[0])  # Show first image as main&#10;                            update_thumbnail_gallery(images)&#10;                        else:&#10;                            show_main_image(None)&#10;                            update_thumbnail_gallery([])&#10;            else:&#10;                selected_product_id = None&#10;                if role == &quot;buyer&quot;:&#10;                    btn_add_to_cart.config(state='disabled', bg='#95a5a6')&#10;                    status_label.config(text=&quot;Chọn sản phẩm để thêm vào giỏ hàng&quot;, fg='#7f8c8d')&#10;                else:&#10;                    btn_delete_product.config(state='disabled', bg='#95a5a6')&#10;                    btn_edit_product.config(state='disabled', bg='#95a5a6')&#10;                    status_label.config(text=&quot;Chọn sản phẩm để xóa hoặc sửa&quot;, fg='#7f8c8d')&#10;&#10;        # ONLY bind this event - remove any other bindings&#10;        tree.bind(&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;, on_product_select_combined)&#10;&#10;        # Right panel: Product details and image gallery&#10;        detail_frame = tk.Frame(main_frame, bg='#f8f9fa')&#10;        detail_frame.pack(side='right', fill='both', expand=True)&#10;&#10;        # Product name&#10;        product_name_label = tk.Label(detail_frame, text=&quot;Chọn sản phẩm để xem chi tiết&quot;,&#10;                                      font=('Arial', 18, 'bold'), bg='#f8f9fa', fg='#2c3e50')&#10;        product_name_label.pack(pady=(15, 5))&#10;&#10;        # Price label (with discount if applicable)&#10;        product_price_label = tk.Label(detail_frame, text=&quot;&quot;,&#10;                                       font=('Arial', 16, 'bold'), bg='#f8f9fa', fg='#27ae60')&#10;        product_price_label.pack(pady=(0, 10))&#10;&#10;        # Create horizontal container for image and gallery&#10;        content_container = tk.Frame(detail_frame, bg='#f8f9fa')&#10;        content_container.pack(fill='both', expand=True, padx=15)&#10;&#10;        # Left side - Image and description section&#10;        image_section = tk.Frame(content_container, bg='#f8f9fa')&#10;        image_section.pack(side='left', fill='both', expand=True, padx=(0, 15))&#10;&#10;        # Main image display area (reduced height to accommodate wider price column)&#10;        main_image_frame = tk.Frame(image_section, bg='white', relief='solid', bd=1, height=450)&#10;        main_image_frame.pack(fill='x', pady=(0, 15))&#10;        main_image_frame.pack_propagate(False)&#10;&#10;        main_image_label = tk.Label(main_image_frame, text=&quot;Hình ảnh sản phẩm&quot;,&#10;                                   font=('Arial', 14), bg='white', fg='#6c757d')&#10;        main_image_label.pack(expand=True)&#10;&#10;        # Description area (below main image, more visible with better spacing)&#10;        desc_section = tk.Frame(image_section, bg='#f8f9fa', relief='solid', bd=1)&#10;        desc_section.pack(fill='x', pady=(0, 10))&#10;&#10;        tk.Label(desc_section, text=&quot;Mô tả sản phẩm:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#f8f9fa').pack(anchor='w', pady=(5, 5), padx=5)&#10;&#10;        desc_text = tk.Text(desc_section, height=4, wrap='word', font=('Arial', 11),&#10;                           state='disabled', bg='white', relief='solid', bd=1)&#10;        desc_text.pack(fill='both', expand=True, padx=5, pady=(0, 5))&#10;&#10;        # Right side - Thumbnail gallery section (with better spacing)&#10;        gallery_section = tk.Frame(content_container, bg='#f8f9fa', width=120)&#10;        gallery_section.pack(side='right', fill='y', padx=(15, 0))&#10;        gallery_section.pack_propagate(False)&#10;&#10;        tk.Label(gallery_section, text=&quot;Các ảnh khác:&quot;, font=('Arial', 12, 'bold'),&#10;                 bg='#f8f9fa').pack(anchor='w', pady=(0, 10))&#10;&#10;        # Scrollable thumbnail container (adjusted height)&#10;        thumbnail_frame = tk.Frame(gallery_section, bg='white', height=380, relief='solid', bd=1)&#10;        thumbnail_frame.pack(fill='both', expand=True)&#10;&#10;        # Canvas for scrolling thumbnails (vertical scrolling now)&#10;        thumbnail_canvas = tk.Canvas(thumbnail_frame, bg='white')&#10;        thumbnail_scrollbar = ttk.Scrollbar(thumbnail_frame, orient='vertical', command=thumbnail_canvas.yview)&#10;        thumbnail_scrollable = tk.Frame(thumbnail_canvas, bg='white')&#10;&#10;        thumbnail_scrollable.bind(&quot;&lt;Configure&gt;&quot;,&#10;                                 lambda e: thumbnail_canvas.configure(scrollregion=thumbnail_canvas.bbox(&quot;all&quot;)))&#10;        thumbnail_canvas.create_window((0, 0), window=thumbnail_scrollable, anchor=&quot;nw&quot;)&#10;        thumbnail_canvas.configure(yscrollcommand=thumbnail_scrollbar.set)&#10;&#10;        thumbnail_canvas.pack(side='left', fill='both', expand=True)&#10;        thumbnail_scrollbar.pack(side='right', fill='y')&#10;&#10;        # Functions for handling images&#10;        def show_main_image(image_url):&#10;            &quot;&quot;&quot;Display main image&quot;&quot;&quot;&#10;            try:&#10;                # Clear current image&#10;                for widget in main_image_frame.winfo_children():&#10;                    widget.destroy()&#10;&#10;                if image_url:&#10;                    img = load_image_safely(image_url)&#10;                    if img:&#10;                        # Resize to fit main display area&#10;                        main_image_label_new = tk.Label(main_image_frame, image=img, bg='white')&#10;                        main_image_label_new.image = img  # Keep reference&#10;                        main_image_label_new.pack(expand=True)&#10;                    else:&#10;                        tk.Label(main_image_frame, text=&quot;❌ Không thể tải hình ảnh&quot;,&#10;                               font=('Arial', 14), bg='white', fg='#e74c3c').pack(expand=True)&#10;                else:&#10;                    tk.Label(main_image_frame, text=&quot;Không có hình ảnh&quot;,&#10;                           font=('Arial', 14), bg='white', fg='#6c757d').pack(expand=True)&#10;            except Exception as e:&#10;                tk.Label(main_image_frame, text=&quot;Lỗi tải hình ảnh&quot;,&#10;                       font=('Arial', 14), bg='white', fg='#e74c3c').pack(expand=True)&#10;&#10;        def update_thumbnail_gallery(images):&#10;            &quot;&quot;&quot;Update thumbnail gallery&quot;&quot;&quot;&#10;            # Clear current thumbnails&#10;            for widget in thumbnail_scrollable.winfo_children():&#10;                widget.destroy()&#10;&#10;            if not images:&#10;                tk.Label(thumbnail_scrollable, text=&quot;Không có ảnh khác&quot;,&#10;                       font=('Arial', 10), bg='white', fg='#6c757d').pack(pady=20)&#10;                return&#10;&#10;            for i, image_url in enumerate(images):&#10;                try:&#10;                    # Load thumbnail image&#10;                    thumb_img = load_thumbnail_image(image_url)&#10;                    if thumb_img:&#10;                        # Create thumbnail button - now arranged vertically and centered&#10;                        thumb_btn = tk.Button(thumbnail_scrollable, image=thumb_img,&#10;                                             command=lambda url=image_url: show_main_image(url),&#10;                                             relief='solid', bd=2, cursor='hand2',&#10;                                             bg='white', activebackground='#e9ecef')&#10;                        thumb_btn.image = thumb_img  # Keep reference&#10;                        thumb_btn.pack(pady=3, padx=5, anchor='center')  # Added anchor='center'&#10;&#10;                        # Hover effects&#10;                        def on_enter(e, btn=thumb_btn):&#10;                            btn.config(bd=3, bg='#dee2e6')&#10;                        def on_leave(e, btn=thumb_btn):&#10;                            btn.config(bd=2, bg='white')&#10;&#10;                        thumb_btn.bind(&quot;&lt;Enter&gt;&quot;, on_enter)&#10;                        thumb_btn.bind(&quot;&lt;Leave&gt;&quot;, on_leave)&#10;&#10;                    else:&#10;                        # Fallback button if can't load image - also centered&#10;                        thumb_btn = tk.Button(thumbnail_scrollable, text=f&quot;Ảnh {i+1}&quot;,&#10;                                             command=lambda url=image_url: show_main_image(url),&#10;                                             width=8, height=4, cursor='hand2',&#10;                                             relief='solid', bd=2, bg='white')&#10;                        thumb_btn.pack(pady=3, padx=5, anchor='center')  # Added anchor='center'&#10;&#10;                except Exception as e:&#10;                    print(f&quot;Error creating thumbnail {i+1}: {e}&quot;)&#10;                    # Create placeholder button - also centered&#10;                    thumb_btn = tk.Button(thumbnail_scrollable, text=f&quot;Ảnh {i+1}&quot;,&#10;                                         command=lambda url=image_url: show_main_image(url),&#10;                                         width=8, height=4, cursor='hand2',&#10;                                         relief='solid', bd=2, bg='white')&#10;                    thumb_btn.pack(pady=3, padx=5, anchor='center')  # Added anchor='center'&#10;&#10;        # Mouse wheel scroll for thumbnail canvas&#10;        def on_mousewheel(event):&#10;            thumbnail_canvas.xview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;&#10;        thumbnail_canvas.bind(&quot;&lt;MouseWheel&gt;&quot;, on_mousewheel)&#10;&#10;    def show_add_product_form(self, role, username):&#10;        &quot;&quot;&quot;Show add product form - from main.py&quot;&quot;&quot;&#10;        # Create add product window&#10;        add_window = tk.Toplevel(self.root)&#10;        add_window.title(&quot;Thêm sản phẩm mới&quot;)&#10;        add_window.geometry(&quot;600x650&quot;)  # Increased width and height for better visibility&#10;        add_window.resizable(False, False)&#10;        add_window.grab_set()  # Make window modal&#10;&#10;        # Center the window&#10;        add_window.transient(self.root)&#10;        add_window.focus()&#10;&#10;        # Unbind mousewheel when window closes&#10;        def on_closing():&#10;            add_window.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;            add_window.destroy()&#10;&#10;        add_window.protocol(&quot;WM_DELETE_WINDOW&quot;, on_closing)&#10;&#10;        # IMPORTANT: Pack button frame FIRST to reserve space at bottom&#10;        button_frame = tk.Frame(add_window, bg='#f0f0f0', relief='ridge', bd=1)&#10;        button_frame.pack(side='bottom', fill='x', padx=10, pady=10)&#10;&#10;        # Create canvas with scrollbar for scrollable content&#10;        canvas = tk.Canvas(add_window, bg='white')&#10;        scrollbar = tk.Scrollbar(add_window, orient=&quot;vertical&quot;, command=canvas.yview)&#10;        scrollable_frame = tk.Frame(canvas, bg='white')&#10;&#10;        scrollable_frame.bind(&#10;            &quot;&lt;Configure&gt;&quot;,&#10;            lambda e: canvas.configure(scrollregion=canvas.bbox(&quot;all&quot;))&#10;        )&#10;&#10;        canvas.create_window((0, 0), window=scrollable_frame, anchor=&quot;nw&quot;)&#10;        canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;        # Pack canvas and scrollbar - they will fill remaining space above buttons&#10;        canvas.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True, padx=(10, 0), pady=10)&#10;        scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;, pady=10)&#10;&#10;        # Use scrollable_frame as main_container&#10;        main_container = scrollable_frame&#10;&#10;        # Enable mousewheel scrolling&#10;        def _on_mousewheel(event):&#10;            canvas.yview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;        add_window.bind_all(&quot;&lt;MouseWheel&gt;&quot;, _on_mousewheel)&#10;&#10;        # Form fields&#10;        tk.Label(main_container, text=&quot;THÊM SẢN PHẨM MỚI&quot;, font=('Arial', 16, 'bold'), fg='#2c3e50').pack(pady=(10, 20))&#10;&#10;        # Product name&#10;        tk.Label(main_container, text=&quot;Tên sản phẩm:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_name = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_name.pack(padx=10, pady=(0, 8))&#10;&#10;        # Price&#10;        tk.Label(main_container, text=&quot;Giá (VNĐ):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_price = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_price.pack(padx=10, pady=(0, 8))&#10;&#10;        # Brand&#10;        tk.Label(main_container, text=&quot;Thương hiệu:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        brand_var_add = tk.StringVar()&#10;        brand_combo_add = ttk.Combobox(main_container, textvariable=brand_var_add, font=('Arial', 12), width=37, state='readonly')&#10;&#10;        # Load brands&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;            cursor.execute(&quot;SELECT MaTH, TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands_data = cursor.fetchall()&#10;            brand_combo_add['values'] = [f&quot;{th[1]} ({th[0]})&quot; for th in brands_data]&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải danh sách thương hiệu: {str(e)}&quot;)&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        brand_combo_add.pack(padx=10, pady=(0, 8))&#10;&#10;        # Quantity&#10;        tk.Label(main_container, text=&quot;Số lượng:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_quantity = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_quantity.pack(padx=10, pady=(0, 8))&#10;&#10;        # Import Date (NgayNhapHang)&#10;        tk.Label(main_container, text=&quot;Ngày nhập hàng (YYYY-MM-DD):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_import_date = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_import_date.pack(padx=10, pady=(0, 8))&#10;&#10;        # Description&#10;        tk.Label(main_container, text=&quot;Mô tả:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_description = tk.Text(main_container, font=('Arial', 11), width=42, height=5, wrap='word')  # Reduced height from 6 to 5&#10;        text_description.pack(padx=10, pady=(0, 8))&#10;&#10;        # Colors (Available colors for this product)&#10;        tk.Label(main_container, text=&quot;Màu sắc có sẵn (mỗi màu một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_colors = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        text_colors.insert(1.0, &quot;Trắng\nXanh Dương\nĐen\nNâu&quot;)  # Default colors&#10;        text_colors.pack(padx=10, pady=(0, 8))&#10;&#10;        # Sizes (Available sizes for this product)&#10;        tk.Label(main_container, text=&quot;Kích cỡ có sẵn (mỗi size một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_sizes = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        text_sizes.insert(1.0, &quot;\n&quot;.join([str(i) for i in range(36, 46)]))  # Default sizes 36-45&#10;        text_sizes.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image URLs&#10;        tk.Label(main_container, text=&quot;URL hình ảnh (mỗi URL một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_images = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        text_images.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image Upload Section&#10;        upload_frame = tk.Frame(main_container)&#10;        upload_frame.pack(fill='x', padx=10, pady=(5, 8))&#10;&#10;        tk.Label(upload_frame, text=&quot;Hoặc tải ảnh từ thiết bị:&quot;, font=('Arial', 11, 'bold')).pack(anchor='w')&#10;&#10;        # Store uploaded image filenames temporarily&#10;        uploaded_images = []&#10;&#10;        upload_btn_frame = tk.Frame(upload_frame)&#10;        upload_btn_frame.pack(anchor='w', pady=(5, 0))&#10;&#10;        def upload_image():&#10;            filetypes = [(&quot;Image files&quot;, &quot;*.png *.jpg *.jpeg *.gif *.bmp&quot;), (&quot;All files&quot;, &quot;*.*&quot;)]&#10;            file_path = filedialog.askopenfilename(parent=add_window, title=&quot;Chọn hình ảnh&quot;, filetypes=filetypes)&#10;            if file_path:&#10;                try:&#10;                    # Save to local directory&#10;                    filename = save_uploaded_image(file_path)&#10;                    uploaded_images.append(filename)&#10;                    # Update label to show count&#10;                    upload_count_label.config(text=f&quot;Đã chọn: {len(uploaded_images)} ảnh&quot;, fg='#27ae60')&#10;                    messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm ảnh: {os.path.basename(file_path)}&quot;)&#10;                except Exception as e:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải ảnh: {str(e)}&quot;)&#10;&#10;        tk.Button(upload_btn_frame, text=&quot; Chọn ảnh từ máy&quot;, command=upload_image,&#10;                 bg='#3498db', fg='white', font=('Arial', 10, 'bold'),&#10;                 padx=10, pady=5, cursor='hand2').pack(side='left')&#10;&#10;        upload_count_label = tk.Label(upload_btn_frame, text=&quot;Chưa chọn ảnh nào&quot;,&#10;                                      font=('Arial', 10), fg='#7f8c8d')&#10;        upload_count_label.pack(side='left', padx=(10, 0))&#10;&#10;&#10;        def save_product():&#10;            # Get form data&#10;            name = entry_name.get().strip()&#10;            price_str = entry_price.get().strip()&#10;            brand_selection = brand_var_add.get()&#10;            quantity_str = entry_quantity.get().strip()&#10;            import_date_str = entry_import_date.get().strip()&#10;            description = text_description.get(1.0, tk.END).strip()&#10;            colors = text_colors.get(1.0, tk.END).strip()&#10;            image_urls = text_images.get(1.0, tk.END).strip()&#10;&#10;            # Validation&#10;            if not all([name, price_str, brand_selection, quantity_str]):&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng nhập đầy đủ thông tin bắt buộc!&quot;)&#10;                return&#10;&#10;            try:&#10;                price = float(price_str)&#10;                if price &lt;= 0:&#10;                    raise ValueError(&quot;Giá phải lớn hơn 0&quot;)&#10;                quantity = int(quantity_str)&#10;                if quantity &lt; 0:&#10;                    raise ValueError(&quot;Số lượng phải &gt;= 0&quot;)&#10;&#10;                # Validate import date format if provided&#10;                if import_date_str:&#10;                    from datetime import datetime&#10;                    try:&#10;                        datetime.strptime(import_date_str, '%Y-%m-%d')&#10;                    except ValueError:&#10;                        raise ValueError(&quot;Ngày nhập hàng phải theo định dạng YYYY-MM-DD&quot;)&#10;            except ValueError as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Dữ liệu không hợp lệ: {str(e)}&quot;)&#10;                return&#10;&#10;            # Extract brand ID&#10;            try:&#10;                brand_id = brand_selection.split('(')[1].replace(')', '')&#10;            except:&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng chọn thương hiệu!&quot;)&#10;                return&#10;&#10;            # Generate product ID&#10;            conn = None&#10;            cursor = None&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Create color table if not exists&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    CREATE TABLE IF NOT EXISTS mausac_sp (&#10;                        MaSP VARCHAR(30) NOT NULL,&#10;                        MauSac VARCHAR(100) NOT NULL,&#10;                        PRIMARY KEY (MaSP, MauSac),&#10;                        FOREIGN KEY (MaSP) REFERENCES sanpham(MaSP) ON DELETE CASCADE&#10;                    )&#10;                &quot;&quot;&quot;)&#10;&#10;                # Create size table if not exists&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    CREATE TABLE IF NOT EXISTS size_sp (&#10;                        MaSP VARCHAR(30) NOT NULL,&#10;                        Size VARCHAR(20) NOT NULL,&#10;                        PRIMARY KEY (MaSP, Size),&#10;                        FOREIGN KEY (MaSP) REFERENCES sanpham(MaSP) ON DELETE CASCADE&#10;                    )&#10;                &quot;&quot;&quot;)&#10;&#10;                # Generate new product ID&#10;                cursor.execute(&quot;SELECT MAX(CAST(SUBSTRING(MaSP, 3) AS UNSIGNED)) FROM sanpham WHERE MaSP LIKE 'SP%'&quot;)&#10;                result = cursor.fetchone()&#10;                next_number = ((result[0] or 0) + 1) if result and result[0] is not None else 1&#10;                product_id = f&quot;SP{next_number:03d}&quot;&#10;&#10;                # Insert product with import date&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    INSERT INTO sanpham (MaSP, TenSP, Gia, MoTa, MaTH, SoLuong, NgayNhapHang)&#10;                    VALUES (%s, %s, %s, %s, %s, %s, %s)&#10;                &quot;&quot;&quot;, (product_id, name, price, description if description else None, brand_id, quantity,&#10;                      import_date_str if import_date_str else None))&#10;&#10;                # Insert colors if provided&#10;                if colors:&#10;                    color_list = [color.strip() for color in colors.split('\n') if color.strip()]&#10;                    for color in color_list:&#10;                        cursor.execute(&quot;INSERT INTO mausac_sp (MaSP, MauSac) VALUES (%s, %s)&quot;, (product_id, color))&#10;&#10;                # Insert sizes if provided&#10;                sizes = text_sizes.get(1.0, tk.END).strip()&#10;                if sizes:&#10;                    size_list = [size.strip() for size in sizes.split('\n') if size.strip()]&#10;                    for size in size_list:&#10;                        cursor.execute(&quot;INSERT INTO size_sp (MaSP, Size) VALUES (%s, %s)&quot;, (product_id, size))&#10;&#10;                # Insert image URLs if provided&#10;                if image_urls:&#10;                    urls = [url.strip() for url in image_urls.split('\n') if url.strip()]&#10;                    for url in urls:&#10;                        cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, url))&#10;&#10;                # Insert uploaded images&#10;                for filename in uploaded_images:&#10;                    cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, filename))&#10;&#10;                conn.commit()&#10;                total_images = len([url.strip() for url in image_urls.split('\n') if url.strip()]) + len(uploaded_images)&#10;                total_colors = len([color.strip() for color in colors.split('\n') if color.strip()])&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm sản phẩm '{name}' với {total_colors} màu và {total_images} ảnh thành công!&quot;)&#10;                add_window.destroy()&#10;&#10;                # Refresh the product list&#10;                self.show_shoes(role, username)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể thêm sản phẩm: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Action buttons with proper colors and positions&#10;        tk.Button(button_frame, text=&quot; Lưu&quot;, command=save_product,&#10;                 bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='left', padx=15, pady=10)&#10;        tk.Button(button_frame, text=&quot;❌ Hủy&quot;, command=on_closing,&#10;                 bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='right', padx=15, pady=10)&#10;&#10;    def show_edit_product_form(self, product_id, role, username):&#10;        &quot;&quot;&quot;Show edit product form with current data loaded&quot;&quot;&quot;&#10;        # First, get current product data from database&#10;        conn = None&#10;        cursor = None&#10;        current_data = {}&#10;        current_images = []&#10;&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;&#10;            # Get product details&#10;            cursor.execute(&quot;&quot;&quot;&#10;                SELECT sp.MaSP, sp.TenSP, sp.Gia, sp.MoTa, sp.MaTH, sp.SoLuong, th.TenTH, sp.NgayNhapHang&#10;                FROM sanpham sp&#10;                LEFT JOIN thuonghieu th ON sp.MaTH = th.MaTH&#10;                WHERE sp.MaSP = %s&#10;            &quot;&quot;&quot;, (product_id,))&#10;&#10;            result = cursor.fetchone()&#10;            if not result:&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Không tìm thấy sản phẩm!&quot;)&#10;                return&#10;&#10;            current_data = {&#10;                'id': result[0],&#10;                'name': result[1],&#10;                'price': result[2],&#10;                'description': result[3] or &quot;&quot;,&#10;                'brand_id': result[4],&#10;                'quantity': result[5],&#10;                'brand_name': result[6],&#10;                'import_date': result[7].strftime('%Y-%m-%d') if result[7] else ''&#10;            }&#10;&#10;            # Get product images&#10;            cursor.execute(&quot;SELECT URLAnh FROM url_sp WHERE MaSP = %s&quot;, (product_id,))&#10;            current_images = [row[0] for row in cursor.fetchall()]&#10;&#10;            # Get product colors&#10;            current_colors = []&#10;            try:&#10;                cursor.execute(&quot;SELECT MauSac FROM mausac_sp WHERE MaSP = %s&quot;, (product_id,))&#10;                current_colors = [row[0] for row in cursor.fetchall()]&#10;            except Exception as e:&#10;                # If table doesn't exist yet, use default colors&#10;                print(f&quot;Note: Color table may not exist yet: {e}&quot;)&#10;                current_colors = [&quot;Trắng&quot;, &quot;Xanh Dương&quot;, &quot;Đen&quot;, &quot;Nâu&quot;]&#10;&#10;            # Get product sizes&#10;            current_sizes = []&#10;            try:&#10;                cursor.execute(&quot;SELECT Size FROM size_sp WHERE MaSP = %s ORDER BY CAST(Size AS UNSIGNED)&quot;, (product_id,))&#10;                current_sizes = [row[0] for row in cursor.fetchall()]&#10;            except Exception as e:&#10;                # If table doesn't exist yet, use default sizes&#10;                print(f&quot;Note: Size table may not exist yet: {e}&quot;)&#10;                current_sizes = [str(i) for i in range(36, 46)]&#10;&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải dữ liệu sản phẩm: {str(e)}&quot;)&#10;            return&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        # Create edit product window&#10;        edit_window = tk.Toplevel(self.root)&#10;        edit_window.title(f&quot;Sửa sản phẩm: {current_data['name']}&quot;)&#10;        edit_window.geometry(&quot;600x650&quot;)  # Increased width and height for better visibility&#10;        edit_window.resizable(False, False)&#10;        edit_window.grab_set()  # Make window modal&#10;&#10;        # Center the window&#10;        edit_window.transient(self.root)&#10;        edit_window.focus()&#10;&#10;        # Unbind mousewheel when window closes&#10;        def on_closing():&#10;            edit_window.unbind_all(&quot;&lt;MouseWheel&gt;&quot;)&#10;            edit_window.destroy()&#10;&#10;        edit_window.protocol(&quot;WM_DELETE_WINDOW&quot;, on_closing)&#10;&#10;        # IMPORTANT: Pack button frame FIRST to reserve space at bottom&#10;        button_frame = tk.Frame(edit_window, bg='#f0f0f0', relief='ridge', bd=1)&#10;        button_frame.pack(side='bottom', fill='x', padx=10, pady=10)&#10;&#10;        # Create canvas with scrollbar for scrollable content&#10;        canvas = tk.Canvas(edit_window, bg='white')&#10;        scrollbar = tk.Scrollbar(edit_window, orient=&quot;vertical&quot;, command=canvas.yview)&#10;        scrollable_frame = tk.Frame(canvas, bg='white')&#10;&#10;        scrollable_frame.bind(&#10;            &quot;&lt;Configure&gt;&quot;,&#10;            lambda e: canvas.configure(scrollregion=canvas.bbox(&quot;all&quot;))&#10;        )&#10;&#10;        canvas.create_window((0, 0), window=scrollable_frame, anchor=&quot;nw&quot;)&#10;        canvas.configure(yscrollcommand=scrollbar.set)&#10;&#10;        # Pack canvas and scrollbar - they will fill remaining space above buttons&#10;        canvas.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True, padx=(10, 0), pady=10)&#10;        scrollbar.pack(side=&quot;right&quot;, fill=&quot;y&quot;, pady=10)&#10;&#10;        # Use scrollable_frame as main_container&#10;        main_container = scrollable_frame&#10;&#10;        # Enable mousewheel scrolling&#10;        def _on_mousewheel(event):&#10;            canvas.yview_scroll(int(-1*(event.delta/120)), &quot;units&quot;)&#10;        edit_window.bind_all(&quot;&lt;MouseWheel&gt;&quot;, _on_mousewheel)&#10;&#10;        # Form fields&#10;        tk.Label(main_container, text=f&quot;SỬA SẢN PHẨM: {current_data['name']}&quot;,&#10;                font=('Arial', 16, 'bold'), fg='#f39c12').pack(pady=(10, 20))&#10;&#10;        # Product name&#10;        tk.Label(main_container, text=&quot;Tên sản phẩm:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_name = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_name.insert(0, current_data['name'])&#10;        entry_name.pack(padx=10, pady=(0, 8))&#10;&#10;        # Price&#10;        tk.Label(main_container, text=&quot;Giá (VNĐ):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_price = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_price.insert(0, str(current_data['price']))&#10;        entry_price.pack(padx=10, pady=(0, 8))&#10;&#10;        # Brand&#10;        tk.Label(main_container, text=&quot;Thương hiệu:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        brand_var_edit = tk.StringVar()&#10;        brand_combo_edit = ttk.Combobox(main_container, textvariable=brand_var_edit, font=('Arial', 12), width=37, state='readonly')&#10;&#10;        # Load brands and set current brand&#10;        try:&#10;            conn = get_db_connection()&#10;            cursor = conn.cursor()&#10;            cursor.execute(&quot;SELECT MaTH, TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;            brands_data = cursor.fetchall()&#10;            brand_options = [f&quot;{th[1]} ({th[0]})&quot; for th in brands_data]&#10;            brand_combo_edit['values'] = brand_options&#10;&#10;            # Set current brand as selected&#10;            current_brand_text = f&quot;{current_data['brand_name']} ({current_data['brand_id']})&quot;&#10;            brand_var_edit.set(current_brand_text)&#10;&#10;        except Exception as e:&#10;            messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải danh sách thương hiệu: {str(e)}&quot;)&#10;        finally:&#10;            if cursor:&#10;                cursor.close()&#10;            if conn:&#10;                conn.close()&#10;&#10;        brand_combo_edit.pack(padx=10, pady=(0, 8))&#10;&#10;        # Quantity&#10;        tk.Label(main_container, text=&quot;Số lượng:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_quantity = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_quantity.insert(0, str(current_data['quantity']))&#10;        entry_quantity.pack(padx=10, pady=(0, 8))&#10;&#10;        # Import Date (NgayNhapHang)&#10;        tk.Label(main_container, text=&quot;Ngày nhập hàng (YYYY-MM-DD):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        entry_import_date = tk.Entry(main_container, font=('Arial', 12), width=40)&#10;        entry_import_date.insert(0, current_data['import_date'])&#10;        entry_import_date.pack(padx=10, pady=(0, 8))&#10;&#10;        # Description&#10;        tk.Label(main_container, text=&quot;Mô tả:&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_description = tk.Text(main_container, font=('Arial', 11), width=42, height=5, wrap='word')&#10;        text_description.insert(1.0, current_data['description'])&#10;        text_description.pack(padx=10, pady=(0, 8))&#10;&#10;        # Colors (Available colors for this product)&#10;        tk.Label(main_container, text=&quot;Màu sắc có sẵn (mỗi màu một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_colors = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        if current_colors:&#10;            text_colors.insert(1.0, '\n'.join(current_colors))&#10;        else:&#10;            text_colors.insert(1.0, &quot;Trắng\nXanh Dương\nĐen\nNâu&quot;)  # Default colors&#10;        text_colors.pack(padx=10, pady=(0, 8))&#10;&#10;        # Sizes (Available sizes for this product)&#10;        tk.Label(main_container, text=&quot;Kích cỡ có sẵn (mỗi size một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_sizes_edit = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        if current_sizes:&#10;            text_sizes_edit.insert(1.0, '\n'.join(current_sizes))&#10;        else:&#10;            text_sizes_edit.insert(1.0, &quot;\n&quot;.join([str(i) for i in range(36, 46)]))  # Default sizes&#10;        text_sizes_edit.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image URLs&#10;        tk.Label(main_container, text=&quot;URL hình ảnh (mỗi URL một dòng):&quot;, font=('Arial', 12, 'bold')).pack(anchor='w', padx=10, pady=(5, 2))&#10;        text_images = tk.Text(main_container, font=('Arial', 11), width=42, height=3, wrap='word')&#10;        if current_images:&#10;            text_images.insert(1.0, '\n'.join(current_images))&#10;        text_images.pack(padx=10, pady=(0, 8))&#10;&#10;        # Image Upload Section&#10;        upload_frame = tk.Frame(main_container)&#10;        upload_frame.pack(fill='x', padx=10, pady=(5, 8))&#10;&#10;        tk.Label(upload_frame, text=&quot;Hoặc tải ảnh từ thiết bị:&quot;, font=('Arial', 11, 'bold')).pack(anchor='w')&#10;&#10;        # Store uploaded image filenames temporarily&#10;        uploaded_images = []&#10;&#10;        upload_btn_frame = tk.Frame(upload_frame)&#10;        upload_btn_frame.pack(anchor='w', pady=(5, 0))&#10;&#10;        def upload_image():&#10;            filetypes = [(&quot;Image files&quot;, &quot;*.png *.jpg *.jpeg *.gif *.bmp&quot;), (&quot;All files&quot;, &quot;*.*&quot;)]&#10;            file_path = filedialog.askopenfilename(parent=edit_window, title=&quot;Chọn hình ảnh&quot;, filetypes=filetypes)&#10;            if file_path:&#10;                try:&#10;                    # Save to local directory&#10;                    filename = save_uploaded_image(file_path)&#10;                    uploaded_images.append(filename)&#10;                    # Update label to show count&#10;                    upload_count_label.config(text=f&quot;Đã chọn: {len(uploaded_images)} ảnh mới&quot;, fg='#27ae60')&#10;                    messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm ảnh: {os.path.basename(file_path)}&quot;)&#10;                except Exception as e:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải ảnh: {str(e)}&quot;)&#10;&#10;        tk.Button(upload_btn_frame, text=&quot; Chọn ảnh từ máy&quot;, command=upload_image,&#10;                 bg='#3498db', fg='white', font=('Arial', 10, 'bold'),&#10;                 padx=10, pady=5, cursor='hand2').pack(side='left')&#10;&#10;        upload_count_label = tk.Label(upload_btn_frame, text=&quot;Chưa chọn ảnh mới nào&quot;,&#10;                                      font=('Arial', 10), fg='#7f8c8d')&#10;        upload_count_label.pack(side='left', padx=(10, 0))&#10;&#10;&#10;        def update_product():&#10;            # Get form data&#10;            name = entry_name.get().strip()&#10;            price_str = entry_price.get().strip()&#10;            brand_selection = brand_var_edit.get()&#10;            quantity_str = entry_quantity.get().strip()&#10;            import_date_str = entry_import_date.get().strip()&#10;            description = text_description.get(1.0, tk.END).strip()&#10;            colors = text_colors.get(1.0, tk.END).strip()&#10;            image_urls = text_images.get(1.0, tk.END).strip()&#10;&#10;            # Validation&#10;            if not all([name, price_str, brand_selection, quantity_str]):&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng nhập đầy đủ thông tin bắt buộc!&quot;)&#10;                return&#10;&#10;            try:&#10;                price = float(price_str)&#10;                if price &lt;= 0:&#10;                    raise ValueError(&quot;Giá phải lớn hơn 0&quot;)&#10;                quantity = int(quantity_str)&#10;                if quantity &lt; 0:&#10;                    raise ValueError(&quot;Số lượng phải &gt;= 0&quot;)&#10;&#10;                # Validate import date format if provided&#10;                if import_date_str:&#10;                    from datetime import datetime&#10;                    try:&#10;                        datetime.strptime(import_date_str, '%Y-%m-%d')&#10;                    except ValueError:&#10;                        raise ValueError(&quot;Ngày nhập hàng phải theo định dạng YYYY-MM-DD&quot;)&#10;            except ValueError as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Dữ liệu không hợp lệ: {str(e)}&quot;)&#10;                return&#10;&#10;            # Extract brand ID&#10;            try:&#10;                brand_id = brand_selection.split('(')[1].replace(')', '')&#10;            except:&#10;                messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng chọn thương hiệu!&quot;)&#10;                return&#10;&#10;            # Update database&#10;            conn = None&#10;            cursor = None&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Create color table if not exists&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    CREATE TABLE IF NOT EXISTS mausac_sp (&#10;                        MaSP VARCHAR(30) NOT NULL,&#10;                        MauSac VARCHAR(100) NOT NULL,&#10;                        PRIMARY KEY (MaSP, MauSac),&#10;                        FOREIGN KEY (MaSP) REFERENCES sanpham(MaSP) ON DELETE CASCADE&#10;                    )&#10;                &quot;&quot;&quot;)&#10;&#10;                # Create size table if not exists&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    CREATE TABLE IF NOT EXISTS size_sp (&#10;                        MaSP VARCHAR(30) NOT NULL,&#10;                        Size VARCHAR(20) NOT NULL,&#10;                        PRIMARY KEY (MaSP, Size),&#10;                        FOREIGN KEY (MaSP) REFERENCES sanpham(MaSP) ON DELETE CASCADE&#10;                    )&#10;                &quot;&quot;&quot;)&#10;&#10;                # Update product with import date&#10;                cursor.execute(&quot;&quot;&quot;&#10;                    UPDATE sanpham &#10;                    SET TenSP = %s, Gia = %s, MoTa = %s, MaTH = %s, SoLuong = %s, NgayNhapHang = %s&#10;                    WHERE MaSP = %s&#10;                &quot;&quot;&quot;, (name, price, description if description else None, brand_id, quantity,&#10;                      import_date_str if import_date_str else None, product_id))&#10;&#10;                # Delete old colors&#10;                cursor.execute(&quot;DELETE FROM mausac_sp WHERE MaSP = %s&quot;, (product_id,))&#10;&#10;                # Insert new colors if provided&#10;                if colors:&#10;                    color_list = [color.strip() for color in colors.split('\n') if color.strip()]&#10;                    for color in color_list:&#10;                        cursor.execute(&quot;INSERT INTO mausac_sp (MaSP, MauSac) VALUES (%s, %s)&quot;, (product_id, color))&#10;&#10;                # Delete old sizes&#10;                cursor.execute(&quot;DELETE FROM size_sp WHERE MaSP = %s&quot;, (product_id,))&#10;&#10;                # Insert new sizes if provided&#10;                sizes_edit = text_sizes_edit.get(1.0, tk.END).strip()&#10;                if sizes_edit:&#10;                    size_list = [size.strip() for size in sizes_edit.split('\n') if size.strip()]&#10;                    for size in size_list:&#10;                        cursor.execute(&quot;INSERT INTO size_sp (MaSP, Size) VALUES (%s, %s)&quot;, (product_id, size))&#10;&#10;                # Delete old images&#10;                cursor.execute(&quot;DELETE FROM url_sp WHERE MaSP = %s&quot;, (product_id,))&#10;&#10;                # Insert new image URLs if provided&#10;                if image_urls:&#10;                    urls = [url.strip() for url in image_urls.split('\n') if url.strip()]&#10;                    for url in urls:&#10;                        cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, url))&#10;&#10;                # Insert uploaded images&#10;                for filename in uploaded_images:&#10;                    cursor.execute(&quot;INSERT INTO url_sp (MaSP, URLAnh) VALUES (%s, %s)&quot;, (product_id, filename))&#10;&#10;                conn.commit()&#10;                total_images = len([url.strip() for url in image_urls.split('\n') if url.strip()]) + len(uploaded_images)&#10;                total_colors = len([color.strip() for color in colors.split('\n') if color.strip()])&#10;                total_sizes = len([size.strip() for size in sizes_edit.split('\n') if size.strip()])&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã cập nhật sản phẩm '{name}' với {total_colors} màu, {total_sizes} size và {total_images} ảnh thành công!&quot;)&#10;                edit_window.destroy()&#10;&#10;                # Refresh the product list&#10;                self.show_shoes(role, username)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể cập nhật sản phẩm: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Action buttons with proper colors and positions&#10;        tk.Button(button_frame, text=&quot;✏️ Cập nhật&quot;, command=update_product,&#10;                 bg='#f39c12', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='left', padx=15, pady=10)&#10;        tk.Button(button_frame, text=&quot;❌ Hủy&quot;, command=on_closing,&#10;                 bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                 padx=30, pady=10, cursor='hand2').pack(side='right', padx=15, pady=10)&#10;&#10;    def show_brand_management(self, role, username):&#10;        &quot;&quot;&quot;Show brand management interface for sellers&quot;&quot;&quot;&#10;        # Create brand management window&#10;        brand_window = tk.Toplevel(self.root)&#10;        brand_window.title(&quot;Quản lý thương hiệu&quot;)&#10;        brand_window.geometry(&quot;600x500&quot;)&#10;        brand_window.resizable(False, False)&#10;&#10;        # Center the window&#10;        brand_window.update_idletasks()&#10;        x = (brand_window.winfo_screenwidth() // 2) - (600 // 2)&#10;        y = (brand_window.winfo_screenheight() // 2) - (500 // 2)&#10;        brand_window.geometry(f&quot;+{x}+{y}&quot;)&#10;&#10;        # Make sure it's on top&#10;        brand_window.transient(self.root)&#10;        brand_window.grab_set()  # Make window modal&#10;        brand_window.lift()  # Raise to top&#10;        brand_window.focus_force()  # Force focus&#10;&#10;        # Header&#10;        header_frame = tk.Frame(brand_window, bg='#9b59b6', height=60)&#10;        header_frame.pack(fill='x')&#10;        header_frame.pack_propagate(False)&#10;&#10;        tk.Label(header_frame, text=&quot;QUẢN LÝ THƯƠNG HIỆU&quot;, font=('Arial', 18, 'bold'),&#10;                 fg='white', bg='#9b59b6').pack(pady=15)&#10;&#10;        # Main content frame&#10;        main_frame = tk.Frame(brand_window)&#10;        main_frame.pack(fill='both', expand=True, padx=15, pady=10)&#10;&#10;        # Brand list frame&#10;        list_frame = tk.Frame(main_frame)&#10;        list_frame.pack(fill='both', expand=True, pady=(0, 10))&#10;&#10;        tk.Label(list_frame, text=&quot;Danh sách thương hiệu:&quot;, font=('Arial', 14, 'bold')).pack(anchor='w', pady=(0, 10))&#10;&#10;        # Treeview for brands&#10;        tree_frame = tk.Frame(list_frame)&#10;        tree_frame.pack(fill='both', expand=True)&#10;&#10;        # Configure style&#10;        style = ttk.Style()&#10;        style.configure(&quot;Brand.Treeview&quot;, font=('Arial', 12))&#10;        style.configure(&quot;Brand.Treeview.Heading&quot;, font=('Arial', 13, 'bold'))&#10;&#10;        brand_tree = ttk.Treeview(tree_frame, columns=(&quot;Mã TH&quot;, &quot;Tên thương hiệu&quot;), show=&quot;headings&quot;,&#10;                                 height=12, style=&quot;Brand.Treeview&quot;)&#10;        brand_tree.heading(&quot;Mã TH&quot;, text=&quot;Mã thương hiệu&quot;)&#10;        brand_tree.heading(&quot;Tên thương hiệu&quot;, text=&quot;Tên thương hiệu&quot;)&#10;        brand_tree.column(&quot;Mã TH&quot;, width=150, anchor='center')&#10;        brand_tree.column(&quot;Tên thương hiệu&quot;, width=300, anchor='w')&#10;&#10;        scrollbar_brand = ttk.Scrollbar(tree_frame, orient=&quot;vertical&quot;, command=brand_tree.yview)&#10;        brand_tree.configure(yscrollcommand=scrollbar_brand.set)&#10;&#10;        brand_tree.pack(side=&quot;left&quot;, fill=&quot;both&quot;, expand=True)&#10;        scrollbar_brand.pack(side=&quot;right&quot;, fill=&quot;y&quot;)&#10;&#10;        # Buttons frame&#10;        button_frame = tk.Frame(main_frame)&#10;        button_frame.pack(fill='x', pady=(10, 0))&#10;&#10;        # First row: Delete and Add buttons&#10;        buttons_row1 = tk.Frame(button_frame)&#10;        buttons_row1.pack(fill='x', pady=(0, 5))&#10;&#10;        btn_delete_brand = tk.Button(buttons_row1, text=&quot;️ Xóa thương hiệu&quot;,&#10;                                    bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                                    padx=15, pady=8, relief='raised', state='disabled',&#10;                                    cursor='hand2', bd=2)&#10;        btn_delete_brand.pack(side='left')&#10;&#10;        btn_add_brand = tk.Button(buttons_row1, text=&quot;➕ Thêm thương hiệu&quot;,&#10;                                 bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                                 padx=15, pady=8, relief='raised',&#10;                                 cursor='hand2', bd=2)&#10;        btn_add_brand.pack(side='right')&#10;        # Add hover effect&#10;        add_button_hover_effect(btn_add_brand, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;        # Status label&#10;        status_brand_label = tk.Label(button_frame, text=&quot;Chọn thương hiệu để xóa&quot;,&#10;                                     font=('Arial', 10), fg='#7f8c8d')&#10;        status_brand_label.pack(pady=(5, 0))&#10;&#10;        # Load brand data&#10;        def load_brands():&#10;            # Clear current items&#10;            for item in brand_tree.get_children():&#10;                brand_tree.delete(item)&#10;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;                cursor.execute(&quot;SELECT MaTH, TenTH FROM thuonghieu ORDER BY TenTH&quot;)&#10;                brands = cursor.fetchall()&#10;&#10;                for ma_th, ten_th in brands:&#10;                    brand_tree.insert(&quot;&quot;, &quot;end&quot;, iid=ma_th, values=(ma_th, ten_th))&#10;&#10;                status_brand_label.config(text=f&quot;Tổng số thương hiệu: {len(brands)}&quot;)&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể tải danh sách thương hiệu: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Brand selection handler&#10;        selected_brand_id = None&#10;&#10;        def on_brand_select(event):&#10;            nonlocal selected_brand_id&#10;            selection = brand_tree.selection()&#10;&#10;            if selection:&#10;                selected_brand_id = selection[0]&#10;                btn_delete_brand.config(state='normal', bg='#e74c3c')&#10;                add_button_hover_effect(btn_delete_brand, '#e74c3c', get_hover_color('#e74c3c'))&#10;                status_brand_label.config(text=&quot;Click để xóa thương hiệu đã chọn&quot;, fg='red')&#10;            else:&#10;                selected_brand_id = None&#10;                btn_delete_brand.config(state='disabled', bg='#95a5a6')&#10;                status_brand_label.config(text=&quot;Chọn thương hiệu để xóa&quot;, fg='#7f8c8d')&#10;&#10;        brand_tree.bind(&quot;&lt;&lt;TreeviewSelect&gt;&gt;&quot;, on_brand_select)&#10;&#10;        # Delete brand function&#10;        def delete_brand():&#10;            if not selected_brand_id:&#10;                return&#10;&#10;            # Get brand name for confirmation&#10;            selected_item = brand_tree.item(selected_brand_id)&#10;            brand_name = selected_item['values'][1]&#10;&#10;            result = messagebox.askyesno(&quot;Xác nhận&quot;,&#10;                                       f&quot;Bạn có chắc chắn muốn xóa thương hiệu '{brand_name}' không?\n\n&quot;&#10;                                       f&quot;Lưu ý: Tất cả sản phẩm của thương hiệu này cũng sẽ bị xóa!&quot;)&#10;            if not result:&#10;                return&#10;&#10;            try:&#10;                conn = get_db_connection()&#10;                cursor = conn.cursor()&#10;&#10;                # Delete products of this brand first&#10;                cursor.execute(&quot;DELETE FROM url_sp WHERE MaSP IN (SELECT MaSP FROM sanpham WHERE MaTH = %s)&quot;, (selected_brand_id,))&#10;                cursor.execute(&quot;DELETE FROM sanpham WHERE MaTH = %s&quot;, (selected_brand_id,))&#10;&#10;                # Delete brand&#10;                cursor.execute(&quot;DELETE FROM thuonghieu WHERE MaTH = %s&quot;, (selected_brand_id,))&#10;&#10;                conn.commit()&#10;                messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã xóa thương hiệu '{brand_name}' thành công!&quot;)&#10;&#10;                # Refresh brand list in this window&#10;                load_brands()&#10;&#10;                # Refresh the product view's brand filter&#10;                self.refresh_brand_filter()&#10;&#10;            except Exception as e:&#10;                messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể xóa thương hiệu: {str(e)}&quot;)&#10;            finally:&#10;                if cursor:&#10;                    cursor.close()&#10;                if conn:&#10;                    conn.close()&#10;&#10;        # Add brand function&#10;        def add_brand():&#10;            # Create add brand dialog - INCREASED HEIGHT for buttons visibility&#10;            add_brand_window = tk.Toplevel(brand_window)&#10;            add_brand_window.title(&quot;Thêm thương hiệu mới&quot;)&#10;            add_brand_window.geometry(&quot;520x300&quot;)  # Increased to 520x300 - MORE SPACE!&#10;            add_brand_window.resizable(False, False)&#10;&#10;            # Center the dialog&#10;            add_brand_window.update_idletasks()&#10;            x = (add_brand_window.winfo_screenwidth() // 2) - (520 // 2)&#10;            y = (add_brand_window.winfo_screenheight() // 2) - (300 // 2)&#10;            add_brand_window.geometry(f&quot;+{x}+{y}&quot;)&#10;&#10;            # Make sure it's on top&#10;            add_brand_window.transient(brand_window)&#10;            add_brand_window.grab_set()&#10;            add_brand_window.lift()&#10;            add_brand_window.focus_force()&#10;&#10;            # MAIN CONTAINER with fixed structure&#10;            main_container = tk.Frame(add_brand_window, bg='white')&#10;            main_container.pack(fill='both', expand=True)&#10;&#10;            # TOP SECTION - Form content (NOT EXPANDABLE)&#10;            top_section = tk.Frame(main_container, bg='white')&#10;            top_section.pack(side='top', fill='x', padx=30, pady=(20, 10))&#10;&#10;            tk.Label(top_section, text=&quot;THÊM THƯƠNG HIỆU MỚI&quot;, font=('Arial', 14, 'bold'),&#10;                     fg='#27ae60', bg='white').pack(pady=(0, 15))&#10;&#10;            tk.Label(top_section, text=&quot;Tên thương hiệu:&quot;, font=('Arial', 12, 'bold'),&#10;                    bg='white').pack(anchor='w', pady=(0, 5))&#10;            entry_brand_name = tk.Entry(top_section, font=('Arial', 12), width=42)&#10;            entry_brand_name.pack(pady=(0, 10), fill='x')&#10;            entry_brand_name.focus()&#10;&#10;            # MIDDLE SPACER - Expandable to push buttons down&#10;            spacer = tk.Frame(main_container, bg='white')&#10;            spacer.pack(side='top', fill='both', expand=True)&#10;&#10;            # BOTTOM SECTION - Buttons (ALWAYS AT BOTTOM)&#10;            # Use fixed height and pack_propagate(False) to ensure buttons always visible&#10;            button_frame_add = tk.Frame(main_container, bg='white', height=70)&#10;            button_frame_add.pack(side='bottom', fill='x', padx=30, pady=(10, 20))&#10;            button_frame_add.pack_propagate(False)  # CRITICAL: Prevent shrinking!&#10;&#10;            # Create inner container for buttons with padding&#10;            buttons_container = tk.Frame(button_frame_add, bg='white')&#10;            buttons_container.pack(fill='both', expand=True, pady=10)&#10;&#10;            def save_brand():&#10;                brand_name = entry_brand_name.get().strip()&#10;                if not brand_name:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, &quot;Vui lòng nhập tên thương hiệu!&quot;)&#10;                    return&#10;&#10;                try:&#10;                    conn = get_db_connection()&#10;                    cursor = conn.cursor()&#10;&#10;                    # Check if brand already exists&#10;                    cursor.execute(&quot;SELECT MaTH FROM thuonghieu WHERE TenTH = %s&quot;, (brand_name,))&#10;                    if cursor.fetchone():&#10;                        messagebox.showerror(&quot;Lỗi&quot;, f&quot;Thương hiệu '{brand_name}' đã tồn tại!&quot;)&#10;                        return&#10;&#10;                    # Generate new brand ID&#10;                    cursor.execute(&quot;SELECT MAX(CAST(SUBSTRING(MaTH, 3) AS UNSIGNED)) FROM thuonghieu WHERE MaTH LIKE 'TH%'&quot;)&#10;                    result = cursor.fetchone()&#10;                    next_number = ((result[0] or 0) + 1) if result and result[0] is not None else 1&#10;                    brand_id = f&quot;TH{next_number:03d}&quot;&#10;&#10;                    # Insert brand&#10;                    cursor.execute(&quot;INSERT INTO thuonghieu (MaTH, TenTH) VALUES (%s, %s)&quot;, (brand_id, brand_name))&#10;                    conn.commit()&#10;&#10;                    messagebox.showinfo(&quot;Thành công&quot;, f&quot;Đã thêm thương hiệu '{brand_name}' thành công!&quot;)&#10;                    add_brand_window.destroy()&#10;&#10;                    # Refresh brand list in this window&#10;                    load_brands()&#10;&#10;                    # Refresh the product view's brand filter&#10;                    self.refresh_brand_filter()&#10;&#10;                except Exception as e:&#10;                    messagebox.showerror(&quot;Lỗi&quot;, f&quot;Không thể thêm thương hiệu: {str(e)}&quot;)&#10;                finally:&#10;                    if cursor:&#10;                        cursor.close()&#10;                    if conn:&#10;                        conn.close()&#10;&#10;            # Save and Cancel buttons with hover effects&#10;            # Pack into buttons_container (not button_frame_add directly)&#10;            btn_save_brand = tk.Button(buttons_container, text=&quot; Lưu&quot;, command=save_brand,&#10;                                      bg='#27ae60', fg='white', font=('Arial', 12, 'bold'),&#10;                                      padx=25, pady=8, cursor='hand2', relief='raised', bd=2)&#10;            btn_save_brand.pack(side='left', padx=5)&#10;            add_button_hover_effect(btn_save_brand, '#27ae60', get_hover_color('#27ae60'))&#10;&#10;            btn_cancel_brand = tk.Button(buttons_container, text=&quot;❌ Hủy&quot;, command=add_brand_window.destroy,&#10;                                        bg='#e74c3c', fg='white', font=('Arial', 12, 'bold'),&#10;                                        padx=25, pady=8, cursor='hand2', relief='raised', bd=2)&#10;            btn_cancel_brand.pack(side='left', padx=5)&#10;            add_button_hover_effect(btn_cancel_brand, '#e74c3c', get_hover_color('#e74c3c'))&#10;&#10;            # Enter key to save&#10;            entry_brand_name.bind('&lt;Return&gt;', lambda e: save_brand())&#10;&#10;        # Bind button functions&#10;        btn_delete_brand.config(command=delete_brand)&#10;        btn_add_brand.config(command=add_brand)&#10;&#10;        # Load initial data&#10;        load_brands()&#10;&#10;    def set_show_cart_callback(self, callback):&#10;        &quot;&quot;&quot;Set callback for showing cart&quot;&quot;&quot;&#10;        self.show_cart_callback = callback&#10;&#10;    def set_show_invoice_history_callback(self, callback):&#10;        &quot;&quot;&quot;Set callback for showing invoice history&quot;&quot;&quot;&#10;        self.show_invoice_history = callback&#10;&#10;    def set_logout_callback(self, callback):&#10;        &quot;&quot;&quot;Set logout callback&quot;&quot;&quot;&#10;        self.logout_callback = callback&#10;&#10;def load_thumbnail_image(path_or_url):&#10;    &quot;&quot;&quot;Load thumbnail image 70x70 - from main.py&quot;&quot;&quot;&#10;    source = (path_or_url or &quot;&quot;).strip()&#10;    if not source:&#10;        return None&#10;&#10;    image = None&#10;    try:&#10;        if source.lower().startswith((&quot;http://&quot;, &quot;https://&quot;)):&#10;            headers = {&#10;                'User-Agent': 'Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36'&#10;            }&#10;            req = urllib.request.Request(source, headers=headers)&#10;            with urllib.request.urlopen(req, timeout=10) as response:&#10;                if response.getcode() != 200:&#10;                    return None&#10;                raw_data = response.read()&#10;            with Image.open(io.BytesIO(raw_data)) as img:&#10;                image = img.copy()&#10;        else:&#10;            candidate_paths = []&#10;            if os.path.isabs(source):&#10;                candidate_paths.append(source)&#10;            else:&#10;                candidate_paths.append(os.path.join(LOCAL_IMAGE_DIR, source))&#10;                candidate_paths.append(os.path.join(BASE_DIR, source))&#10;&#10;            for file_path in candidate_paths:&#10;                if os.path.isfile(file_path):&#10;                    with Image.open(file_path) as img:&#10;                        image = img.copy()&#10;                    break&#10;&#10;            if image is None:&#10;                return None&#10;&#10;        if image.mode in ('RGBA', 'P'):&#10;            image = image.convert('RGB')&#10;&#10;        # Resize to thumbnail size&#10;        image = image.resize((70, 70), Image.Resampling.LANCZOS)&#10;        return ImageTk.PhotoImage(image)&#10;&#10;    except Exception as e:&#10;        print(f&quot;Error loading thumbnail from {source}: {e}&quot;)&#10;        return None&#10;" />
            </PendingDiffInfo>
          </value>
        </entry>
      </map>
    </option>
  </component>
</project>